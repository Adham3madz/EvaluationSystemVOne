{% extends "layout.html" %}
{% block title %}ุฅุฏุงุฑุฉ ุงูุฌูุณุฉ ุงูุชุฏุฑูุจูุฉ{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1 text-light">๐ {{ training_session.TrainingCourseText }}</h4>
            <span class="text-white">
                {{ training_session.SessionDate }}
                {% if training_session.EndDate %} - {{ training_session.EndDate }} {% endif %}
            </span>
        </div>
        <div>
            <a class="btn btn-secondary me-2"
                href="{{ url_for('training_session_print', sid=training_session.SessionID) }}" target="_blank">๐จ๏ธ
                ุทุจุงุนุฉ</a>
            <a class="btn btn-primary" href="{{ url_for('training_enroll', sid=training_session.SessionID) }}">โ ุชุณุฌูู
                ุทูุงุจ</a>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule"
                type="button">
                ๐ ุงูุฌุฏูู (ุงูุฃูุงู)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance"
                type="button">
                โ ุงูุญุถูุฑ ูุงูุบูุงุจ
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="grading-tab" data-bs-toggle="tab" data-bs-target="#grading"
                type="button">
                ๐ ุงูุฏุฑุฌุงุช ูุงููุชูุฌุฉ
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">

        <!-- ==================== ุฌุฏูู ุงูุฃูุงู ==================== -->
        <div class="tab-pane fade show active" id="schedule">
            <div class="card shadow-sm p-4">
                <h5 class="fw-bold text-primary mb-3">๐๏ธ ุฅุฏุงุฑุฉ ุงูุฃูุงู ูุงูุฃููุงุช</h5>

                <form method="POST" action="{{ url_for('training_day_add', sid=training_session.SessionID) }}"
                    class="row g-3 align-items-end mb-5 bg-light p-3 rounded border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">ุงูุชุงุฑูุฎ</label>
                        <input type="date" name="day_date" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">ูู</label>
                        <input type="time" name="start_time" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">ุฅูู</label>
                        <input type="time" name="end_time" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">ุงูููุถูุน (Topic)</label>
                        <input type="text" name="topic" class="form-control" placeholder="ูุซุงู: ููุฏูุฉ">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-success w-100 fw-bold">โ ุฅุถุงูุฉ</button>
                    </div>
                </form>

                <h5 class="fw-bold text-dark mb-3">๐ ุงูุฃูุงู ุงููุฌุฏููุฉ</h5>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ุงูุชูููุช</th>
                                <th>ุงูููุถูุน</th>
                                <th class="text-center">ุฅุฌุฑุงุก</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in session_days %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td class="fw-bold">{{ day.DayDate }}</td>
                                <td class="text-muted small">
                                    {% if day.StartTime %}{{ day.StartTime }}{% endif %}
                                    {% if day.EndTime %} - {{ day.EndTime }}{% endif %}
                                </td>
                                <td>{{ day.Topic or '-' }}</td>
                                <td class="text-center">
                                    <!-- ุฒุฑ ุญุฐู ููู ูุน ุชุฃููุฏ Modal ุขูู -->
                                    <button type="button" class="btn btn-sm btn-outline-danger border-0"
                                        data-bs-toggle="modal" data-bs-target="#deleteDayModal{{ day.DayID }}">
                                        ๐๏ธ
                                    </button>

                                    <!-- Modal ุชุฃููุฏ ุญุฐู ุงูููู -->
                                    <div class="modal fade" id="deleteDayModal{{ day.DayID }}" tabindex="-1"
                                        aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">ุชุฃููุฏ ุญุฐู ุงูููู</h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body text-center py-4">
                                                    <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููููุ</p>
                                                    <p class="fw-bold">{{ day.DayDate }} {% if day.Topic %} - {{
                                                        day.Topic }}{% endif %}</p>
                                                    <p class="text-muted small">ุณูุชู ุญุฐู ุฌููุน ุจูุงูุงุช ุงูุญุถูุฑ ููุฐุง ุงูููู
                                                        ููุงุฆููุง.</p>
                                                </div>
                                                <div class="modal-footer justify-content-center">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">ุฅูุบุงุก</button>
                                                    <form method="POST"
                                                        action="{{ url_for('training_day_delete', did=day.DayID) }}"
                                                        class="d-inline">
                                                        <button type="submit" class="btn btn-danger">ูุนูุ ุงุญุฐู</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-5">ูู ูุชู ุฅุถุงูุฉ ุฃู ุฃูุงู ููุฌุฏูู ุจุนุฏ.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ==================== ุชุจููุจ ุงูุญุถูุฑ ==================== -->
        <div class="tab-pane fade" id="attendance">
            <div class="card shadow-sm p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-success mb-0">๐ ุชุณุฌูู ุงูุญุถูุฑ ุงููููู</h5>
                    <button form="attendanceForm" class="btn btn-success fw-bold">๐พ ุญูุธ ุงูุญุถูุฑ</button>
                </div>

                {% if session_days and enrollments %}
                <form id="attendanceForm" method="POST"
                    action="{{ url_for('training_attendance_save', sid=training_session.SessionID) }}">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th style="position: sticky; left: 0; background: #343a40; z-index: 10;">ุงูููุธู</th>
                                    {% for day in session_days %}
                                    <th>
                                        <div class="small fw-bold">{{ day.DayDate }}</div>
                                        {% if day.Topic %}<small class="text-light">{{ day.Topic }}</small>{% endif %}
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in enrollments %}
                                <tr>
                                    <td class="bg-light fw-bold text-start ps-3"
                                        style="position: sticky; left: 0; z-index: 5;">{{ emp.NAME }}</td>
                                    {% for day in session_days %}
                                    <td>
                                        <input type="checkbox" name="attend_{{ day.DayID }}_{{ emp.EnrollmentID }}"
                                            class="form-check-input" style="width: 22px; height: 22px; cursor: pointer;"
                                            {% if (day.DayID, emp.EnrollmentID) in attendance_set %}checked{% endif %}>
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% else %}
                <div class="alert alert-warning text-center">
                    โ๏ธ ูุฑุฌู <strong>ุฅุถุงูุฉ ุฃูุงู ููุฌุฏูู</strong> ู <strong>ุชุณุฌูู ุทูุงุจ</strong> ุฃููุงู ูุชูุนูู ูุดู ุงูุญุถูุฑ.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ==================== ุชุจููุจ ุงูุฏุฑุฌุงุช ==================== -->
        <div class="tab-pane fade" id="grading">
            <div class="card shadow-sm p-4">

                <form id="bulkUpdateForm" method="POST"
                    action="{{ url_for('training_session_bulk_update_grades', sid=training_session.SessionID) }}">
                </form>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">๐ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ</h5>
                    <button type="submit" form="bulkUpdateForm" class="btn btn-primary fw-bold">
                        ๐พ ุญูุธ ุงููู (Save All)
                    </button>
                </div>

                {% if enrollments %}
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-secondary">
                            <tr>
                                <th style="width: 25%;">ุงูููุธู</th>
                                <th style="width: 15%;">ุงูุฏุฑุฌุฉ</th>
                                <th style="width: 20%;">ุงููุชูุฌุฉ</th>
                                <th>ูุณุจุฉ ุงูุญุถูุฑ</th>
                                <th>ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in enrollments %}
                            <tr>
                                <td class="fw-bold text-start ps-3">{{ e.NAME }}</td>

                                <td>
                                    <input type="number" name="grade_{{ e.EnrollmentID }}" form="bulkUpdateForm"
                                        class="form-control text-center" placeholder="0-100" value="{{ e.Grade or '' }}"
                                        min="0" max="100">
                                </td>

                                <td>
                                    <select name="pass_status_{{ e.EnrollmentID }}" form="bulkUpdateForm"
                                        class="form-select">
                                        <option value="">---</option>
                                        <option value="Passed" {% if e.PassStatus=='Passed' %}selected{% endif %}>ูุงุฌุญ
                                        </option>
                                        <option value="Failed" {% if e.PassStatus=='Failed' %}selected{% endif %}>ุฑุงุณุจ
                                        </option>
                                        <option value="Excuse" {% if e.PassStatus=='Excuse' %}selected{% endif %}>ุงุนุชุฐุงุฑ
                                        </option>
                                        <option value="Canceled" {% if e.PassStatus=='Canceled' %}selected{% endif %}>
                                            ููุบู</option>
                                    </select>
                                </td>

                                <td>
                                    {% if (e.AttendancePercent or 0) >= 75 %}
                                    <span class="badge bg-success">{{ e.AttendancePercent|default('0') }}%</span>
                                    {% elif (e.AttendancePercent or 0) >= 50 %}
                                    <span class="badge bg-warning text-dark">{{ e.AttendancePercent|default('0')
                                        }}%</span>
                                    {% else %}
                                    <span class="badge bg-danger">{{ e.AttendancePercent|default('0') }}%</span>
                                    {% endif %}
                                </td>

                                <td>
                                    <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
                                        data-bs-target="#cancelEnrollmentModal{{ e.EnrollmentID }}">
                                        ๐ซ ุฅูุบุงุก
                                    </button>

                                    <div class="modal fade" id="cancelEnrollmentModal{{ e.EnrollmentID }}"
                                        tabindex="-1">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title">ุชุฃููุฏ ุฅูุบุงุก ุงูุชุณุฌูู</h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                        data-bs-dismiss="modal"></button>
                                                </div>
                                                <div class="modal-body text-center py-4">
                                                    <p>ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุบุงุก ุชุณุฌูู <strong>{{ e.NAME }}</strong>ุ</p>
                                                </div>
                                                <div class="modal-footer justify-content-center">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">ุชุฑุงุฌุน</button>
                                                    <form method="POST"
                                                        action="{{ url_for('training_enrollment_cancel', eid=e.EnrollmentID) }}">
                                                        <button type="submit" class="btn btn-danger">ูุนูุ ุฃูุบู
                                                            ุงูุชุณุฌูู</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info text-center py-4">
                    ูุง ููุฌุฏ ุทูุงุจ ูุณุฌููู ูู ูุฐู ุงูุฌูุณุฉ ุญุงูููุง.
                </div>
                {% endif %}
            </div>
        </div>

    </div>
</div>
{% endblock %}