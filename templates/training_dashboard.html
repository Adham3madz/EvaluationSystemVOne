{% extends "layout.html" %}
{% block title %}Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¨{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
    /* === Glassmorphism & Modern UI Theme === */
    :root {
        --glass-bg: rgba(255, 255, 255, 0.92);
        --glass-border: 1px solid rgba(255, 255, 255, 0.5);
        --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --primary-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        --card-radius: 16px;
    }

    /* === Header === */
    .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
    }

    .dashboard-title {
        color: white;
        font-weight: 800;
        font-size: 2.5rem;
        text-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    .dashboard-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    /* === Glass Card === */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: var(--glass-border);
        border-radius: var(--card-radius);
        box-shadow: var(--glass-shadow);
        padding: 25px;
        transition: transform 0.3s ease;
        margin-bottom: 25px;
    }

    .glass-card:hover {
        /* Slight lift on hover */
        transform: translateY(-3px);
    }

    /* === KPI Stats === */
    .kpi-box {
        text-align: center;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .kpi-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }

    .kpi-number {
        font-size: 2rem;
        font-weight: 900;
        color: #2c3e50;
        line-height: 1;
    }

    .kpi-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #636e72;
        text-transform: uppercase;
    }

    /* === Action Buttons === */
    .btn-morphism {
        background: linear-gradient(135deg, #e0e0e0, #ffffff);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 50px;
        padding: 12px 30px;
        color: #333;
        font-weight: bold;
        box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.1), -5px -5px 10px rgba(255, 255, 255, 0.8);
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-morphism:hover {
        transform: scale(1.05);
        color: #000;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-primary-soft {
        background: #e3f2fd;
        color: #0d47a1;
        border: none;
    }

    /* === Search Bar === */
    .search-glass {
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 50px;
        padding: 15px 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: 100%;
        transition: 0.3s;
    }

    .search-glass:focus {
        background: white;
        box-shadow: 0 4px 20px rgba(13, 110, 253, 0.25);
        outline: none;
    }

    /* === Session Card === */
    .session-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        transition: 0.3s;
        height: 100%;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .session-status-bar {
        height: 6px;
        width: 100%;
    }

    .bar-green {
        background: #2ecc71;
    }

    .bar-red {
        background: #e74c3c;
    }

    .session-body {
        padding: 20px;
        flex-grow: 1;
    }

    .session-title {
        font-weight: 800;
        font-size: 1.1rem;
        color: #34495e;
        margin-bottom: 10px;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        color: #555;
        font-size: 0.9rem;
    }

    .session-footer {
        padding: 15px;
        background: #f8f9fa;
        border-top: 1px solid #eee;
    }

    /* Helpers */
    .text-shadow-sm {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
</style>

<div class="container-fluid py-4">

    <!-- Header Section -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">ğŸ“ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h1>
        <p class="dashboard-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§ØªØŒ Ø§Ù„ØªÙˆØµÙŠØ§ØªØŒ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</p>

        <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="{{ url_for('training_session_add') }}" class="btn-morphism">
                â• Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©
            </a>
            <a href="{{ url_for('training_history_add') }}" class="btn-morphism">
                ğŸ“œ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø³Ø§Ø¨Ù‚
            </a>
        </div>
    </div>

    <!-- Analytics & Stats (Offline Chart.js) -->
    <div class="row g-4 mb-5">
        <!-- KPI Cards -->
        <div class="col-md-5">
            <div class="glass-card h-100 d-flex flex-column justify-content-center">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="kpi-box">
                            <span class="kpi-icon">ğŸ“…</span>
                            <div class="kpi-number" id="statTotalSessions">0</div>
                            <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ù„Ø³Ø§Øª</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="kpi-box">
                            <span class="kpi-icon">ğŸ‘¥</span>
                            <div class="kpi-number" id="statTotalEnroll">0</div>
                            <div class="kpi-label">Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="kpi-box">
                            <span class="kpi-icon">â³</span>
                            <div class="kpi-number" id="statPending">0</div>
                            <div class="kpi-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="kpi-box">
                            <span class="kpi-icon">âœ…</span>
                            <div class="kpi-number text-success" id="statPassed">0%</div>
                            <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="col-md-7">
            <div class="glass-card h-100">
                <h5 class="fw-bold mb-3">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø´Ù‡Ø±ÙŠØ§Ù‹)</h5>
                <div style="height: 250px;">
                    <canvas id="trainingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 1. Pending Recommendations Section -->
    {% if recommendations %}
    <div class="glass-card mb-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold m-0"><span class="me-2">ğŸ“‹</span> ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Waiting List)</h4>
            <span class="badge bg-warning text-dark fs-6">{{ recommendations|length }} ØªÙˆØµÙŠØ©</span>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ğŸ‘¤ Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>ğŸ“ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
                        <th>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØµÙŠØ©</th>
                        <th>Ø·Ø§Ù„ÙØ¨ Ø§Ù„ØªÙˆØµÙŠØ©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rec in recommendations %}
                    <tr class="rec-row">
                        <td class="fw-bold text-primary">{{ rec.EmployeeName }}</td>
                        <td class="fw-bold">{{ rec.CourseName }}</td>
                        <td>{{ rec.EvaluationDate.strftime('%Y-%m-%d') }}</td>
                        <td class="small text-muted">{{ rec.ManagerName }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary-soft rounded-pill fw-bold px-3"
                                onclick="filterSessionsForCourse('{{ rec.CourseName }}')">
                                ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù„Ø³Ø©
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <p class="text-muted small mt-2 mb-0">ğŸ’¡ Ø§Ø¶ØºØ· "Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù„Ø³Ø©" Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù.</p>
    </div>
    {% endif %}

    <!-- 2. Filters Bar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-white mb-0 text-shadow-sm">ğŸ—‚ï¸ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©</h3>

        <div class="d-flex gap-2" style="width: 50%;">
            <input type="text" id="sessionSearch" class="search-glass"
                placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©ØŒ Ø§Ù„Ù…Ø¯Ø±Ø¨ØŒ Ø£Ùˆ Ø§Ù„Ù…ÙƒØ§Ù†...">
            <select id="statusFilter" class="form-select search-glass w-auto" style="border-radius: 50px;">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="open">ğŸ”“ Ù…ØªØ§Ø­</option>
                <option value="full">ğŸ”’ Ù…Ù…ØªÙ„Ø¦</option>
            </select>
        </div>
    </div>

    <!-- 3. Sessions Grid -->
    <div class="row g-4" id="sessionsContainer">
        {% for s in sessions %}
        <div class="col-md-4 col-lg-3 session-item" data-name="{{ s.TrainingCourseText }}"
            data-trainer="{{ s.InstructorName or s.ExternalTrainerName }}"
            data-status="{{ 'full' if s.EnrolledCount >= (s.MaxSeats or 100) else 'open' }}"
            data-date="{{ s.SessionDate }}">

            <div class="session-card shadow-sm h-100">
                <!-- Status Strip -->
                <div
                    class="session-status-bar {{ 'bar-red' if s.EnrolledCount >= (s.MaxSeats or 100) else 'bar-green' }}">
                </div>

                <div class="session-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-light text-dark border">#{{ s.SessionID }}</span>
                        {% if s.EnrolledCount >= (s.MaxSeats or 100) %}
                        <span class="badge bg-danger">ğŸ”’ Ù…Ù…ØªÙ„Ø¦</span>
                        {% else %}
                        <span class="badge bg-success">ğŸ”“ Ù…ØªØ§Ø­</span>
                        {% endif %}
                    </div>

                    <h5 class="session-title">{{ s.TrainingCourseText }}</h5>

                    <div class="mt-auto">
                        <div class="info-row">
                            <span>ğŸ“…</span> <span>{{ s.SessionDate }}</span>
                        </div>
                        <div class="info-row">
                            <span>ğŸ‘¨â€ğŸ«</span> <span>{{ s.InstructorName or s.ExternalTrainerName or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
                                }}</span>
                        </div>
                        <div class="info-row">
                            <span>ğŸ“</span> <span>{{ s.Location or 'Online' }}</span>
                        </div>
                        <div class="info-row">
                            <span>ğŸ‘¥</span>
                            <span>
                                <strong>{{ s.EnrolledCount }}</strong> / {{ s.MaxSeats or 'âˆ' }} Ù…Ø³Ø¬Ù„
                            </span>
                        </div>
                    </div>
                </div>

                <div class="session-footer">
                    <a href="{{ url_for('training_session_detail', sid=s.SessionID) }}"
                        class="btn btn-primary w-100 rounded-pill fw-bold">
                        âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©
                    </a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="glass-card d-inline-block px-5">
                <div style="font-size: 60px;">ğŸ“­</div>
                <h3 class="mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù„Ø³Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ø¯ÙˆÙ„Ø© Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø²Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰.</p>
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<!-- Scripts for Interaction & Analytics -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Calculate Analytics from DOM ---
        const sessions = document.querySelectorAll('.session-item');
        const sessionCount = sessions.length;

        let totalEnroll = 0;
        let months = {};

        sessions.forEach(card => {
            // Extract Enrollment Count (Dirty parsing from text, but works offline w/o backend logic)
            // Text: "5 / 20" -> extract 5
            const enrollText = card.querySelector('.info-row:last-child strong').innerText;
            totalEnroll += parseInt(enrollText) || 0;

            // Extract Month for Chart
            const dateStr = card.getAttribute('data-date'); // YYYY-MM-DD
            if (dateStr) {
                const month = dateStr.substring(0, 7); // YYYY-MM
                months[month] = (months[month] || 0) + 1;
            }
        });

        // Pending Count
        const pendingRows = document.querySelectorAll('.rec-row');
        const pendingCount = pendingRows.length;

        // Update UI stats
        document.getElementById('statTotalSessions').innerText = sessionCount;
        document.getElementById('statTotalEnroll').innerText = totalEnroll;
        document.getElementById('statPending').innerText = pendingCount;

        // --- 2. Render Chart (Chart.js) ---
        const ctx = document.getElementById('trainingChart').getContext('2d');

        // Sort months
        const labels = Object.keys(months).sort();
        const data = labels.map(m => months[m]);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù„Ø³Ø§Øª',
                    data: data,
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#0d6efd',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });

        // --- 3. Filter Logic ---
        const searchInput = document.getElementById('sessionSearch');
        const statusFilter = document.getElementById('statusFilter');

        function filterGrid() {
            const query = searchInput.value.toLowerCase();
            const status = statusFilter.value;

            sessions.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const trainer = item.getAttribute('data-trainer').toLowerCase();
                const itemStatus = item.getAttribute('data-status');

                const matchesSearch = name.includes(query) || trainer.includes(query);
                const matchesStatus = (status === 'all') || (status === itemStatus);

                if (matchesSearch && matchesStatus) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('keyup', filterGrid);
        statusFilter.addEventListener('change', filterGrid);
    });

    // Helper to auto-fill search when clicking "Enroll" on a recommendation
    function filterSessionsForCourse(courseName) {
        const searchInput = document.getElementById('sessionSearch');
        searchInput.value = courseName;
        searchInput.focus();
        // Trigger search
        const event = new Event('keyup');
        searchInput.dispatchEvent(event);

        // Scroll to grid
        document.getElementById('sessionsContainer').scrollIntoView({ behavior: 'smooth' });
    }
</script>

{% endblock %}