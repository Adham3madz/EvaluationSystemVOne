{% extends "layout.html" %}
{% block title %}Ù…ØªØ§Ø¨Ø¹Ø©: {{ job.JobTitle }}{% endblock %}

{% block content %}
<style>
    /* === Glass Panel Global === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* === Header Section === */
    .job-header-glass {
        background: rgba(0, 0, 0, 0.6);
        color: white !important;
        /* Force White */
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .job-header-glass h2,
    .job-header-glass p,
    .job-header-glass strong {
        color: white !important;
    }

    .job-icon-box {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #0d6efd, #004d7a);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
    }

    /* === Kanban Board Layout === */
    .kanban-container {
        display: flex;
        gap: 10px;
        /* Reduced gap to save space */
        overflow-x: hidden;
        /* Hide scrollbar by default, will fit content */
        padding: 20px 5px;
        align-items: flex-start;
        min-height: calc(100vh - 250px);
        width: 100%;
        /* Ensure full width usage */
    }

    /* ... Scrollbar styling removed as we aim to eliminate scrolling ... */

    .kanban-column {
        flex: 1;
        /* Grow and shrink to share space equally */
        min-width: 0;
        /* Allow shrinking below content size if necessary */
        /* width: 320px; REMOVED fixed width */
        /* flex-shrink: 0; REMOVED prevent shrink */

        background: rgba(20, 20, 25, 0.6);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        flex-direction: column;
        max-height: calc(100vh - 200px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .kanban-header {
        padding: 15px;
        border-radius: 16px 16px 0 0;
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(5px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        /* Text shadow for contrast */
        font-weight: bold;
    }

    /* Force all children of header to be white */
    .kanban-header h6,
    .kanban-header span,
    .kanban-header div {
        color: white !important;
    }

    .kanban-body {
        padding: 15px;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 150px;
    }

    .kanban-body::-webkit-scrollbar {
        width: 6px;
    }

    .kanban-body::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
    }

    /* Column Colors */
    .col-new {
        background: linear-gradient(180deg, rgba(13, 110, 253, 0.4) 0%, rgba(13, 110, 253, 0.1) 100%);
        border-top: 4px solid #0d6efd;
    }

    .col-screening {
        background: linear-gradient(180deg, rgba(13, 202, 240, 0.4) 0%, rgba(13, 202, 240, 0.1) 100%);
        border-top: 4px solid #0dcaf0;
    }

    .col-interview {
        background: linear-gradient(180deg, rgba(255, 193, 7, 0.4) 0%, rgba(255, 193, 7, 0.1) 100%);
        border-top: 4px solid #ffc107;
    }

    .col-training {
        background: linear-gradient(180deg, rgba(102, 16, 242, 0.4) 0%, rgba(102, 16, 242, 0.1) 100%);
        border-top: 4px solid #6610f2;
    }

    .col-offer {
        background: linear-gradient(180deg, rgba(230, 230, 230, 0.4) 0%, rgba(200, 200, 200, 0.1) 100%);
        border-top: 4px solid #fff;
    }

    .col-hired {
        background: linear-gradient(180deg, rgba(25, 135, 84, 0.4) 0%, rgba(25, 135, 84, 0.1) 100%);
        border-top: 4px solid #198754;
    }

    .col-rejected {
        background: linear-gradient(180deg, rgba(220, 53, 69, 0.4) 0%, rgba(220, 53, 69, 0.1) 100%);
        border-top: 4px solid #dc3545;
    }

    .col-waiting {
        background: linear-gradient(180deg, rgba(253, 126, 20, 0.4) 0%, rgba(253, 126, 20, 0.1) 100%);
        border-top: 4px solid #fd7e14;
    }

    /* === Candidate Cards (Draggable) === */
    .candidate-card {
        background: rgba(40, 44, 52, 0.95);
        /* Opaque dark background */
        backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        cursor: grab;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
        color: white !important;
        /* Force white text */
    }

    .candidate-card h6,
    .candidate-card p,
    .candidate-card small,
    .candidate-card span {
        color: white !important;
    }

    .candidate-card .text-muted {
        color: rgba(255, 255, 255, 0.7) !important;
        /* Override muted */
    }

    .candidate-card:active {
        cursor: grabbing;
        transform: rotate(2deg) scale(1.02);
    }

    .candidate-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.5);
        background: rgba(50, 54, 62, 1);
        border-color: rgba(255, 255, 255, 0.4);
    }

    /* Drag over effect */
    .kanban-body.drag-over {
        background: rgba(255, 255, 255, 0.1);
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 12px;
    }

    .dragging {
        opacity: 0.5;
        border: 2px dashed #fff;
    }

    /* Text Colors */
    .text-light-glass {
        color: rgba(255, 255, 255, 0.7);
    }

    .text-light-glass-50 {
        color: rgba(255, 255, 255, 0.5);
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.25);
        color: white;
    }

    /* Glass Search */
    .search-glass {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        border-radius: 12px;
        padding: 12px 20px;
    }

    .search-glass::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    /* === Modal Glass === */
    .modal-content.glass-modal {
        background: #1e1e24;
        /* Solid Dark */
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white !important;
    }

    .modal-title,
    .modal-body label,
    .modal-body p {
        color: white !important;
    }

    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
    }

    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5) !important;
    }

    /* Button Visibility on Card */
    .btn-card-action {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        transition: 0.2s;
    }

    .btn-card-action:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
    }

    .modal-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-footer {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .glass-modal .form-control,
    .glass-modal .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
    }
</style>

<div class="container-fluid py-4" style="min-height: 100vh;">

    <div class="container-fluid" style="padding: 0 30px;">

        <!-- Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} shadow-lg border-0 mb-4 fw-bold d-flex align-items-center"
            style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);">
            {{ message }}
            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <!-- Header -->
        <div class="job-header-glass">
            <div class="job-icon-box">ğŸ’¼</div>
            <div class="flex-grow-1 text-white">
                <h2 class="fw-bold mb-1 text-white">{{ job.JobTitle }}</h2>
                <p class="mb-0 opacity-75">
                    ğŸ‘¤ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <strong class="text-white">{{ job.HiringManager }}</strong> | ğŸ¢ Ø§Ù„Ù‚Ø³Ù…: {{
                    job.DEPTNAME_DISPLAY or 'Ø¹Ø§Ù…' }}
                </p>
            </div>

            <div class="d-flex align-items-center gap-3">
                <input type="text" id="candidateSearch" class="form-control search-glass" style="width: 250px;"
                    placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø´Ø­...">

                <button class="btn btn-primary rounded-pill px-4 shadow-lg fw-bold" data-bs-toggle="modal"
                    data-bs-target="#addCandidateModal">
                    â• Ù…Ø±Ø´Ø­ Ø¬Ø¯ÙŠØ¯
                </button>
                <a href="{{ url_for('recruitment_jobs') }}" class="btn btn-glass rounded-pill px-4">
                    â¬…ï¸ Ø®Ø±ÙˆØ¬
                </a>
            </div>
        </div>

        <!-- KANBAN BOARD -->
        <div class="kanban-container">
            {% set kanban_stages = ['New', 'Screening', 'Interview', 'Training', 'Offer', 'Hired', 'Reactive_Reject'] %}

            {# NOTE: Reactive_Reject is a hack to separate Rejected/Waiting if needed, but here we iterate standard
            stages + Rejected/Waiting manually #}

            {% for stage in ['New', 'Screening', 'Interview', 'Training', 'Offer', 'Hired', 'Waiting', 'Rejected',
            'Resigned'] %}

            {% set stage_display = stage %}
            {% set col_class = 'col-new' %}
            {% set icon = 'ğŸ†•' %}

            {% if stage == 'New' %}{% set stage_display = 'Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' %}{% set col_class = 'col-new' %}{% set icon =
            'ğŸ†•' %}
            {% elif stage == 'Screening' %}{% set stage_display = 'ÙØ­Øµ Ø£ÙˆÙ„ÙŠ' %}{% set col_class = 'col-screening' %}{%
            set icon = 'ğŸ§' %}
            {% elif stage == 'Interview' %}{% set stage_display = 'Ù…Ù‚Ø§Ø¨Ù„Ø© Ø´Ø®ØµÙŠØ©' %}{% set col_class = 'col-interview'
            %}{% set icon = 'ğŸ—£ï¸' %}
            {% elif stage == 'Training' %}{% set stage_display = 'ØªØ¯Ø±ÙŠØ¨ (3 Ø´Ù‡ÙˆØ±)' %}{% set col_class = 'col-training'
            %}{% set icon = 'ğŸ“' %}
            {% elif stage == 'Offer' %}{% set stage_display = 'Ø¹Ø±Ø¶ Ø¹Ù…Ù„' %}{% set col_class = 'col-offer' %}{% set icon =
            'ğŸ“œ' %}
            {% elif stage == 'Hired' %}{% set stage_display = 'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†' %}{% set col_class = 'col-hired' %}{% set
            icon = 'ğŸ‰' %}
            {% elif stage == 'Waiting' %}{% set stage_display = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' %}{% set col_class = 'col-waiting' %}{%
            set icon = 'â³' %}
            {% elif stage == 'Rejected' %}{% set stage_display = 'Ù…Ø±ÙÙˆØ¶' %}{% set col_class = 'col-rejected' %}{% set
            icon = 'ğŸš«' %}
            {% elif stage == 'Resigned' %}{% set stage_display = 'Ø§Ù†Ø³Ø­Ø§Ø¨ / Ø§Ø³ØªÙ‚Ø§Ù„Ø©' %}{% set col_class = 'col-rejected'
            %}{% set
            icon = 'ğŸ‘‹' %}
            {% endif %}

            {% set stage_candidates = candidates|selectattr('Status', 'equalto', stage)|list %}

            <div class="kanban-column" ondragover="allowDrop(event)" ondrop="drop(event, '{{ stage }}')"
                ondragenter="this.querySelector('.kanban-body').classList.add('drag-over')"
                ondragleave="this.querySelector('.kanban-body').classList.remove('drag-over')">

                <div class="kanban-header {{ col_class }}">
                    <div class="d-flex align-items-center gap-2">
                        <span>{{ icon }}</span>
                        <h6 class="mb-0 fw-bold">{{ stage_display }}</h6>
                    </div>
                    <span class="badge bg-white text-dark rounded-pill shadow-sm"
                        style="color: #000 !important; font-weight: 800; font-size: 0.9rem;">{{ stage_candidates|length
                        }}</span>
                </div>

                <div class="kanban-body">
                    {% for c in stage_candidates %}
                    <div class="candidate-card" draggable="true"
                        ondragstart="drag(event, '{{ c.CandidateID }}', '{{ c.FullName }}')"
                        id="card-{{ c.CandidateID }}" data-name="{{ c.FullName }}" data-phone="{{ c.Phone }}">

                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <span
                                class="badge bg-secondary bg-opacity-25 text-white border border-secondary border-opacity-25">{{
                                c.Source }}</span>
                            <small class="text-light-glass-50" style="font-size: 0.75rem;">{{
                                c.ApplicationDate.strftime('%Y-%m-%d') }}</small>
                        </div>

                        <h6 class="candidate-name mb-1">{{ c.FullName }}</h6>
                        <p class="small text-light-glass mb-2">ğŸ“ {{ c.Phone }}</p>

                        {% if c.LastNote %}
                        <div class="bg-black bg-opacity-25 rounded p-2 mb-2 border border-white border-opacity-10">
                            <small class="d-block text-warning fw-bold" style="font-size: 0.75rem;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©:</small>
                            <p class="mb-0 small text-white fst-italic text-truncate" style="max-width: 250px;">{{
                                c.LastNote }}</p>
                        </div>
                        {% endif %}

                        <!-- Action Buttons on Card -->
                        <div class="d-flex gap-2 mt-2">
                            <button
                                onclick="openEditModal(
                                    '{{ c.CandidateID }}', '{{ c.FullName }}', '{{ c.Phone }}', '{{ c.Email or '' }}', '{{ c.NationalID or '' }}', '{{ c.Source }}', '{{ c.ApplicationDate.strftime('%Y-%m-%d') if c.ApplicationDate else '' }}' )"
                                class="btn btn-sm btn-outline-warning text-white flex-fill p-1" title="ØªØ¹Ø¯ÙŠÙ„">
                                âœï¸
                            </button>

                            <button onclick="openDocModal(
                                    '{{ c.CandidateID }}', '{{ c.FullName }}', {{ c.DocBirthCert|default(0)|int }}, {{ c.DocDegree|default(0)|int }}, {{ c.DocMilitary|default(0)|int }}, {{ c.DocCriminalRecord|default(0)|int }}, {{ c.DocPersonalPhoto|default(0)|int }}, {{ c.DocIDCard|default(0)|int }}, {{ c.DocInfoSheet|default(0)|int }}
                                )" class="btn btn-sm btn-outline-info text-white flex-fill p-1" title="Ø§Ù„Ù…Ù„ÙØ§Øª">
                                ğŸ“‚
                            </button>

                            <button onclick="openTransferModal('{{ c.CandidateID }}', '{{ c.FullName }}')"
                                class="btn btn-sm btn-outline-secondary text-white flex-fill p-1" title="Ù†Ù‚Ù„ ÙˆØ¸ÙŠÙØ©">
                                ğŸ”„
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- 1. ADD CANDIDATE MODAL -->
<div class="modal fade" id="addCandidateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg" method="POST"
            action="{{ url_for('add_candidate_to_job', job_id=job.JobID) }}">
            <div class="modal-header">
                <h5 class="modal-title text-white">ğŸ“„ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø´Ø­ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="fw-bold text-white">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                    <input type="date" name="application_date" id="appDateInput" class="form-control" required>
                </div>
                <!-- Other fields shortened for brevity but functional -->
                <div class="row">
                    <div class="col-6 mb-3"><label class="text-white">Ø§Ù„Ø§Ø³Ù…</label><input type="text" name="name"
                            class="form-control" required></div>
                    <div class="col-6 mb-3"><label class="text-white">Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" name="phone"
                            class="form-control" required></div>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="text-white">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                        <input type="text" name="national_id" class="form-control">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="text-white">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                        <input type="email" name="email" class="form-control">
                    </div>
                </div>
                <div class="mb-3"><label class="text-white">Ø§Ù„Ù…ØµØ¯Ø±</label>
                    <select name="source" class="form-select">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Referral">ØªØ±Ø´ÙŠØ­</option>
                        <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
                        <option value="Website">Ù…ÙˆÙ‚Ø¹</option>
                        <option value="Other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary fw-bold">Ø­ÙØ¸</button>
            </div>
        </form>
    </div>
</div>

<!-- 2. MOVE / EVALUATE MODAL (Triggered by Drop) -->
<div class="modal fade" id="moveModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg" method="POST"
            action="{{ url_for('move_candidate_with_eval') }}">
            <div class="modal-header bg-gradient">
                <h5 class="modal-title">ğŸ“ ØªÙ‚ÙŠÙŠÙ… ÙˆÙ†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="modal_candidate_id">
                <input type="hidden" name="new_stage" id="modal_new_stage">

                <div class="text-center mb-4">
                    <p class="text-white-50 mb-1">Ù†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­:</p>
                    <h4 id="modal_candidate_name" class="fw-bold text-white"></h4>
                    <div class="d-inline-flex align-items-center gap-2 mt-2">
                        <span class="fs-4">â¬‡ï¸</span>
                        <span id="modal_stage_display"
                            class="badge bg-white text-dark fs-6 px-3 py-2 rounded-pill shadow-sm"></span>
                    </div>
                </div>

                <hr class="border-white opacity-25">

                <div class="mb-4">
                    <label class="form-label fw-bold d-flex justify-content-between text-white">
                        <span>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</span>
                        <span class="text-warning fw-bold" id="scoreVal">5/10</span>
                    </label>
                    <input type="range" name="score" class="form-range" min="1" max="10" value="5"
                        oninput="document.getElementById('scoreVal').innerText = this.value + '/10'">
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold text-white">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø³Ø¨Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø±</label>
                    <textarea name="note" class="form-control" rows="3"
                        placeholder="Ù…Ø«Ø§Ù„: Ø§Ø¬ØªØ§Ø² Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„ÙÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="submit" class="btn btn-success fw-bold px-4">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</button>
            </div>
        </form>
    </div>
</div>

<!-- 3. DOCS MODAL -->
<div class="modal fade" id="docModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg" method="POST" action="{{ url_for('update_candidate_docs') }}">
            <!-- ... Inputs same as before ... -->
            <div class="modal-header">
                <h5 class="modal-title text-white">ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª</h5><button type="button"
                    class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="doc_candidate_id">
                <h5 id="doc_candidate_name" class="text-center text-white mb-3"></h5>
                <div class="vstack gap-2">
                    {% for doc_id, label in [('birth', '1. Ø´Ù‡Ø§Ø¯Ø© Ù…ÙŠÙ„Ø§Ø¯'), ('degree', '2. Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¤Ù‡Ù„'), ('military', '3.
                    Ø´Ù‡Ø§Ø¯Ø© Ø¬ÙŠØ´'), ('criminal', '4. ÙÙŠØ´ Ø¬Ù†Ø§Ø¦ÙŠ'), ('photo', '5. ØµÙˆØ± Ø´Ø®ØµÙŠØ©'), ('id', '6. ØµÙˆØ± Ø¨Ø·Ø§Ù‚Ø©'),
                    ('sheet', '7. Info Sheet')] %}
                    <div
                        class="form-check form-switch p-2 border border-white border-opacity-10 rounded d-flex justify-content-between">
                        <label class="form-check-label text-white" for="check_{{ doc_id }}">{{ label }}</label>
                        <input class="form-check-input" type="checkbox" name="doc_{{ doc_id }}" id="check_{{ doc_id }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">Ø­ÙØ¸</button></div>
        </form>
    </div>
</div>

<!-- 4. EDIT & TRANSFER MODALS (Condensed) -->
<div class="modal fade" id="editCandidateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg" method="POST" action="{{ url_for('edit_candidate') }}">
            <div class="modal-header">
                <h5 class="text-white">âœï¸ ØªØ¹Ø¯ÙŠÙ„</h5><button type="button" class="btn-close btn-close-white"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="edit_id">
                <input type="date" name="application_date" id="edit_app_date" class="form-control mb-3">
                <input type="text" name="name" id="edit_name" class="form-control mb-3" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input type="text" name="phone" id="edit_phone" class="form-control mb-3" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
                <input type="text" name="national_id" id="edit_nid" class="form-control mb-3"
                    placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ">
                <input type="email" name="email" id="edit_email" class="form-control mb-3" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯">
                <select name="source" id="edit_source" class="form-select">
                    <option value="Other">Other</option>
                    <option value="LinkedIn">LinkedIn</option>
                </select>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-warning">ØªØ¹Ø¯ÙŠÙ„</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg" method="POST"
            action="{{ url_for('transfer_candidate_to_job') }}">
            <div class="modal-header">
                <h5 class="text-white">ğŸ”„ Ù†Ù‚Ù„</h5><button type="button" class="btn-close btn-close-white"
                    data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="transfer_candidate_id">
                <h5 id="transfer_candidate_name" class="text-center text-white mb-3"></h5>
                <select name="new_job_id" class="form-select" required>
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ© --</option>
                    {% for j in other_jobs %}<option value="{{ j.JobID }}">{{ j.JobTitle }}</option>{% endfor %}
                </select>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-info">Ù†Ù‚Ù„</button></div>
        </form>
    </div>
</div>

<script>
    // === JS Logic for DnD ===
    document.addEventListener('DOMContentLoaded', function () {
        // Set Today Date default
        const dateInput = document.getElementById('appDateInput');
        if (dateInput) dateInput.valueAsDate = new Date();
    });

    // 1. Drag Start
    function drag(ev, id, name) {
        ev.dataTransfer.setData("text/plain", JSON.stringify({ id: id, name: name }));
        ev.currentTarget.classList.add('dragging');
    }

    // 2. Allow Drop
    function allowDrop(ev) {
        ev.preventDefault();
    }

    // 3. Drop Event
    function drop(ev, newStage) {
        ev.preventDefault();

        // Remove 'drag-over' class from all columns
        document.querySelectorAll('.kanban-body').forEach(el => el.classList.remove('drag-over'));
        document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));

        const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
        const candidateId = data.id;
        const candidateName = data.name;

        // Open the Modal to confirm move + add note
        openMoveModal(candidateId, candidateName, newStage);
    }

    // === Helper Functions ===
    function openMoveModal(id, name, stage) {
        document.getElementById('modal_candidate_id').value = id;
        document.getElementById('modal_candidate_name').innerText = name;
        document.getElementById('modal_new_stage').value = stage;

        let label = stage;
        // Arabic mapping
        const map = {
            'New': 'Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', 'Screening': 'ÙØ­Øµ Ø£ÙˆÙ„ÙŠ', 'Interview': 'Ù…Ù‚Ø§Ø¨Ù„Ø© Ø´Ø®ØµÙŠØ©',
            'Training': 'ØªØ¯Ø±ÙŠØ¨', 'Offer': 'Ø¹Ø±Ø¶ Ø¹Ù…Ù„', 'Hired': 'ØªØ¹ÙŠÙŠÙ†',
            'Waiting': 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'Rejected': 'Ø±ÙØ¶'
        };
        if (map[stage]) label = map[stage];

        document.getElementById('modal_stage_display').innerText = label;

        // Color coding header
        const header = document.querySelector('#moveModal .modal-header');
        header.className = 'modal-header text-white ';
        if (stage === 'Rejected') header.classList.add('bg-danger');
        else if (stage === 'Hired') header.classList.add('bg-success');
        else if (stage === 'Waiting') header.classList.add('bg-warning', 'text-dark');
        else header.classList.add('bg-primary');

        new bootstrap.Modal(document.getElementById('moveModal')).show();
    }

    // Search Logic
    document.getElementById('candidateSearch').addEventListener('keyup', function () {
        let val = this.value.toLowerCase();
        document.querySelectorAll('.candidate-card').forEach(card => {
            let name = card.getAttribute('data-name').toLowerCase();
            let phone = card.getAttribute('data-phone');
            if (name.includes(val) || (phone && phone.includes(val))) card.style.display = 'block';
            else card.style.display = 'none';
        });
    });

    // Helper Modals (Recycled from previous template)
    function openDocModal(id, name, b, d, m, c, p, i, s) {
        document.getElementById('doc_candidate_id').value = id;
        document.getElementById('doc_candidate_name').innerText = name;
        document.getElementById('check_birth').checked = !!b;
        document.getElementById('check_degree').checked = !!d;
        document.getElementById('check_military').checked = !!m;
        document.getElementById('check_criminal').checked = !!c;
        document.getElementById('check_photo').checked = !!p;
        document.getElementById('check_id').checked = !!i;
        document.getElementById('check_sheet').checked = !!s;
        new bootstrap.Modal(document.getElementById('docModal')).show();
    }

    function openEditModal(id, name, phone, email, nid, source, appDate) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_phone').value = phone;
        document.getElementById('edit_email').value = email;
        document.getElementById('edit_nid').value = nid;
        document.getElementById('edit_app_date').value = appDate;
        document.getElementById('edit_source').value = source || 'Other';
        new bootstrap.Modal(document.getElementById('editCandidateModal')).show();
    }

    function openTransferModal(id, name) {
        document.getElementById('transfer_candidate_id').value = id;
        document.getElementById('transfer_candidate_name').innerText = name;
        new bootstrap.Modal(document.getElementById('transferModal')).show();
    }
</script>
{% endblock %}