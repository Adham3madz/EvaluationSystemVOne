{% extends "layout.html" %}
{% block title %}Ù…ØªØ§Ø¨Ø¹Ø©: {{ job.JobTitle }}{% endblock %}

{% block content %}
<style>
    /* === Glass Panel Global === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* === Header Section === */
    .job-header-glass {
        background: rgba(0, 0, 0, 0.6); 
        color: white;
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.15);
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .job-icon-box {
        width: 70px;
        height: 70px;
        background: linear-gradient(135deg, #0d6efd, #004d7a);
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3);
    }

    /* === Search Bar === */
    .search-glass {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important; 
        border-radius: 12px;
        padding: 15px 20px;
        font-size: 1.1rem;
        transition: all 0.3s;
    }
    .search-glass::placeholder { color: rgba(255, 255, 255, 0.7); }
    .search-glass:focus {
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        color: white;
        outline: none;
    }

    /* === Stage Headers === */
    .stage-header {
        padding: 15px;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        backdrop-filter: blur(5px);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        color: white; /* Ensures text inside is white */
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .stage-new { background: linear-gradient(135deg, rgba(13, 110, 253, 0.6), rgba(13, 110, 253, 0.3)); border-top: 3px solid #0d6efd; }
    .stage-screening { background: linear-gradient(135deg, rgba(13, 202, 240, 0.6), rgba(13, 202, 240, 0.3)); border-top: 3px solid #0dcaf0; }
    .stage-interview { background: linear-gradient(135deg, rgba(255, 193, 7, 0.6), rgba(255, 193, 7, 0.3)); border-top: 3px solid #ffc107; }
    .stage-training { background: linear-gradient(135deg, rgba(102, 16, 242, 0.6), rgba(102, 16, 242, 0.3)); border-top: 3px solid #6610f2; }
    .stage-offer { background: linear-gradient(135deg, rgba(33, 37, 41, 0.7), rgba(33, 37, 41, 0.4)); border-top: 3px solid #fff; }
    .stage-hired { background: linear-gradient(135deg, rgba(25, 135, 84, 0.6), rgba(25, 135, 84, 0.3)); border-top: 3px solid #198754; }
    .stage-rejected { background: linear-gradient(135deg, rgba(220, 53, 69, 0.6), rgba(220, 53, 69, 0.3)); border-top: 3px solid #dc3545; }

    /* === Candidate Cards (UPDATED TO DARK GLASS) === */
    /* Changed background to dark so white text is visible */
    .candidate-card {
        background: rgba(30, 30, 35, 0.8); /* Dark background */
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        margin-bottom: 15px;
    }
    
    .candidate-card:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        background: rgba(40, 40, 45, 0.9);
    }

    /* Updated text colors to white */
    .candidate-name { color: white; font-weight: 800; font-size: 1.1rem; }
    .candidate-meta { color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; font-weight: 600; }
    .candidate-phone { color: rgba(255, 255, 255, 0.8); }

    /* === Modal Glass === */
    .modal-content.glass-modal {
        background: rgba(30, 30, 35, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        color: white !important;
    }
    
    .modal-header { border-bottom: 1px solid rgba(255,255,255,0.1); }
    .modal-footer { border-top: 1px solid rgba(255,255,255,0.1); }
    
    .glass-modal .form-control, .glass-modal .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white !important;
    }
    .glass-modal .form-control:focus, .glass-modal .form-select:focus {
        background: rgba(255,255,255,0.2);
        color: white !important;
    }
    .glass-modal .form-control::placeholder { color: rgba(255, 255, 255, 0.5); }
    .glass-modal option { color: #000; }
    .btn-glass {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        transition: 0.2s;
    }
    .btn-glass:hover { background: rgba(255, 255, 255, 0.4); color: white; }
</style>

<div class="container-fluid py-4" style="min-height: 100vh;">
    
    <div class="container" style="max-width: 1200px;">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} shadow-lg border-0 mb-4 fw-bold d-flex align-items-center" 
                   style="background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);">
                  {{ message }}
                  <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="job-header-glass">
            <div class="job-icon-box">
                ğŸ’¼
            </div>
            <div class="flex-grow-1 text-white">
                <h2 class="fw-bold mb-1 text-white">{{ job.JobTitle }}</h2>
                <p class="mb-0 opacity-75 text-white">
                    ğŸ‘¤ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <strong class="text-white">{{ job.HiringManager }}</strong>
                </p>
            </div>
            <div class="d-flex gap-2">
                 <a href="{{ url_for('recruitment_jobs') }}" class="btn btn-glass rounded-pill px-4">
                    â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©
                 </a>
                <button class="btn btn-primary rounded-pill px-4 shadow-lg fw-bold" data-bs-toggle="modal" data-bs-target="#addCandidateModal">
                    â• Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­
                </button>
            </div>
        </div>

        <div class="mb-5">
            <div class="input-group input-group-lg shadow-lg" style="border-radius: 12px; overflow: hidden;">
                <span class="input-group-text border-0" style="background: rgba(255,255,255,0.15); color: white;">ğŸ”</span>
                <input type="text" id="candidateSearch" class="form-control search-glass border-0" 
                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø´Ø­ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
            </div>
        </div>

        <div class="vstack gap-4">
            
            {% set custom_stages = ['New', 'Screening', 'Interview', 'Training', 'Offer', 'Hired', 'Rejected'] %}
            
            {% for stage in custom_stages %}
            
            {% set stage_class = 'stage-new' %}
            {% set stage_name = 'Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©' %}
            {% set stage_icon = 'ğŸ†•' %}

            {% if stage == 'Screening' %}
                {% set stage_class = 'stage-screening' %} {% set stage_name = 'ÙØ­Øµ Ø£ÙˆÙ„ÙŠ' %} {% set stage_icon = 'ğŸ§' %}
            {% elif stage == 'Interview' %}
                {% set stage_class = 'stage-interview' %} {% set stage_name = 'Ù…Ù‚Ø§Ø¨Ù„Ø© Ø´Ø®ØµÙŠØ©' %} {% set stage_icon = 'ğŸ—£ï¸' %}
            {% elif stage == 'Training' %}
                {% set stage_class = 'stage-training' %} {% set stage_name = 'ğŸ“ ØªØ¯Ø±ÙŠØ¨ (3 Ø´Ù‡ÙˆØ±)' %} {% set stage_icon = 'ğŸ“' %}
            {% elif stage == 'Offer' %}
                {% set stage_class = 'stage-offer' %} {% set stage_name = 'Ø¹Ø±Ø¶ Ø¹Ù…Ù„' %} {% set stage_icon = 'ğŸ“œ' %}
            {% elif stage == 'Hired' %}
                {% set stage_class = 'stage-hired' %} {% set stage_name = 'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†' %} {% set stage_icon = 'ğŸ‰' %}
            {% elif stage == 'Rejected' %}
                {% set stage_class = 'stage-rejected' %} {% set stage_name = 'Ù…Ø±ÙÙˆØ¶' %} {% set stage_icon = 'ğŸš«' %}
            {% endif %}

            {% set stage_candidates = candidates|selectattr('Status', 'equalto', stage)|list %}

            {% if stage_candidates|length > 0 or stage == 'New' %}
            <div class="stage-section" style="margin-bottom: 20px;">
                
                <div class="stage-header {{ stage_class }}">
                    <div class="d-flex align-items-center gap-3">
                        <span class="fs-4">{{ stage_icon }}</span>
                        <h5 class="fw-bold mb-0 text-white">{{ stage_name }}</h5>
                    </div>
                    <span class="badge bg-white text-dark rounded-pill px-3 fs-6 shadow-sm">{{ stage_candidates|length }}</span>
                </div>
                
                <div class="p-3" style="background: rgba(0,0,0,0.2); border-radius: 0 0 12px 12px; border: 1px solid rgba(255,255,255,0.05); border-top: none;">
                    {% if stage_candidates|length == 0 %}
                        <div class="text-center py-3 opacity-50 text-white">
                            <div class="fs-1 mb-2">ğŸ“‚</div>
                            <p class="mb-0">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø´Ø­ÙŠÙ† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.</p>
                        </div>
                    {% else %}
                        <div class="row g-3">
                            {% for c in stage_candidates %}
                            <div class="col-md-6 col-lg-4 candidate-item"> 
                                <div class="candidate-card h-100">
                                    
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="badge bg-secondary bg-opacity-25 text-white border">{{ c.Source }}</span>
                                        <small class="candidate-meta text-white-50">{{ c.ApplicationDate.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                    
                                    <h5 class="candidate-name mb-1 text-white">{{ c.FullName }}</h5>
                                    <p class="small text-white-50 mb-1 candidate-phone">ğŸ“ {{ c.Phone }}</p>
                                    {% if c.NationalID %}<p class="small text-white-50 mb-2">ğŸ†” {{ c.NationalID }}</p>{% endif %}

                                    {% if c.LastNote %}
                                    <div class="bg-dark bg-opacity-50 border border-secondary rounded p-2 mb-3">
                                        <small class="text-white-50 d-block fw-bold mb-1">ğŸ“ Ø¢Ø®Ø± Ù…Ù„Ø§Ø­Ø¸Ø©:</small>
                                        <p class="mb-0 small text-white fst-italic">"{{ c.LastNote }}"</p>
                                    </div>
                                    {% else %}
                                    <div class="mb-3"></div> {% endif %}
                                    
                                    <div class="d-flex gap-2 mb-2">
                                        <button onclick="openEditModal(
                                            '{{ c.CandidateID }}', '{{ c.FullName }}', '{{ c.Phone }}', '{{ c.Email or '' }}', '{{ c.NationalID or '' }}', '{{ c.Source }}', '{{ c.ApplicationDate.strftime('%Y-%m-%d') if c.ApplicationDate else '' }}' )" class="btn btn-sm btn-outline-warning text-white border-warning" title="ØªØ¹Ø¯ÙŠÙ„">
                                            âœï¸
                                        </button>

                                        <button onclick="openDocModal(
                                            '{{ c.CandidateID }}', '{{ c.FullName }}', {{ c.DocBirthCert|default(0)|int }}, {{ c.DocDegree|default(0)|int }}, {{ c.DocMilitary|default(0)|int }}, {{ c.DocCriminalRecord|default(0)|int }}, {{ c.DocPersonalPhoto|default(0)|int }}, {{ c.DocIDCard|default(0)|int }}, {{ c.DocInfoSheet|default(0)|int }}
                                        )" class="btn btn-sm btn-outline-light flex-grow-1 text-white">
                                            ğŸ“‚ Ø§Ù„Ù…Ù„ÙØ§Øª
                                        </button>

                                        <button onclick="openTransferModal('{{ c.CandidateID }}', '{{ c.FullName }}')" 
                                                class="btn btn-sm btn-outline-primary text-white" title="Ù†Ù‚Ù„">
                                            ğŸ”„ Ù†Ù‚Ù„
                                        </button>
                                    </div>

                                    <div class="d-grid gap-2">
                                        {% if stage != 'Rejected' and stage != 'Hired' %}
                                            
                                            {# Logic for Next/Prev #}
                                            {% set next_stage = '' %}
                                            {% if stage == 'New' %}{% set next_stage = 'Screening' %}{% endif %}
                                            {% if stage == 'Screening' %}{% set next_stage = 'Interview' %}{% endif %}
                                            {% if stage == 'Interview' %}{% set next_stage = 'Training' %}{% endif %}
                                            {% if stage == 'Training' %}{% set next_stage = 'Offer' %}{% endif %}
                                            {% if stage == 'Offer' %}{% set next_stage = 'Hired' %}{% endif %}

                                            {% set prev_stage = '' %}
                                            {% if stage == 'Screening' %}{% set prev_stage = 'New' %}{% endif %}
                                            {% if stage == 'Interview' %}{% set prev_stage = 'Screening' %}{% endif %}
                                            {% if stage == 'Training' %}{% set prev_stage = 'Interview' %}{% endif %}
                                            {% if stage == 'Offer' %}{% set prev_stage = 'Training' %}{% endif %}

                                            <div class="d-flex gap-2">
                                                {% if prev_stage %}
                                                <button onclick="openMoveModal('{{ c.CandidateID }}', '{{ c.FullName }}', '{{ prev_stage }}', 'back')" 
                                                        class="btn btn-outline-light btn-sm w-50">â¬…ï¸ Ø¹ÙˆØ¯Ø©</button>
                                                {% endif %}

                                                {% if next_stage %}
                                                <button onclick="openMoveModal('{{ c.CandidateID }}', '{{ c.FullName }}', '{{ next_stage }}', 'next')" 
                                                        class="btn btn-success btn-sm w-100">Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸</button>
                                                {% endif %}
                                            </div>

                                            <button onclick="openMoveModal('{{ c.CandidateID }}', '{{ c.FullName }}', 'Waiting', 'waiting')" 
                                                    class="btn btn-warning btn-sm text-dark fw-bold mt-1">â³ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</button>
                                            
                                            <button onclick="openMoveModal('{{ c.CandidateID }}', '{{ c.FullName }}', 'Rejected', 'reject')" 
                                                    class="btn btn-outline-danger btn-sm mt-1">âŒ Ø±ÙØ¶</button>

                                        {% elif stage == 'Rejected' %}
                                            <div class="alert alert-danger py-1 mb-0 text-center small fw-bold">â›” ØªÙ… Ø§Ù„Ø±ÙØ¶</div>
                                            <button onclick="openMoveModal('{{ c.CandidateID }}', '{{ c.FullName }}', 'New', 'back')" 
                                                    class="btn btn-sm btn-outline-secondary mt-2">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­</button>
                                        {% elif stage == 'Hired' %}
                                            <div class="alert alert-success py-1 mb-0 text-center small fw-bold">ğŸ‰ ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {% endfor %}
            
        </div>
    </div>
</div>

<div class="modal fade" id="addCandidateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg text-white" method="POST" action="{{ url_for('add_candidate_to_job', job_id=job.JobID) }}">
            <div class="modal-header">
                <h5 class="modal-title text-white">ğŸ“„ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±Ø´Ø­ Ø¬Ø¯ÙŠØ¯</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                
                <div class="mb-3">
                    <label class="fw-bold text-white">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                    <input type="date" name="application_date" id="appDateInput" class="form-control" required>
                    <div class="form-text text-white-50 small">Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ù„ÙŠÙˆÙ…ØŒ Ø£Ùˆ ØºÙŠÙ‘Ø±Ù‡ Ù„ØªØ³Ø¬ÙŠÙ„ ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ….</div>
                </div>

                <div class="mb-3">
                    <label class="fw-bold text-white">ğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                    <input type="text" name="national_id" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" name="name" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="fw-bold text-white">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" name="phone" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" class="form-control">
                </div>

                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ù…ØµØ¯Ø±</label>
                    <select name="source" class="form-select">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Referral">ØªØ±Ø´ÙŠØ­ (Referral)</option>
                        <option value="Website">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                        <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
                        <option value="Other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary px-4 fw-bold">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('appDateInput');
        if(dateInput) {
            dateInput.valueAsDate = new Date(); // Defaults to today
        }
    });
</script>

<div class="modal fade" id="editCandidateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg text-white" method="POST" action="{{ url_for('edit_candidate') }}">
            
            <div class="modal-header" style="border-bottom-color: #ffc107;">
                <h5 class="modal-title text-white">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="edit_id">
                
                <div class="mb-3">
                    <label class="fw-bold text-white">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</label>
                    <input type="date" name="application_date" id="edit_app_date" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" name="name" id="edit_name" class="form-control" required>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-white">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="text" name="phone" id="edit_phone" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="fw-bold text-white">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                        <input type="text" name="national_id" id="edit_nid" class="form-control">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" name="email" id="edit_email" class="form-control">
                </div>
                
                <div class="mb-3">
                    <label class="fw-bold text-white">Ø§Ù„Ù…ØµØ¯Ø±</label>
                    <select name="source" id="edit_source" class="form-select">
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Referral">ØªØ±Ø´ÙŠØ­</option>
                        <option value="Website">Ø§Ù„Ù…ÙˆÙ‚Ø¹</option>
                        <option value="Facebook">ÙÙŠØ³Ø¨ÙˆÙƒ</option>
                        <option value="Other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="submit" class="btn btn-warning text-dark fw-bold px-4">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
            
        </form>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg text-white" method="POST" action="{{ url_for('move_candidate_with_eval') }}">
            <div class="modal-header bg-gradient">
                <h5 class="modal-title">ğŸ“ ØªÙ‚ÙŠÙŠÙ… ÙˆÙ†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="modal_candidate_id">
                <input type="hidden" name="new_stage" id="modal_new_stage">
                <div class="text-center mb-4">
                    <p class="text-white-50 mb-1">Ù†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­:</p>
                    <h4 id="modal_candidate_name" class="fw-bold text-white"></h4>
                    <div class="d-inline-flex align-items-center gap-2 mt-2">
                        <span class="fs-4">â¬‡ï¸</span>
                        <span id="modal_stage_display" class="badge bg-white text-dark fs-6 px-3 py-2 rounded-pill shadow-sm"></span>
                    </div>
                </div>
                <hr class="border-white opacity-25">
                <div class="mb-4">
                    <label class="form-label fw-bold d-flex justify-content-between">
                        <span>â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ</span>
                        <span class="text-warning fw-bold" id="scoreVal">5/10</span>
                    </label>
                    <input type="range" name="score" class="form-range" min="1" max="10" value="5" oninput="document.getElementById('scoreVal').innerText = this.value + '/10'">
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø³Ø¨Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø±</label>
                    <textarea name="note" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success fw-bold px-4">âœ… ØªØ£ÙƒÙŠØ¯</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="docModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg text-white" method="POST" action="{{ url_for('update_candidate_docs') }}">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“‚ Ù…Ù„Ù Ù…Ø³ÙˆØºØ§Øª Ø§Ù„ØªØ¹ÙŠÙŠÙ†</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="doc_candidate_id">
                <h5 class="text-center fw-bold mb-4 text-white" id="doc_candidate_name"></h5>
                <div class="vstack gap-2">
                    {% for doc_id, label in [('birth', '1. Ø´Ù‡Ø§Ø¯Ø© Ù…ÙŠÙ„Ø§Ø¯'), ('degree', '2. Ø´Ù‡Ø§Ø¯Ø© Ù…Ø¤Ù‡Ù„'), ('military', '3. Ø´Ù‡Ø§Ø¯Ø© Ø¬ÙŠØ´'), ('criminal', '4. ÙÙŠØ´ Ø¬Ù†Ø§Ø¦ÙŠ'), ('photo', '5. ØµÙˆØ± Ø´Ø®ØµÙŠØ©'), ('id', '6. ØµÙˆØ± Ø¨Ø·Ø§Ù‚Ø©'), ('sheet', '7. Ø´ÙŠØª ØªØ¹Ø§Ø±Ù (Info Sheet)')] %}
                    <div class="form-check form-switch p-3 bg-white bg-opacity-10 rounded d-flex justify-content-between border border-light border-opacity-10">
                        <label class="form-check-label fw-bold text-white" for="check_{{ doc_id }}">{{ label }}</label>
                        <input class="form-check-input" type="checkbox" name="doc_{{ doc_id }}" id="check_{{ doc_id }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success px-4">ğŸ’¾ Ø­ÙØ¸</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content glass-modal shadow-lg text-white" method="POST" action="{{ url_for('transfer_candidate_to_job') }}">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­ Ù„ÙˆØ¸ÙŠÙØ© Ø£Ø®Ø±Ù‰</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" name="candidate_id" id="transfer_candidate_id">
                <p class="text-center mb-4 text-white">Ù†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­: <strong id="transfer_candidate_name" class="fs-5 text-warning"></strong></p>
                <div class="mb-3">
                    <label class="fw-bold mb-2">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
                    <select name="new_job_id" class="form-select form-select-lg" required>
                        <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ© --</option>
                        {% for j in other_jobs %}
                            <option value="{{ j.JobID }}">{{ j.JobTitle }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-info fw-bold">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„</button>
            </div>
        </form>
    </div>
</div>

<script>
    // JS Logic remains the same
    document.getElementById('candidateSearch').addEventListener('keyup', function() {
        let value = this.value.toLowerCase();
        let items = document.querySelectorAll('.candidate-item');
        let stages = document.querySelectorAll('.stage-section');
        items.forEach(item => {
            let name = item.querySelector('.candidate-name').innerText.toLowerCase();
            let phone = item.querySelector('.candidate-phone').innerText.toLowerCase();
            if (name.includes(value) || phone.includes(value)) item.style.display = "block";
            else item.style.display = "none";
        });
        stages.forEach(stage => {
            let allItems = stage.querySelectorAll('.candidate-item');
            let hasVisible = false;
            allItems.forEach(i => { if(i.style.display !== 'none') hasVisible = true; });
            stage.style.display = hasVisible ? "block" : "none";
        });
    });

    function openDocModal(id, name, b, d, m, c, p, i, s) {
        document.getElementById('doc_candidate_id').value = id;
        document.getElementById('doc_candidate_name').innerText = name;
        document.getElementById('check_birth').checked = (b === 1);
        document.getElementById('check_degree').checked = (d === 1);
        document.getElementById('check_military').checked = (m === 1);
        document.getElementById('check_criminal').checked = (c === 1);
        document.getElementById('check_photo').checked = (p === 1);
        document.getElementById('check_id').checked = (i === 1);
        document.getElementById('check_sheet').checked = (s === 1);
        new bootstrap.Modal(document.getElementById('docModal')).show();
    }

    function openTransferModal(id, name) {
        document.getElementById('transfer_candidate_id').value = id;
        document.getElementById('transfer_candidate_name').innerText = name;
        new bootstrap.Modal(document.getElementById('transferModal')).show();
    }

    // Inside job_pipeline.html <script>
    function openEditModal(id, name, phone, email, nid, source, appDate) {
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_phone').value = phone;
        document.getElementById('edit_email').value = email;
        document.getElementById('edit_nid').value = nid;
        document.getElementById('edit_app_date').value = appDate; // NEW: Set the date

        let sourceSelect = document.getElementById('edit_source');
        if (source) sourceSelect.value = source;
        else sourceSelect.value = "Other"; 
        
        new bootstrap.Modal(document.getElementById('editCandidateModal')).show();
    }

    function openMoveModal(id, name, stage, direction) {
        document.getElementById('modal_candidate_id').value = id;
        document.getElementById('modal_candidate_name').innerText = name;
        document.getElementById('modal_new_stage').value = stage;
        
        let stageNameAr = stage;
        if(stage === 'New') stageNameAr = 'Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©';
        if(stage === 'Screening') stageNameAr = 'Ø§Ù„ÙØ­Øµ Ø§Ù„Ø£ÙˆÙ„ÙŠ';
        if(stage === 'Interview') stageNameAr = 'Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©';
        if(stage === 'Training') stageNameAr = 'ğŸ“ Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
        if(stage === 'Offer') stageNameAr = 'Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„';
        if(stage === 'Hired') stageNameAr = 'Ø§Ù„ØªØ¹ÙŠÙŠÙ†';
        if(stage === 'Rejected') stageNameAr = 'Ø§Ù„Ø±ÙØ¶';
        if(stage === 'Waiting') stageNameAr = 'â³ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';

        document.getElementById('modal_stage_display').innerText = stageNameAr;

        const header = document.querySelector('#moveModal .modal-header');
        const btn = document.querySelector('#moveModal button[type="submit"]'); 
        const btnClasses = btn.classList;
        
        header.classList.remove('bg-primary', 'bg-danger', 'bg-secondary', 'bg-warning', 'text-dark', 'bg-success');
        btnClasses.remove('btn-success', 'btn-danger', 'btn-secondary', 'btn-warning');

        if(direction === 'reject') {
            header.classList.add('bg-danger');
            btnClasses.add('btn-danger');
            btn.innerText = "âŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ÙØ¶";
        } else if (direction === 'back') {
            header.classList.add('bg-secondary');
            btnClasses.add('btn-secondary');
            btn.innerText = "â¬…ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©";
        } else if (direction === 'waiting') {
            header.classList.add('bg-warning');
            header.classList.add('text-dark');
            btnClasses.add('btn-warning');
            btn.innerText = "â³ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±";      
        } else {
            header.classList.add('bg-primary');
            btnClasses.add('btn-success');
            btn.innerText = "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‚Ù„";
        }

        new bootstrap.Modal(document.getElementById('moveModal')).show();
    }
</script>
{% endblock %}