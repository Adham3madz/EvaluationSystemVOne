{% extends "layout.html" %}
{% block title %}Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¯Ø±ÙŠØ¨{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
    /* === Glass Panel === */
    /* === Glass Panel === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    /* === KPI Cards (Glass Blue Theme) === */
    .kpi-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(207, 226, 255, 0.4));
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 16px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(13, 110, 253, 0.2);
    }

    .kpi-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .kpi-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #0d6efd;
        line-height: 1;
    }

    .kpi-label {
        font-size: 0.9rem;
        font-weight: 700;
        color: #495057;
    }

    /* === Glass Trainee Card === */
    .trainee-card {
        background: rgba(255, 255, 255, 0.6) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.45) !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05) !important;
        transition: all 0.3s ease;
    }

    .trainee-card:hover {
        transform: translateY(-5px);
        background: rgba(255, 255, 255, 0.8) !important;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1) !important;
    }

    /* === Glass Modal === */
    .glass-modal {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 20px;
    }

    /* === Buttons === */
    .btn-glass-primary {
        background: linear-gradient(135deg, #0d6efd, #0b5ed7);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
    }

    .btn-glass-danger {
        background: linear-gradient(135deg, #dc3545, #b02a37);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
    }

    .progress-thin {
        height: 8px;
        border-radius: 4px;
        background: rgba(0, 0, 0, 0.05);
    }
</style>

<div class="container-fluid py-4" style="background-color: #f4f6f9; min-height: 100vh;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">ğŸ“ Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ£Ù‡ÙŠÙ„</h2>
            <p class="text-muted">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù….</p>
        </div>
        <a href="{{ url_for('recruitment_jobs') }}" class="btn btn-outline-primary shadow-sm rounded-pill px-4">
            â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù
        </a>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="kpi-card">
                <div class="kpi-icon">ğŸ‘¨â€ğŸ“</div>
                <div class="kpi-value" id="totalTrainees">0</div>
                <div class="kpi-label">Ù…ØªØ¯Ø±Ø¨ Ù†Ø´Ø·</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="kpi-card">
                <div class="kpi-icon">ğŸ</div>
                <div class="kpi-value text-success" id="finishingSoon">0</div>
                <div class="kpi-label">Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„ØªØ®Ø±Ø¬ (>80%)</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">ØªÙˆØ²ÙŠØ¹ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙ‚Ø¯Ù…</h6>
                <div style="height: 100px; width: 100%;">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†</h6>
                <div style="height: 100px; width: 100px;">
                    <canvas id="trainerChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 overflow-auto" style="height: calc(100vh - 360px); padding-bottom: 20px;">
        {% for t in trainees %}
        <div class="col-md-6 col-xl-4">
            <div class="card trainee-card shadow-sm h-100 trainee-data-item glass-card"
                style="background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.4);"
                data-progress="{{ t.percent }}" data-trainer="{{ t.trainer or 'ØºÙŠØ± Ù…Ø¹ÙŠÙ†' }}">

                <div class="card-header bg-transparent border-0 pt-4 pb-0 d-flex justify-content-between">
                    <h5 class="fw-bold text-primary mb-0">{{ t.name }}</h5>
                    <span class="badge bg-light text-dark border">{{ t.job }}</span>
                </div>

                <div class="card-body">
                    <p class="text-muted small mb-3">ğŸ“ {{ t.phone }}</p>

                    <div
                        class="bg-light bg-opacity-50 p-2 rounded mb-3 d-flex justify-content-between align-items-center border">
                        <small class="text-muted fw-bold">ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¯Ø±Ø¨:</small>
                        {% if t.trainer %}
                        <span class="fw-bold text-dark">{{ t.trainer }}</span>
                        {% else %}
                        <button class="btn btn-sm btn-outline-secondary py-0"
                            onclick="openTrainerModal('{{ t.id }}', '{{ t.name }}')">
                            + ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø¨
                        </button>
                        {% endif %}
                    </div>

                    <label class="small fw-bold text-muted mb-1 d-flex justify-content-between">
                        <span>Ø§Ù„ØªÙ‚Ø¯Ù… ({{ t.percent }}%)</span>
                        <span>Ø¨Ø§Ù‚ÙŠ {{ t.days_left }} ÙŠÙˆÙ…</span>
                    </label>
                    <div class="progress progress-thin bg-secondary bg-opacity-10">
                        <div class="progress-bar bg-{{ t.color }} progress-bar-striped progress-bar-animated"
                            role="progressbar" style="width: {{ t.percent }}%">
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-2 small text-muted">
                        <span>Ø§Ù„Ø¨Ø¯Ø¡: {{ t.start_date }}</span>
                        <span class="fw-bold text-danger">Ø§Ù„Ù†Ù‡Ø§ÙŠØ©: {{ t.end_date }}</span>
                    </div>

                    <hr class="opacity-25">

                    <div class="d-grid gap-2">
                        <button onclick="openMoveModal('{{ t.id }}', '{{ t.name }}', 'Offer')"
                            class="btn btn-success btn-sm fw-bold">
                            âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                        </button>
                        <button onclick="openMoveModal('{{ t.id }}', '{{ t.name }}', 'Rejected')"
                            class="btn btn-outline-danger btn-sm fw-bold">
                            âŒ Ù„Ù… ÙŠØ¬ØªØ²
                        </button>
                        <form action="{{ url_for('archive_candidate') }}" method="POST"
                            onsubmit="return confirm('Ø£Ø±Ø´ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ØŸ');">
                            <input type="hidden" name="candidate_id" value="{{ t.id }}">
                            <button type="submit" class="btn btn-outline-secondary btn-sm w-100 mt-2">
                                ğŸ“¦ Ø£Ø±Ø´ÙØ© Ù…Ø¤Ù‚ØªØ©
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <div class="glass-panel d-inline-block px-5">
                <div class="fs-1 text-muted opacity-50 mb-3">ğŸ“</div>
                <h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</h4>
                <p class="text-muted">Ù‚Ù… Ø¨Ù†Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© "Ø§Ù„ØªØ¯Ø±ÙŠØ¨" Ù„ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… Ù‡Ù†Ø§.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="trainerModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" method="POST" action="{{ url_for('assign_trainer') }}">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ‘¨â€ğŸ« ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø¨</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="candidate_id" id="trainerCandidateId">
                <p>ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø¨ Ù„Ù„Ù…Ø±Ø´Ø­: <strong id="trainerCandidateName"></strong></p>
                <div class="mb-3">
                    <label class="fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨</label>
                    <input type="text" name="trainer_name" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">Ø­ÙØ¸</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="moveModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" method="POST" action="{{ url_for('move_candidate_with_eval') }}">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ğŸ“ ØªÙ‚ÙŠÙŠÙ… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="candidate_id" id="moveCandidateId">
                <input type="hidden" name="new_stage" id="moveNewStage">
                <p class="text-center lead">Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù€: <strong id="moveCandidateName"></strong></p>
                <div class="mb-3">
                    <label class="fw-bold">â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-10)</label>
                    <input type="range" name="score" class="form-range" min="1" max="10" value="5"
                        oninput="document.getElementById('scoreVal').innerText = this.value">
                    <div class="text-center fw-bold fs-4 text-primary" id="scoreVal">5</div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">ğŸ“ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨</label>
                    <textarea name="note" class="form-control" rows="4" required></textarea>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">ØªØ£ÙƒÙŠØ¯</button></div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- 1. Collect Data from DOM (Safe Offline Method) ---
        const cards = document.querySelectorAll('.trainee-data-item');

        let total = 0;
        let finishing = 0;
        const trainerCounts = {};
        const progressGroups = { 'Ø¬Ø¯ÙŠØ¯ (0-30%)': 0, 'Ù…Ù†ØªØµÙ (31-79%)': 0, 'Ø¥Ù†Ù‡Ø§Ø¡ (80%+)': 0 };

        cards.forEach(card => {
            total++;
            const progress = parseInt(card.getAttribute('data-progress')) || 0;
            const trainer = card.getAttribute('data-trainer');

            // Finishing Soon Logic
            if (progress >= 80) finishing++;

            // Trainer Count
            trainerCounts[trainer] = (trainerCounts[trainer] || 0) + 1;

            // Progress Distribution
            if (progress < 30) progressGroups['Ø¬Ø¯ÙŠØ¯ (0-30%)']++;
            else if (progress < 80) progressGroups['Ù…Ù†ØªØµÙ (31-79%)']++;
            else progressGroups['Ø¥Ù†Ù‡Ø§Ø¡ (80%+)']++;
        });

        // Update Text KPIs
        document.getElementById('totalTrainees').innerText = total;
        document.getElementById('finishingSoon').innerText = finishing;

        if (total === 0) return; // Don't render charts if empty

        // --- 2. Render Progress Chart (Bar) ---
        new Chart(document.getElementById('progressChart'), {
            type: 'bar',
            data: {
                labels: Object.keys(progressGroups),
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†',
                    data: Object.values(progressGroups),
                    backgroundColor: ['#0dcaf0', '#ffc107', '#198754'],
                    borderRadius: 4,
                    barThickness: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, y: { display: false } }
            }
        });

        // --- 3. Render Trainer Chart (Doughnut) ---
        new Chart(document.getElementById('trainerChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(trainerCounts),
                datasets: [{
                    data: Object.values(trainerCounts),
                    backgroundColor: ['#0d6efd', '#6610f2', '#6c757d', '#20c997'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '65%'
            }
        });
    });

    // Modal Functions
    function openTrainerModal(id, name) {
        document.getElementById('trainerCandidateId').value = id;
        document.getElementById('trainerCandidateName').innerText = name;
        new bootstrap.Modal(document.getElementById('trainerModal')).show();
    }

    function openMoveModal(id, name, stage) {
        document.getElementById('moveCandidateId').value = id;
        document.getElementById('moveCandidateName').innerText = name;
        document.getElementById('moveNewStage').value = stage;
        new bootstrap.Modal(document.getElementById('moveModal')).show();
    }
</script>
{% endblock %}