{% extends "layout.html" %}
{% block title %}Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†{% endblock %}

{% block content %}
<style>
    /* === Glass Panel Theme === */
    .glass-panel {
        background: rgba(40, 44, 52, 0.95);
        /* Dark Grey/Blue for better contrast */
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        padding: 25px;
        margin-bottom: 20px;
        color: white;
    }

    /* === Dashboard Cards === */
    .stat-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* === Table Styling === */
    .table-glass {
        color: white !important;
        /* Force white text */
        margin-bottom: 0;
        vertical-align: middle;
        border-color: rgba(255, 255, 255, 0.1);
    }

    .table-glass thead th {
        background: rgba(0, 0, 0, 0.6);
        color: #ffc107 !important;
        /* Gold for headers */
        border: none;
        padding: 15px;
        font-weight: 800;
        font-size: 1rem;
    }

    .table-glass tbody td {
        background: transparent;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 15px;
        color: white !important;
        /* Force white text */
    }

    .table-glass tbody tr:hover td {
        background: rgba(255, 255, 255, 0.1);
    }

    /* === Inputs & Selects === */
    .search-glass,
    .select-glass {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white !important;
        /* Force white text in inputs */
        border-radius: 12px;
        padding: 12px 20px;
    }

    .search-glass::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .select-glass option {
        background: #333;
        /* Dark background for dropdown options */
        color: white;
    }

    .search-glass:focus,
    .select-glass:focus {
        background: rgba(255, 255, 255, 0.2);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        border-color: #ffc107;
        outline: none;
        color: white !important;
    }

    /* === Buttons === */
    .btn-restore {
        background: linear-gradient(135deg, #198754, #146c43);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        transition: 0.3s;
    }

    .btn-restore:hover {
        background: #198754;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        color: white;
    }
</style>

<div class="container-fluid py-4" style="min-height: 100vh;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-white mb-1" style="text-shadow: 0 2px 4px rgba(0,0,0,0.5);">ğŸ“¦ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h2>
            <p class="text-white-50">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙŠÙ† ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning rounded-pill px-4 shadow-sm fw-bold" onclick="openAddModal()">
                â• Ø£Ø±Ø´ÙŠÙ ÙŠØ¯ÙˆÙŠ
            </button>
            <a href="{{ url_for('recruitment_jobs') }}"
                class="btn btn-outline-light rounded-pill px-4 shadow-sm fw-bold">
                â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù
            </a>
        </div>
    </div>

    <div class="glass-panel mb-4">
        <h5 class="fw-bold mb-3 text-warning">ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (HR Insights)</h5>
        <div class="row g-3">
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="fs-1 mb-1">ğŸ“‚</div>
                    <div class="stat-value text-white" id="statTotal">0</div>
                    <div class="stat-label text-white-50">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤Ø±Ø´ÙÙŠÙ†</div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="fs-1 mb-1">ğŸ¢</div>
                    <div class="stat-value text-warning" id="statTopDept">-</div>
                    <div class="stat-label text-white-50">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙƒØ«Ø± Ø£Ø±Ø´ÙØ© (ØªÙ†Ø¨ÙŠÙ‡)</div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="fs-1 mb-1">ğŸ†”</div>
                    <div class="stat-value text-danger" id="statNoID">0</div>
                    <div class="stat-label text-white-50">Ù†Ø§Ù‚ØµÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel py-3 mb-4">
        <div class="row g-3 align-items-center">
            <div class="col-md-8">
                <input type="text" id="archiveSearch" class="form-control search-glass"
                    placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...">
            </div>
            <div class="col-md-4">
                <select id="deptFilter" class="form-select select-glass">
                    <option value="">ğŸ¢ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                    {% set depts = [] %}
                    {% for c in candidates %}
                    {% if c.DEPTNAME and c.DEPTNAME not in depts %}
                    {% set _ = depts.append(c.DEPTNAME) %}
                    {% endif %}
                    {% endfor %}
                    {% for d in depts %}
                    <option value="{{ d }}">{{ d }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="glass-panel p-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-glass text-center">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>ğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
                        <th>Ø§Ù„ÙˆØ¸ÙŠÙØ© / Ø§Ù„Ù‚Ø³Ù…</th>
                        <th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</th>
                        <th>Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (ØªÙ‚Ø¯ÙŠÙ…/ØªØ¹ÙŠÙŠÙ†/Ø¥Ù†Ù‡Ø§Ø¡)</th>
                        <th>Ø¢Ø®Ø± Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="archiveTableBody">
                    {% for c in candidates %}
                    <tr data-dept="{{ c.DEPTNAME or '' }}" data-has-id="{{ 'yes' if c.NationalID else 'no' }}">
                        <td class="fw-bold fs-6 text-white text-start align-middle">
                            ğŸ‘¤ {{ c.FullName }}
                        </td>

                        <td class="align-middle">
                            {% if c.NationalID %}
                            <span class="badge bg-light text-dark font-monospace fs-6 shadow-sm">{{ c.NationalID
                                }}</span>
                            {% else %}
                            <span class="badge bg-danger bg-opacity-75 text-white">ØºÙŠØ± Ù…Ø³Ø¬Ù„ âš ï¸</span>
                            {% endif %}
                        </td>

                        <td class="align-middle">
                            <div class="fw-bold text-warning">{{ c.JobTitle }}</div>
                            <small class="text-white-50">{{ c.DEPTNAME or 'Ø¹Ø§Ù…' }}</small>
                        </td>

                        <td class="text-start align-middle">
                            <div class="small">ğŸ“ {{ c.Phone }}</div>
                            {% if c.Email %}<div class="small text-white-50">ğŸ“§ {{ c.Email }}</div>{% endif %}
                        </td>

                        <td class="text-white-50 align-middle">
                            <div class="small">ğŸ“¥ {{ c.ApplicationDate.strftime('%Y-%m-%d') }}</div>
                            {% if c.HireDate %}<div class="small text-success">âœ… {{ c.HireDate.strftime('%Y-%m-%d') }}
                            </div>{% endif %}
                            {% if c.EndDate %}<div class="small text-danger">âŒ {{ c.EndDate.strftime('%Y-%m-%d') }}
                            </div>{% endif %}
                        </td>

                        <td class="text-white-50 fst-italic small align-middle" style="max-width: 200px;">
                            "{{ c.LastNote or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}"
                        </td>

                        <td class="align-middle">
                            <form action="{{ url_for('restore_candidate') }}" method="POST" class="d-inline"
                                onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø´Ø­ØŸ');">
                                <input type="hidden" name="candidate_id" value="{{ c.CandidateID }}">
                                <button type="submit" class="btn btn-sm btn-restore rounded-pill px-3 fw-bold"
                                    title="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                                    â™»ï¸ Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="py-5 text-white-50">
                            <div class="fs-1 mb-2">ğŸ“­</div>
                            Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // === 1. Stats Calculation (Offline Analysis) ===
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('#archiveTableBody tr');
        let total = 0;
        let missingID = 0;
        let deptCounts = {};

        // Loop only through valid data rows (ignore 'empty' message row)
        rows.forEach(row => {
            if (row.querySelector('td').innerText.includes('Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº')) return;

            total++;

            // Check ID
            if (row.getAttribute('data-has-id') === 'no') missingID++;

            // Count Depts
            let dept = row.getAttribute('data-dept') || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            deptCounts[dept] = (deptCounts[dept] || 0) + 1;
        });

        // Find Top Dept
        let topDept = '-';
        let maxCount = 0;
        for (const [dept, count] of Object.entries(deptCounts)) {
            if (count > maxCount) {
                maxCount = count;
                topDept = dept;
            }
        }

        // Update Dashboard
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statNoID').innerText = missingID;
        document.getElementById('statTopDept').innerText = topDept + ` (${maxCount})`;
    });

    // === 2. Combined Search & Filter Script ===
    const searchInput = document.getElementById('archiveSearch');
    const deptFilter = document.getElementById('deptFilter');
    const tableRows = document.querySelectorAll('#archiveTableBody tr');

    function filterData() {
        const searchValue = searchInput.value.toLowerCase();
        const deptValue = deptFilter.value;

        tableRows.forEach(row => {
            if (row.innerText.includes('Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙØ§Ø±Øº')) return;

            const rowText = row.innerText.toLowerCase();
            const rowDept = row.getAttribute('data-dept');

            const matchesSearch = rowText.includes(searchValue);
            const matchesDept = (deptValue === "") || (rowDept === deptValue);

            if (matchesSearch && matchesDept) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('keyup', filterData);
    deptFilter.addEventListener('change', filterData);

    // === Manual Add Modal ===
    function openAddModal() {
        document.getElementById('manualAddModal').style.display = 'flex';
    }
    function closeAddModal() {
        document.getElementById('manualAddModal').style.display = 'none';
    }
</script>

<!-- Manual Add Modal -->
<div id="manualAddModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9999; align-items: center; justify-content: center;">
    <div class="glass-panel"
        style="width: 500px; max-width: 90%; background: #212529; border: 1px solid rgba(255,255,255,0.15);">
        <h4 class="text-warning mb-4 fw-bold">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø£Ø±Ø´ÙŠÙ ÙŠØ¯ÙˆÙŠØ§Ù‹</h4>

        <form action="{{ url_for('recruitment_archive_add') }}" method="POST">
            <div class="mb-3">
                <label class="text-white-50 small mb-1">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ <span class="text-danger">*</span></label>
                <input type="text" name="fullname" class="form-control search-glass" required>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="text-white-50 small mb-1">Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="text" name="phone" class="form-control search-glass">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-white-50 small mb-1">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                    <input type="text" name="national_id" class="form-control search-glass">
                </div>
            </div>

            <div class="mb-3">
                <label class="text-white-50 small mb-1">Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <select name="job_id" class="form-select select-glass">
                    <option value="">-- Ø¨Ø¯ÙˆÙ† ÙˆØ¸ÙŠÙØ© Ù…Ø­Ø¯Ø¯Ø© --</option>
                    {% for job in jobs %}
                    <option value="{{ job.JobID }}">{{ job.JobTitle }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="text-white-50 small mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† (Hire Date)</label>
                    <input type="date" name="hire_date" class="form-control search-glass">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="text-white-50 small mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡ (Fire Date)</label>
                    <input type="date" name="end_date" class="form-control search-glass">
                </div>
            </div>

            <div class="mb-3">
                <label class="text-white-50 small mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø±Ø´ÙØ©</label>
                <textarea name="note" class="form-control search-glass" rows="2"></textarea>
            </div>

            <div class="d-flex gap-2 mt-4">
                <button type="submit" class="btn btn-warning fw-bold flex-grow-1">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                <button type="button" class="btn btn-outline-light flex-grow-1" onclick="closeAddModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}