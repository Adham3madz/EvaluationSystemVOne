{% extends "layout.html" %}
{% block title %}ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ{% endblock %}

{% block content %}
<style>
    /* === Global Glass Panel === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        /* Frosted White */
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 20px;
        height: 100%;
        /* Ensure full height for grids */
        transition: transform 0.3s ease;
    }

    .glass-panel:hover {
        transform: translateY(-3px);
        background: rgba(255, 255, 255, 0.85);
    }

    /* === Header === */
    .page-title {
        color: #fff;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        font-weight: 800;
        margin-bottom: 25px;
    }

    /* === Stat Cards (Tinted Glass) === */
    .glass-stat {
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        color: #fff;
        position: relative;
        overflow: hidden;
    }

    .stat-blue {
        background: linear-gradient(135deg, rgba(13, 110, 253, 0.8), rgba(13, 110, 253, 0.4));
    }

    .stat-green {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.8), rgba(25, 135, 84, 0.4));
    }

    .stat-yellow {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 193, 7, 0.5));
        color: #333;
        /* Dark text for yellow card */
    }

    .stat-icon {
        font-size: 3rem;
        opacity: 0.3;
        position: absolute;
        top: 10px;
        left: 15px;
        /* RTL visual adjustment */
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
    }

    .stat-label {
        text-transform: uppercase;
        font-size: 0.85rem;
        font-weight: 700;
        opacity: 0.9;
    }

    /* === Section Headers inside Glass === */
    .glass-header {
        font-weight: 700;
        color: #0b66b2;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        padding-bottom: 10px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* === Rejection List Styling === */
    .log-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 300px;
        overflow-y: auto;
    }

    .log-item {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 10px;
        border-right: 4px solid #dc3545;
        /* Red indicator for rejection */
        transition: background 0.2s;
    }

    .log-item:hover {
        background: rgba(255, 255, 255, 0.9);
    }

    /* Scrollbar for Glass */
    ::-webkit-scrollbar {
        width: 6px;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }
</style>

<div class="container-fluid py-4">

    <h2 class="page-title">ğŸ“Š Ø±Ø¤Ù‰ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙˆØ¸ÙŠÙ</h2>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="glass-stat stat-blue">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="text-end">
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</div>
                    <div class="stat-value">{{ total_candidates }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-stat stat-green">
                <div class="stat-icon">ğŸ¤</div>
                <div class="text-end">
                    <div class="stat-label">ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ù…</div>
                    <div class="stat-value">{{ total_hired }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-stat stat-yellow">
                <div class="stat-icon">ğŸ’¼</div>
                <div class="text-end">
                    <div class="stat-label">Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
                    <div class="stat-value">{{ open_positions }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-stat"
                style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.8), rgba(220, 53, 69, 0.4));">
                <div class="stat-icon">â±ï¸</div>
                <div class="text-end">
                    <div class="stat-label">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„ØªØ¹ÙŠÙŠÙ†</div>
                    <div class="stat-value">{{ avg_hire_time }} <span class="fs-6">ÙŠÙˆÙ…</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="glass-panel">
                <div class="glass-header">
                    <span>ğŸ“ˆ</span> Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… (Ø¢Ø®Ø± 6 Ø´Ù‡ÙˆØ±)
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">

        <div class="col-md-8">
            <div class="glass-panel">
                <div class="glass-header">
                    <span>ğŸ¢</span> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª (Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† vs Ù…Ø±ÙÙˆØ¶ÙŠÙ† vs ØªØ¹ÙŠÙŠÙ†)
                </div>
                <div style="position: relative; height: 300px;">
                    <canvas id="deptChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="glass-panel">
                <div class="glass-header text-danger">
                    <span>âš ï¸</span> Ø£Ø­Ø¯Ø« Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø±ÙØ¶
                </div>
                <ul class="log-list">
                    {% for log in rejection_logs %}
                    <li class="log-item">
                        <div class="d-flex justify-content-between text-muted small mb-1">
                            <span>{{ log.JobTitle }}</span>
                            <span>{{ log.ActionDate.strftime('%Y-%m-%d') }}</span>
                        </div>
                        <div class="fw-bold text-dark mb-1">"{{ log.Note }}"</div>
                        <span class="badge bg-secondary bg-opacity-25 text-dark border">{{ log.DEPTNAME or 'Ø¹Ø§Ù…'
                            }}</span>
                    </li>
                    {% else %}
                    <li class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø±ÙØ¶ Ù…Ø³Ø¬Ù„Ø©.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-8">
            <div class="glass-panel">
                <div class="glass-header">
                    <span>ğŸ“Œ</span> Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙˆØ¸ÙŠÙ (Pipeline)
                </div>
                <div style="position: relative; height: 250px;">
                    <canvas id="pipelineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="glass-panel">
                <div class="glass-header">
                    <span>ğŸŒ</span> Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
                </div>
                <div style="position: relative; height: 250px; display: flex; justify-content: center;">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<script>
    // === Chart.js Global Config for Glass Theme ===
    Chart.defaults.color = '#333';
    Chart.defaults.font.family = "'Tajawal', 'Segoe UI', sans-serif";
    Chart.defaults.scale.grid.color = 'rgba(0, 0, 0, 0.05)';

    // --- 1. Department Chart ---
    const ctxDept = document.getElementById('deptChart').getContext('2d');
    new Chart(ctxDept, {
        type: 'bar',
        data: {
            labels: {{ analytics.depts.labels | safe }},
        datasets: [
        {
            label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†',
            data: {{ analytics.depts.total | safe }},
        backgroundColor: 'rgba(108, 117, 125, 0.7)',
        borderColor: '#6c757d',
        borderWidth: 1
        },
        {
            label: 'ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ†',
            data: {{ analytics.depts.hired | safe }},
        backgroundColor: 'rgba(25, 135, 84, 0.7)',
        borderColor: '#198754',
        borderWidth: 1
        },
        {
            label: 'Ù…Ø±ÙÙˆØ¶',
            data: {{ analytics.depts.rejected | safe }},
        backgroundColor: 'rgba(220, 53, 69, 0.7)',
        borderColor: '#dc3545',
        borderWidth: 1
        }
    ]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
    }
    });

    // --- 2. Pipeline Chart ---
    const ctxPipeline = document.getElementById('pipelineChart').getContext('2d');
    new Chart(ctxPipeline, {
        type: 'bar',
        data: {
            labels: {{ analytics.stages.labels | safe }},
        datasets: [{
            label: 'Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†',
            data: {{ analytics.stages.data | safe }},
        backgroundColor: 'rgba(13, 110, 253, 0.7)',
        borderColor: '#0d6efd',
        borderWidth: 1,
        borderRadius: 5
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
    }
    });

    // --- 3. Source Chart ---
    const ctxSource = document.getElementById('sourceChart').getContext('2d');
    new Chart(ctxSource, {
        type: 'doughnut',
        data: {
            labels: {{ analytics.sources.labels | safe }},
        datasets: [{
            data: {{ analytics.sources.data | safe }},
        backgroundColor: ['#20c997', '#ffc107', '#0dcaf0', '#6610f2'],
        borderColor: '#fff',
        borderWidth: 2,
        hoverOffset: 4
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'right', labels: { boxWidth: 15 } }
        }
    }
    });

    // --- 4. Monthly Trend Chart ---
    const ctxTrend = document.getElementById('trendChart').getContext('2d');
    new Chart(ctxTrend, {
        type: 'line',
        data: {
            labels: {{ analytics.trend.labels | safe }},
        datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†',
            data: {{ analytics.trend.data | safe }},
        borderColor: '#6c757d', /* Grey line */
        backgroundColor: 'rgba(108, 117, 125, 0.2)', /* Light grey fill */
        borderWidth: 3,
        tension: 0.4,
        fill: true,
        pointBackgroundColor: '#6c757d',
        pointRadius: 5
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#333' } },
            x: { grid: { display: false }, ticks: { color: '#333' } }
        }
    }
    });
</script>
{% endblock %}