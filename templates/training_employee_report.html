{% extends "layout.html" %}
{% block title %}ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
    /* === Glass Panel === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    /* === KPI Cards === */
    .kpi-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(224, 247, 250, 0.6));
        border: 1px solid rgba(13, 202, 240, 0.3);
        border-radius: 16px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(13, 202, 240, 0.2);
    }
    .kpi-icon { font-size: 2rem; margin-bottom: 8px; }
    .kpi-value { font-size: 1.8rem; font-weight: 800; color: #055160; }
    .kpi-label { font-size: 0.85rem; font-weight: 700; color: #666; }

    /* === Header === */
    .page-title {
        color: #fff;
        text-shadow: 0 2px 5px rgba(0,0,0,0.4);
        font-weight: 800;
    }

    /* === Inputs & Buttons === */
    .form-control, .form-select {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 8px;
        color: #333;
    }
    .form-control:focus, .form-select:focus {
        background: #fff;
        box-shadow: 0 0 0 3px rgba(11, 102, 178, 0.2);
        border-color: #0b66b2;
    }

    .btn-glass-primary {
        background: linear-gradient(135deg, #004d7a, #0b66b2);
        color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold;
    }
    .btn-glass-secondary {
        background: rgba(108, 117, 125, 0.8); color: white;
        border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(4px);
    }

    /* === Table === */
    .table-custom { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 0; }
    .table-custom thead th {
        background: linear-gradient(135deg, #004d7a, #0b66b2);
        color: #fff; padding: 15px; border: none; font-weight: 600; text-align: center;
    }
    .table-custom thead th:first-child { border-top-right-radius: 10px; }
    .table-custom thead th:last-child { border-top-left-radius: 10px; }
    .table-custom tbody td {
        background-color: transparent; padding: 12px;
        border-bottom: 1px solid rgba(0,0,0,0.05); color: #333; vertical-align: middle;
    }
    .table-custom tbody tr:hover td { background-color: rgba(11, 102, 178, 0.08); }

    /* === Details Row === */
    .details-row { background-color: rgba(240, 240, 240, 0.5) !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    .details-card { background: transparent; border: 1px solid rgba(0,0,0,0.1); border-radius: 10px; overflow: hidden; }
    .details-header { background: rgba(13, 202, 240, 0.2); color: #055160; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid rgba(0,0,0,0.05); }

    /* === Print === */
    @media print {
        body { background: white !important; }
        .bg-animation, .bg-overlay, .btn, form { display: none !important; }
        .glass-panel { box-shadow: none; border: none; background: white; backdrop-filter: none; padding: 0; }
        .page-title { color: #000; text-shadow: none; }
        .collapse { display: block !important; height: auto !important; opacity: 1 !important; visibility: visible !important; }
        .table-custom thead th { background: #333 !important; color: white !important; }
        .kpi-card { border: 1px solid #ccc; background: white; }
    }
</style>

<div class="container-fluid mt-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title">ğŸ“ ØªÙ‚Ø±ÙŠØ± ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
        <div>
            <button class="btn btn-glass-secondary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
    </div>

    <div class="row g-4 mb-4" id="analyticsSection" style="display: none;">
        <div class="col-md-2">
            <div class="kpi-card">
                <div class="kpi-icon">ğŸ‘¨â€ğŸ’¼</div>
                <div class="kpi-value" id="kpiTotalEmployees">0</div>
                <div class="kpi-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card" style="border-color: rgba(25, 135, 84, 0.3);">
                <div class="kpi-icon">ğŸ“š</div>
                <div class="kpi-value" id="kpiTotalCourses">0</div>
                <div class="kpi-label">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="kpi-card" style="border-color: rgba(255, 193, 7, 0.3);">
                <div class="kpi-icon">ğŸ“ˆ</div>
                <div class="kpi-value text-success" id="kpiSuccessRate">0%</div>
                <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">Ø§Ù„Ù†Ø´Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h6>
                <div style="height: 100px; width: 100%;">
                    <canvas id="deptChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª</h6>
                <div style="height: 100px; width: 100px;">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-panel">
        <form method="GET" action="{{ url_for('training_employee_report') }}" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Ø¨Ø­Ø« (Ø§Ø³Ù… / Ø±Ù‚Ù… ÙˆØ¸ÙŠÙÙŠ)</label>
                <input type="text" name="search" class="form-control" placeholder="Ø¨Ø­Ø«..." value="{{ filters.get('search', '') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
                <select name="dept_id" class="form-select">
                    <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                    {% for dept in all_depts %}
                    <option value="{{ dept.DEPTID }}" {% if filters.get('dept_id') and filters.get('dept_id')|int == dept.DEPTID %}selected{% endif %}>
                        {{ dept.DEPTNAME }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Ø¯ÙˆØ±Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ù…Ø­Ø¯Ø¯Ø©</label>
                <select name="course_id" class="form-select">
                    <option value="">-- ÙƒÙ„ Ø§Ù„Ø¯ÙˆØ±Ø§Øª --</option>
                    {% for course in all_courses %}
                    <option value="{{ course.TrainingCourseID }}" {% if filters.get('course_id') and filters.get('course_id')|int == course.TrainingCourseID %}selected{% endif %}>
                        {{ course.TrainingCourseText }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                <input type="date" name="date_from" class="form-control" value="{{ filters.get('date_from', '') }}">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-glass-primary w-100">ğŸ”</button>
            </div>
        </form>
    </div>

    <div class="glass-panel p-0">
        <div class="table-responsive">
            <table class="table table-custom mb-0">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th class="text-end">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th class="text-end">Ø§Ù„Ù‚Ø³Ù…</th>
                        <th class="text-center">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</th>
                        <th class="text-center">Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                        <th class="text-center">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody>
                    {% if employees %}
                        {% for uid, data in employees.items() %}
                        <tr class="employee-data-row cursor-pointer" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse{{ uid }}" 
                            
                            data-dept="{{ data.info.dept or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}"
                            data-total="{{ data.stats.total }}"
                            data-passed="{{ data.stats.passed }}"
                            data-failed="{{ data.stats.failed }}"
                            
                            style="cursor: pointer;">
                            
                            <td class="text-center">
                                <div class="rounded-circle bg-secondary bg-opacity-75 text-white d-flex justify-content-center align-items-center mx-auto shadow-sm" style="width: 40px; height: 40px;">
                                    {{ data.info.name[:1] }}
                                </div>
                            </td>
                            <td>
                                <div class="fw-bold text-primary">{{ data.info.name }}</div>
                                <small class="text-muted">{{ data.info.title or '' }}</small>
                            </td>
                            <td>
                                <span class="badge bg-secondary bg-opacity-10 text-dark border">{{ data.info.dept or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-primary fs-6">{{ data.stats.total }}</span>
                            </td>
                            <td class="text-center">
                                {% if data.stats.passed > 0 %}
                                    <span class="badge bg-success bg-opacity-75">{{ data.stats.passed }} âœ…</span>
                                {% endif %}
                                {% if data.stats.failed > 0 %}
                                    <span class="badge bg-danger bg-opacity-75">{{ data.stats.failed }} âŒ</span>
                                {% endif %}
                                {% if data.stats.total == 0 %} <span class="text-muted">-</span> {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-info rounded-pill px-3">â¬‡ï¸ Ø¹Ø±Ø¶</button>
                            </td>
                        </tr>

                        <tr class="collapse details-row" id="collapse{{ uid }}">
                            <td colspan="6" class="p-4">
                                {% if data.courses %}
                                <div class="details-card bg-white">
                                    <div class="details-header">
                                        ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ: {{ data.info.name }}
                                    </div>
                                    <div class="card-body p-0">
                                        <table class="table table-sm table-striped mb-0 text-center">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</th>
                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                    <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                                    <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                                                    <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for course in data.courses %}
                                                <tr>
                                                    <td class="text-start ps-3 fw-bold text-dark">{{ course.course_name }}</td>
                                                    <td>{{ course.date|format_date }}</td>
                                                    <td>{{ course.attendance or '-' }}</td>
                                                    <td>
                                                        {% if course.grade %} <span class="fw-bold text-primary">{{ course.grade }}%</span>
                                                        {% else %} <span class="text-muted small">N/A</span> {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if course.status == 'Passed' %} <span class="badge bg-success">Passed</span>
                                                        {% elif course.status == 'Failed' %} <span class="badge bg-danger">Failed</span>
                                                        {% elif course.status == 'Registered' %} <span class="badge bg-warning text-dark">Upcoming</span>
                                                        {% else %} <span class="badge bg-secondary">{{ course.status }}</span> {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                {% else %}
                                    <div class="alert alert-warning mb-0 shadow-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h4>
                                <p class="text-muted small">Ø­Ø§ÙˆÙ„ ØªØºÙŠÙŠØ± Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«.</p>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // === Safe Data Extraction (DOM Method) ===
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        
        const rows = document.querySelectorAll('.employee-data-row');
        
        let totalEmployees = 0;
        let totalCourses = 0;
        let totalPassed = 0;
        let totalFailed = 0;
        let totalOthers = 0;
        const deptCounts = {};

        rows.forEach(row => {
            totalEmployees++;
            
            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø³Ù…Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©
            const courses = parseInt(row.getAttribute('data-total')) || 0;
            const passed = parseInt(row.getAttribute('data-passed')) || 0;
            const failed = parseInt(row.getAttribute('data-failed')) || 0;
            const dept = row.getAttribute('data-dept');

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            totalCourses += courses;
            totalPassed += passed;
            totalFailed += failed;
            
            // Ø­Ø³Ø§Ø¨ "Ø£Ø®Ø±Ù‰" (Ù…Ø³Ø¬Ù„ ÙˆÙ„Ù… ÙŠÙ†ØªÙ‡ Ø¨Ø¹Ø¯)
            let others = courses - (passed + failed);
            if (others > 0) totalOthers += others;

            // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
            deptCounts[dept] = (deptCounts[dept] || 0) + courses;
        });

        // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        if (totalEmployees === 0) return;

        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        document.getElementById('analyticsSection').style.display = 'flex';

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª (KPIs)
        document.getElementById('kpiTotalEmployees').innerText = totalEmployees;
        document.getElementById('kpiTotalCourses').innerText = totalCourses;
        const rate = totalCourses > 0 ? Math.round((totalPassed / totalCourses) * 100) : 0;
        document.getElementById('kpiSuccessRate').innerText = rate + "%";

        // --- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 1: Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª (Doughnut) ---
        new Chart(document.getElementById('statusChart'), {
            type: 'doughnut',
            data: {
                labels: ['Ù†Ø§Ø¬Ø­', 'Ø±Ø§Ø³Ø¨', 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°'],
                datasets: [{
                    data: [totalPassed, totalFailed, totalOthers],
                    backgroundColor: ['#198754', '#dc3545', '#ffc107'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '70%'
            }
        });

        // --- Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 2: Ø§Ù„Ù†Ø´Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… (Bar) ---
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹ Ù„Ù„Ø£Ù‚Ù„
        const sortedDepts = Object.entries(deptCounts)
                                  .sort((a,b) => b[1] - a[1])
                                  .slice(0, 5); // Ø¹Ø±Ø¶ Ø£Ø¹Ù„Ù‰ 5 ÙÙ‚Ø·

        new Chart(document.getElementById('deptChart'), {
            type: 'bar',
            data: {
                labels: sortedDepts.map(i => i[0]),
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙˆØ±Ø§Øª',
                    data: sortedDepts.map(i => i[1]),
                    backgroundColor: '#0b66b2',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false }, 
                    y: { display: false, beginAtZero: true } 
                }
            }
        });
    });
</script>
{% endblock %}