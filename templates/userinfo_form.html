<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù' if action == 'Add' else 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù' }} - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fontawesome.css') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cairo.css') }}">

    <script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

    <style>
        body {
            background-color: #f0f2f5;
            font-family: "Tajawal", sans-serif;
        }

        .container {
            max-width: 900px;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        .page-header {
            background: linear-gradient(135deg, #004d7a, #00608f);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 77, 122, 0.2);
        }
        .page-header h2 {
            margin: 0;
            font-weight: 700;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            padding: 30px;
            margin-bottom: 25px;
            background-color: #ffffff;
        }

        .form-label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            padding: 12px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #004d7a;
            box-shadow: 0 0 0 4px rgba(0, 77, 122, 0.1);
        }

        /* Checkbox Styling */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background-color: #e3f2fd;
            border-color: #90caf9;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-left: 10px;
            accent-color: #004d7a;
        }

        .checkbox-item label {
            margin-bottom: 0;
            cursor: pointer;
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .btn-success {
            background-color: #2e7d32;
            border: none;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
        }
        .btn-success:hover { background-color: #1b5e20; transform: translateY(-2px); }

        .btn-warning {
            background-color: #f9a825;
            color: #fff;
            border: none;
            box-shadow: 0 4px 15px rgba(249, 168, 37, 0.2);
        }
        .btn-warning:hover { background-color: #f57f17; color: #fff; transform: translateY(-2px); }

        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
            border: none;
        }
        .btn-secondary:hover { background-color: #bdbdbd; }

        /* Image Upload Section */
        .img-upload-card {
            text-align: center;
            background-color: #fcfcfc;
            border: 2px dashed #dbe4eb;
        }
        .img-upload-card h3 {
            font-size: 18px;
            color: #555;
            margin-bottom: 20px;
        }
        .current-img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

    <div class="container">
        
        <div class="page-header">
            <h2>{{ 'ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯' if action == 'Add' else 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù' }}</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} text-center shadow-sm" style="border-radius: 10px;">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>

        <div class="card">
            <form method="POST" onsubmit="return validateForm()">
                <div class="row g-4">
                    
                    <div class="col-12">
                        <h5 class="text-muted mb-3" style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h5>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" value="{{ user.NAME if user else '' }}" required placeholder="Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                        <select class="form-select" name="gender">
                            <option value="">-- Ø§Ø®ØªØ± --</option>
                            <option value="M" {% if user and user.GENDER=='M' %}selected{% endif %}>Ø°ÙƒØ±</option>
                            <option value="F" {% if user and user.GENDER=='F' %}selected{% endif %}>Ø£Ù†Ø«Ù‰</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</label>
                        <input type="text" name="ssn" class="form-control" value="{{ user.SSN if user else '' }}">
                    </div>

                    <div class="col-12 mt-4">
                        <h5 class="text-muted mb-3" style="border-bottom: 2px solid #f0f0f0; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙØ©</h5>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                        <input type="text" name="badgenumber" class="form-control" value="{{ user.BADGENUMBER if user else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
                        <select class="form-select" name="defaultdept" id="dept_select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… --</option>
                            {% for d in depts %}
                            <option value="{{ d.DEPTID }}" {% if user and user.DEFAULTDEPTID==d.DEPTID %}selected{% endif %}>
                                {{ d.DEPTNAME }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                        <select class="form-select" name="positionid" id="position_select">
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ù…Ù‰ --</option>
                            {% for p in positions %}
                            <option value="{{ p.PositionID }}" {% if user and user.PositionID==p.PositionID %}selected{% endif %}>
                                {{ p.PositionName }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-12 mt-4">
                        <label class="form-label mb-2">ØªØµÙ†ÙŠÙ Ø§Ù„Ù…ÙˆØ¸Ù (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ÙØ¦Ø©)</label>
                        <div class="checkbox-grid">
                            <div class="checkbox-item">
                                <input type="checkbox" id="level_a" name="employee_levels" value="A" {% if user and user.employee_class and 'A' in user.employee_class %}checked{% endif %}>
                                <label for="level_a">A - Ù…ÙˆØ¸Ù Ø¥Ø¯Ø§Ø±ÙŠ</label>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="level_b" name="employee_levels" value="B" {% if user and user.employee_class and 'B' in user.employee_class %}checked{% endif %}>
                                <label for="level_b">B - Ù…ÙˆØ¸Ù ÙÙ†ÙŠ</label>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="level_c" name="employee_levels" value="C" {% if user and user.employee_class and 'C' in user.employee_class %}checked{% endif %}>
                                <label for="level_c">C - ÙØ¦Ø© Ø¬</label>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="level_supervisor" name="employee_levels" value="Ù…Ø´Ø±Ù" {% if user and user.employee_class and 'Ù…Ø´Ø±Ù' in user.employee_class %}checked{% endif %}>
                                <label for="level_supervisor">Ù…Ø´Ø±Ù</label>
                            </div>

                            <div class="checkbox-item">
                                <input type="checkbox" id="level_manager" name="employee_levels" value="Ù…Ø¯ÙŠØ±" {% if user and user.employee_class and 'Ù…Ø¯ÙŠØ±' in user.employee_class %}checked{% endif %}>
                                <label for="level_manager">Ù…Ø¯ÙŠØ±</label>
                            </div>
                        </div>
                        <div id="levelsError" class="text-danger mt-2 small" style="display: none;">
                            <i class="bi bi-exclamation-circle"></i> ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                        </div>
                    </div>

                    <div class="col-12 mt-5 d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <a href="{{ url_for('userinfo_list') }}" class="btn btn-secondary">
                            Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                        </a>
                        
                        {% if action == 'Add' %}
                        <button type="submit" class="btn btn-success px-5">
                            Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-warning px-5">
                            Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                        </button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>

        {% if action == 'Edit' %}
        <div class="card img-upload-card">
            <h3>ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
            <div class="d-flex flex-column align-items-center">
                <img src="{{ url_for('user_pic', user_id=user.USERID) }}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù" class="current-img">
                
                <form action="{{ url_for('upload_pic', user_id=user.USERID) }}" method="POST" enctype="multipart/form-data" class="w-100" style="max-width: 400px;">
                    <div class="input-group mb-3">
                        <input type="file" class="form-control" name="user_pic" id="user_pic" accept="image/png, image/jpeg">
                        <button class="btn btn-primary" type="submit">Ø±ÙØ¹</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="text-center text-muted mt-4 mb-5">
            <small>Â© 2025 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</small>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function validateForm() {
            const checkboxes = document.querySelectorAll('input[name="employee_levels"]:checked');
            const errorDiv = document.getElementById('levelsError');
            
            if (checkboxes.length === 0) {
                errorDiv.style.display = 'block';
                errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            } else {
                errorDiv.style.display = 'none';
            }

            const confirmed = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ");
            if (confirmed) {
                const toast = new bootstrap.Toast(document.getElementById('successToast'));
                toast.show();
            }
            return confirmed;
        }

        document.querySelectorAll('input[name="employee_levels"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="employee_levels"]:checked');
                const errorDiv = document.getElementById('levelsError');
                if (checkboxes.length > 0) {
                    errorDiv.style.display = 'none';
                }
            });
        });

        // Auto-update position dropdown based on department
        document.addEventListener('DOMContentLoaded', function() {
            const deptSelect = document.getElementById('dept_select');
            const positionSelect = document.getElementById('position_select');
            const allPositions = {{ positions|tojson|safe }};
            const originalPositionId = positionSelect.value;

            function updatePositionOptions() {
                const selectedDeptId = deptSelect.value;
                positionSelect.innerHTML = '';

                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.text = '-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ù…Ù‰ --';
                positionSelect.appendChild(defaultOption);

                allPositions.forEach(pos => {
                    if (pos.DeptID == selectedDeptId) {
                        const option = document.createElement('option');
                        option.value = pos.PositionID;
                        option.text = pos.PositionName;
                        positionSelect.appendChild(option);
                    }
                });
                
                if (originalPositionId) {
                    const exists = Array.from(positionSelect.options).some(opt => opt.value == originalPositionId);
                    if (exists) positionSelect.value = originalPositionId;
                }
            }

            deptSelect.addEventListener('change', updatePositionOptions);
            updatePositionOptions();
        });
    </script>

</body>
</html>