{% extends "layout.html" %}
{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">ğŸ“ {{ training_session.TrainingCourseText }}</h4>
            <span class="text-muted">
                {{ training_session.SessionDate }} 
                {% if training_session.EndDate %} - {{ training_session.EndDate }} {% endif %}
            </span>
        </div>
        <div>
            <a class="btn btn-secondary me-2" href="{{ url_for('training_session_print', sid=training_session.SessionID) }}" target="_blank">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</a>
            <a class="btn btn-primary" href="{{ url_for('training_enroll', sid=training_session.SessionID) }}">â• ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø§Ø¨</a>
        </div>
    </div>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item">
            <button class="nav-link active fw-bold" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                ğŸ“… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø£ÙŠØ§Ù…)
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="attendance-tab" data-bs-toggle="tab" data-bs-target="#attendance" type="button">
                âœ… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link fw-bold" id="grading-tab" data-bs-toggle="tab" data-bs-target="#grading" type="button">
                ğŸ“Š Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">

        <div class="tab-pane fade show active" id="schedule">
            <div class="card shadow-sm p-4">
                <h5 class="fw-bold text-primary mb-3">ğŸ› ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ø£ÙˆÙ‚Ø§Øª</h5>
                
                <form method="POST" action="{{ url_for('training_day_add', sid=training_session.SessionID) }}" class="row g-2 align-items-end mb-4 bg-light p-3 rounded border">
                    <div class="col-md-3">
                        <label class="small fw-bold">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                        <input type="date" name="day_date" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">Ù…Ù†</label>
                        <input type="time" name="start_time" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label class="small fw-bold">Ø¥Ù„Ù‰</label>
                        <input type="time" name="end_time" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Topic)</label>
                        <input type="text" name="topic" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‚Ø¯Ù…Ø©">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100">â• Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                </form>

                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                            <th>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</th>
                            <th class="text-center">Ø­Ø°Ù</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for day in session_days %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td class="fw-bold">{{ day.DayDate }}</td>
                            <td>
                                {% if day.StartTime %}{{ day.StartTime }}{% endif %} 
                                {% if day.EndTime %} - {{ day.EndTime }}{% endif %}
                            </td>
                            <td>{{ day.Topic or '-' }}</td>
                            <td class="text-center">
                                <form method="POST" action="{{ url_for('training_day_delete', did=day.DayID) }}" onsubmit="return confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø£ÙŠØ¶Ø§Ù‹.')">
                                    <button class="btn btn-sm btn-outline-danger border-0"><i class="fa-solid fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center text-muted py-3">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠØ§Ù… Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="attendance">
            <div class="card shadow-sm p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="fw-bold text-success">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
                    <button form="attendanceForm" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
                </div>

                {% if session_days and enrollments %}
                <form id="attendanceForm" method="POST" action="{{ url_for('training_attendance_save', sid=training_session.SessionID) }}">
                    <div class="table-responsive">
                        <table class="table table-bordered text-center align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 200px; position: sticky; left: 0; z-index: 10;">Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                    {% for day in session_days %}
                                        <th>
                                            <span style="font-size: 12px; display:block;">{{ day.DayDate }}</span>
                                            <small class="text-muted" style="font-size: 10px;">{{ day.Topic or 'Day ' ~ loop.index }}</small>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in enrollments %}
                                <tr>
                                    <td class="bg-light fw-bold text-start ps-3" style="position: sticky; left: 0;">
                                        {{ emp.NAME }}
                                    </td>

                                    {% for day in session_days %}
                                        <td>
                                            <input type="checkbox" 
                                                   name="attend_{{ day.DayID }}_{{ emp.EnrollmentID }}" 
                                                   class="form-check-input" 
                                                   style="width: 20px; height: 20px; cursor: pointer;"
                                                   {% if (day.DayID, emp.EnrollmentID) in attendance_set %}checked{% endif %}>
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% else %}
                    <div class="alert alert-warning">
                        ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© <strong>Ø£ÙŠØ§Ù… Ù„Ù„Ø¬Ø¯ÙˆÙ„</strong> Ùˆ <strong>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø§Ø¨</strong> Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙØ¹ÙŠÙ„ ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ±.
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="grading">
            <div class="card shadow-sm p-4">
                <h5 class="fw-bold mb-3">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h5>
                
                {% if enrollments %}
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                            <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                            <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± (Auto)</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for e in enrollments %}
                        <tr>
                            <td class="fw-bold">{{ e.NAME }}</td>
                            <td>{{ e.Grade or '-' }}</td>
                            <td>
                                {% if e.PassStatus == 'Passed' %}
                                    <span class="badge bg-success">Ù†Ø§Ø¬Ø­</span>
                                {% elif e.PassStatus == 'Failed' %}
                                    <span class="badge bg-danger">Ø±Ø§Ø³Ø¨</span>
                                {% elif e.PassStatus == 'Excuse' %}
                                    <span class="badge bg-warning text-dark">Ø§Ø¹ØªØ°Ø§Ø±</span>
                                {% elif e.PassStatus == 'Canceled' %}
                                    <span class="badge bg-secondary">Ù…Ù„ØºÙ‰</span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ e.AttendancePercent }}%</td>
                            <td>
                                <!-- Form Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¬Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© (Ø£Ø¶ÙÙ†Ø§ Ø®ÙŠØ§Ø± Canceled) -->
                                <form method="POST" action="{{ url_for('training_enrollment_update', eid=e.EnrollmentID) }}" class="mb-2">
                                    <div class="input-group input-group-sm">
                                        <input type="number" name="grade" class="form-control" placeholder="Score" value="{{ e.Grade }}">
                                        <select name="pass_status" class="form-select">
                                            <option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                            <option value="Passed" {% if e.PassStatus=='Passed' %}selected{% endif %}>Ù†Ø§Ø¬Ø­</option>
                                            <option value="Failed" {% if e.PassStatus=='Failed' %}selected{% endif %}>Ø±Ø§Ø³Ø¨</option>
                                            <option value="Excuse" {% if e.PassStatus=='Excuse' %}selected{% endif %}>Ø§Ø¹ØªØ°Ø§Ø±</option>
                                            <option value="Canceled" {% if e.PassStatus=='Canceled' %}selected{% endif %}>Ù…Ù„ØºÙ‰ (Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„)</option>
                                        </select>
                                        <button class="btn btn-primary btn-sm">ØªØ­Ø¯ÙŠØ«</button>
                                    </div>
                                </form>

                                <!-- Form Ø¬Ø¯ÙŠØ¯ Ù„Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙƒØ§Ù…Ù„) -->
                                <form method="POST" 
                                    action="{{ url_for('training_enrollment_delete', eid=e.EnrollmentID) }}" 
                                    onsubmit="return confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ (Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ ØªÙ…Ø§Ù…Ø§Ù‹)');"
                                    class="d-inline">
                                    <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="text-muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨.</p>
                {% endif %}
            </div>
        </div>

    </div> </div>
{% endblock %}