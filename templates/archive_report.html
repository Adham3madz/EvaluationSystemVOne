{% extends "layout.html" %}
{% block title %}ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}

{% block content %}
<style>
    .page-header { text-align: center; margin-bottom: 25px; }
    .page-header h2 { color: #1a237e; font-weight: 700; font-size: 28px; }
    
    /* Filter Styles */
    .filter-container {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .filter-label {
        font-weight: bold;
        font-size: 13px;
        color: #555;
    }

    .filter-input, .filter-select {
        padding: 10px 15px;
        border-radius: 6px;
        border: 1px solid #ddd;
        min-width: 150px; /* Slightly smaller to fit dates */
        font-size: 14px;
    }
    
    .btn-filter {
        padding: 10px 20px;
        background-color: #004d7a;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        height: 42px;
    }
    .btn-filter:hover { background-color: #003a5c; }

    .btn-modern-add {
        background: linear-gradient(135deg, #2e7d32, #1b5e20);
        color: white !important;
        padding: 12px 25px;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 700;
        font-size: 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        transition: all 0.3s ease;
        border: none;
    }
    .btn-modern-add:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(46, 125, 50, 0.4);
        background: linear-gradient(135deg, #388e3c, #2e7d32);
    }
    .btn-modern-add i { font-size: 18px; }

    /* Grid & Chart Styles */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; align-items: stretch; }
    .stat-card, .chart-card { background: #fff; border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; justify-content: flex-start; min-height: 300px; }
    .chart-wrapper { position: relative; height: 220px; width: 100%; margin-top: auto; margin-bottom: auto; }
    .stat-card h5, .chart-card h5 { font-weight: 600; color: #004d7a; text-align: center; font-size: 14px; margin-bottom: 15px; height: 30px; }
    .stat-content { flex: 1; display: flex; align-items: center; justify-content: center; }
    .stat-number { font-size: 3.5rem; font-weight: 700; color: #c62828; text-align: center; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 3px 10px rgba(0,0,0,0.07); padding: 20px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; text-align: center; min-width: 1000px; }
    th, td { padding: 12px 10px; border-bottom: 1px solid #ddd; font-size: 14px; }
    th { background: #1565c0; color: #fff; white-space: nowrap; }
    tr:hover td { background: #f1f8e9; }
    .comment-cell { max-width: 200px; white-space: pre-wrap; text-align: right; font-size: 13px; }
    
    @media (max-width: 1200px) { .stats-grid { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .stats-grid { grid-template-columns: 1fr; } .filter-container { flex-direction: column; align-items: stretch; } }
</style>

<div class="page-header">
    <h2>ğŸ—‚ï¸ ØªÙ‚Ø±ÙŠØ± Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
</div>



<div class="stats-grid">
    <div class="stat-card">
        <h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¤Ø±Ø´ÙÙŠÙ†</h5>
        <div class="stat-content"><p class="stat-number">{{ total_archived }}</p></div>
    </div>
    <div class="chart-card">
        <h5>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨</h5>
        <div class="chart-wrapper"><canvas id="reasonsChart"></canvas></div>
    </div>
    <div class="chart-card">
        <h5>ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h5>
        <div class="chart-wrapper"><canvas id="deptChart"></canvas></div>
    </div>
    <div class="chart-card">
        <h5>ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¸ÙŠÙØ©</h5>
        <div class="chart-wrapper"><canvas id="posChart"></canvas></div>
    </div>
</div>

<div style="text-align: center; margin-bottom: 20px;">
    <a href="{{ url_for('archive_manual_add') }}" class="btn-modern-add">
        <i class="fa-solid fa-folder-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø£Ø±Ø´ÙŠÙ ÙŠØ¯ÙˆÙŠØ§Ù‹
    </a>
</div>

<div class="filter-container">
    <form method="GET" action="{{ url_for('userinfo_archive_report') }}" style="display:contents;">
        
        <div class="filter-group">
            <label class="filter-label">Ø¨Ø­Ø« (Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ):</label>
            <input type="text" name="search" class="filter-input" 
                   placeholder="Ø¨Ø­Ø«..." 
                   value="{{ search_term }}">
        </div>

        <div class="filter-group">
            <label class="filter-label">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" name="date_from" class="filter-input" value="{{ date_from }}">
        </div>
        <div class="filter-group">
            <label class="filter-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" name="date_to" class="filter-input" value="{{ date_to }}">
        </div>

        <div class="filter-group">
            <label class="filter-label">Ø§Ù„Ù‚Ø³Ù…:</label>
            <select name="dept_id" class="filter-select">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for dept in all_depts %}
                <option value="{{ dept.DEPTID }}" {% if selected_dept == dept.DEPTID|string %}selected{% endif %}>
                    {{ dept.DEPTNAME }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Ø§Ù„ÙˆØ¸ÙŠÙØ©:</label>
            <select name="pos_id" class="filter-select">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for pos in all_positions %}
                <option value="{{ pos.PositionID }}" {% if selected_pos == pos.PositionID|string %}selected{% endif %}>
                    {{ pos.PositionName }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø§Ù…:</label>
            <select name="reason_id" class="filter-select">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for reason in all_reasons %}
                <option value="{{ reason.ReasonID }}" {% if selected_reason == reason.ReasonID|string %}selected{% endif %}>
                    {{ reason.ReasonText }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ:</label>
            <select name="why_id" class="filter-select">
                <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                {% for why in all_whys %}
                <option value="{{ why.WhyID }}" {% if selected_why == why.WhyID|string %}selected{% endif %}>
                    {{ why.WhyText }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group" style="justify-content: flex-end;">
             <button type="submit" class="btn-filter">ØªØ·Ø¨ÙŠÙ‚</button>
        </div>

        {% if selected_reason or selected_why or search_term or selected_dept or selected_pos or date_from or date_to %}
            <div class="filter-group" style="justify-content: flex-end;">
                <a href="{{ url_for('userinfo_archive_report') }}" class="btn btn-sm btn-secondary" style="padding: 10px 20px; height: 42px; display: flex; align-items: center;">Ù…Ø³Ø­</a>
            </div>
        {% endif %}
    </form>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø±Ù‚Ù…</th>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
        <th>Ø§Ù„Ù‚Ø³Ù…</th>
        <th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ù‡Ø§Ø¡</th>
        <th>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¹Ø§Ù…</th>
        <th>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</th>
        <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
        <th>Ø§Ø³ØªØ¹Ø§Ø¯Ø©</th>
      </tr>
    </thead>
    <tbody>
      {% for emp in archived_employees %}
      <tr>
        <td>{{ emp.UserID }}</td>
        <td style="font-weight: bold;">{{ emp.Name }}</td>
        <td>{{ emp.ArchivedSSN or '-' }}</td>
        <td>{{ emp.DEPTNAME or '-' }}</td>
        <td>{{ emp.PositionName or '-' }}</td>
        <td>{{ emp.HiredDay.strftime('%Y-%m-%d') if emp.HiredDay else '-' }}</td>
        <td style="color: #c62828;">{{ emp.EndDay.strftime('%Y-%m-%d') if emp.EndDay else '-' }}</td>
        <td>{{ emp.ReasonText or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</td>
        <td>{{ emp.WhyText or '-' }}</td>
        <td class="comment-cell">{{ emp.ArchiveComment }}</td>
        <td>{{ emp.AdminName or '-' }}</td>
        <td>
            <a href="{{ url_for('userinfo_restore', archive_id=emp.ArchiveID) }}" 
               class="btn btn-sm btn-success"
               style="padding: 5px 10px; background-color: #2e7d32; color: white; text-decoration: none; border-radius: 5px; font-size: 13px;"
               onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')">
               â™»ï¸
            </a>
        </td>
      </tr>
      {% else %}
        <tr>
          <td colspan="12" style="color:#777; padding: 20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  try {
    const chartData = JSON.parse('{{ chart_data|safe }}');
    function createChart(id, type, labels, data, label) {
        const ctx = document.getElementById(id);
        if (!ctx) return; 
        if (labels && labels.length > 0) {
            new Chart(ctx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: ['#004d7a', '#c62828', '#2e7d32', '#f9a825', '#1565c0', '#6a1b9a'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }
                }
            });
        } else {
            ctx.parentElement.innerHTML = '<p style="text-align:center; color:#999; margin-top: 80px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        }
    }
    createChart('reasonsChart', 'pie', chartData.reason_labels, chartData.reason_data, 'Ø§Ù„Ø¹Ø¯Ø¯');
    createChart('deptChart', 'doughnut', chartData.dept_labels, chartData.dept_data, 'Ø§Ù„Ø¹Ø¯Ø¯');
    createChart('posChart', 'pie', chartData.pos_labels, chartData.pos_data, 'Ø§Ù„Ø¹Ø¯Ø¯');
  } catch (e) { console.error('Error creating charts:', e); }
});
</script>
{% endblock %}