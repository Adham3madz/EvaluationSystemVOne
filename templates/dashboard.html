{% extends "layout.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
  /* === Premium Glassmorphism Dashboard === */

  :root {
    --glass-bg: rgba(15, 23, 42, 0.6);
    /* Darker glass for better contrast against wallpaper */
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-highlight: rgba(255, 255, 255, 0.05);
    --accent-cyan: #00d2ff;
    --accent-blue: #3a7bd5;
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --card-radius: 24px;
  }

  /* Reset & Typography */
  .dashboard-container {
    padding: 20px;
    direction: rtl;
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    font-family: 'Cairo', sans-serif;
    color: var(--text-primary);
    animation: fadeIn 0.8s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* === Header Section === */
  .dashboard-header {
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding: 30px;
    margin-bottom: 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
  }

  /* Glowing accent line */
  .dashboard-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
  }

  .header-content h2 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    color: #fff;
  }

  .header-content h2 .gradient-text {
    background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header-content p {
    margin: 5px 0 0 0;
    color: var(--text-secondary);
    font-size: 1.1rem;
  }

  .date-badge {
    background: rgba(0, 210, 255, 0.1);
    border: 1px solid rgba(0, 210, 255, 0.3);
    color: var(--accent-cyan);
    padding: 10px 20px;
    border-radius: 50px;
    font-weight: bold;
    backdrop-filter: blur(5px);
  }

  /* === Stats Grid === */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
  }

  .glass-stat-card {
    background: rgba(30, 41, 59, 0.7);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .glass-stat-card:hover {
    transform: translateY(-5px);
    background: rgba(30, 41, 59, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
  }

  /* Hover Glow Effect */
  .glass-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.03), transparent);
    transform: translateX(-100%);
    transition: 0.5s;
  }

  .glass-stat-card:hover::before {
    transform: translateX(100%);
  }

  .stat-icon-box {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    background: rgba(255, 255, 255, 0.05);
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.05);
    color: #fff;
    /* Ensure emoji color is visible if not overridden */
  }

  .stat-info h5 {
    margin: 0;
    font-size: 0.9rem;
    color: var(--text-secondary);
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .stat-info p {
    margin: 5px 0 0 0;
    font-size: 1.8rem;
    font-weight: 800;
    color: #fff;
  }

  /* === Main Content Grid === */
  .content-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 25px;
    margin-bottom: 40px;
  }

  .col-span-8 {
    grid-column: span 8;
  }

  .col-span-4 {
    grid-column: span 4;
  }

  .col-span-6 {
    grid-column: span 6;
  }

  .col-span-12 {
    grid-column: span 12;
  }

  /* === Glass Panels === */
  .glass-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--card-radius);
    padding: 25px;
    height: 100%;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .panel-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chart-container {
    position: relative;
    flex-grow: 1;
    min-height: 300px;
    width: 100%;
  }

  /* === Tables === */
  .custom-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 8px;
    /* Spacing between rows */
    font-size: 0.95rem;
  }

  .custom-table th {
    text-align: right;
    padding: 15px;
    color: var(--text-secondary);
    font-weight: 600;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .custom-table td {
    background: rgba(255, 255, 255, 0.03);
    padding: 16px;
    color: #e2e8f0;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .custom-table td:first-child {
    border-radius: 0 12px 12px 0;
  }

  .custom-table td:last-child {
    border-radius: 12px 0 0 12px;
  }

  .custom-table tr:hover td {
    background: rgba(255, 255, 255, 0.08);
    transform: scale(1.01);
  }

  .user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    margin-left: 10px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    color: white;
  }

  /* Badges */
  .status-badge {
    padding: 6px 12px;
    border-radius: 30px;
    font-size: 0.75rem;
    font-weight: 700;
    display: inline-block;
  }

  .badge-success {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399;
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .badge-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
    border: 1px solid rgba(245, 158, 11, 0.2);
  }

  .badge-info {
    background: rgba(59, 130, 246, 0.2);
    color: #60a5fa;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  /* Responsive */
  @media (max-width: 1024px) {

    .col-span-8,
    .col-span-4,
    .col-span-6 {
      grid-column: span 12;
    }
  }
</style>

<div class="dashboard-container">

  <!-- Header -->
  <div class="dashboard-header">
    <div class="header-content">
      <h2><span class="gradient-text">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ {{ name or username }}</span> ğŸ‘‹</h2>
      <p>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ÙŠÙˆÙ….</p>
    </div>
    <div class="date-badge">
      ğŸ“… {{ "now" | date_format_arabic }}
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="glass-stat-card">
      <div class="stat-icon-box" style="color: #60a5fa;">ğŸ‘¥</div>
      <div class="stat-info">
        <h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>
        <p>{{ users_count }}</p>
      </div>
    </div>
    <div class="glass-stat-card">
      <div class="stat-icon-box" style="color: #34d399;">ğŸ‘”</div>
      <div class="stat-info">
        <h5>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</h5>
        <p>{{ employees_count }}</p>
      </div>
    </div>
    <div class="glass-stat-card">
      <div class="stat-icon-box" style="color: #ef4444;">ğŸ“‚</div>
      <div class="stat-info">
        <h5>Ø§Ù„Ø£Ø±Ø´ÙŠÙ (ØºÙŠØ± Ù†Ø´Ø·)</h5>
        <p>{{ archived_count }}</p>
      </div>
    </div>
    <div class="glass-stat-card">
      <div class="stat-icon-box" style="color: #f472b6;">ğŸ“</div>
      <div class="stat-info">
        <h5>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h5>
        <p>{{ evals_count }}</p>
      </div>
    </div>
    <div class="glass-stat-card">
      <div class="stat-icon-box" style="color: #fbbf24;">â­</div>
      <div class="stat-info">
        <h5>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</h5>
        <p>{{ "%.1f"|format(avg_score) if avg_score is not none else '0.0' }}%</p>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="content-grid">

    <!-- Pie Chart -->
    <div class="col-span-4">
      <div class="glass-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</div>
        </div>
        <div class="chart-container">
          <canvas id="ratingsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bar Chart -->
    <div class="col-span-8">
      <div class="glass-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸ“ˆ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
        </div>
        <div class="chart-container">
          <canvas id="typesChart"></canvas>
        </div>
      </div>
    </div>

  </div>

  <!-- Tables Section -->
  <div class="content-grid">

    <!-- Top Performers -->
    <div class="col-span-6">
      <div class="glass-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸŒŸ Ø§Ù„Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡Ù‹ (Ø¢Ø®Ø± 30 ÙŠÙˆÙ…)</div>
        </div>
        <div style="overflow-x: auto;">
          <table class="custom-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
              </tr>
            </thead>
            <tbody>
              {% for performer in top_performers %}
              <tr>
                <td>
                  <div style="display: flex; align-items: center;">
                    <span class="user-avatar">{{ performer.EmployeeName[:1] }}</span>
                    <span style="margin-right: 10px; font-weight: bold;">{{ performer.EmployeeName }}</span>
                  </div>
                </td>
                <td style="color: #34d399; font-weight: bold;">{{ "%.1f"|format(performer.OverallScore) }}%</td>
                <td><span class="status-badge badge-success">{{ performer.OverallRating }}</span></td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" style="text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recent Evaluations -->
    <div class="col-span-6">
      <div class="glass-panel">
        <div class="panel-header">
          <div class="panel-title">ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</div>
        </div>
        <div style="overflow-x: auto;">
          <table class="custom-table">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ø§Ù„Ù…Ù‚ÙŠÙ…</th>
                <th>Ø§Ù„Ù†ÙˆØ¹</th>
                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
              </tr>
            </thead>
            <tbody>
              {% for eval in recent_evaluations %}
              <tr>
                <td style="font-weight: 600;">{{ eval.EmployeeName }}</td>
                <td style="color: var(--text-secondary);">{{ eval.EvaluatorName }}</td>
                <td><span class="status-badge badge-info">{{ eval.EvaluationType }}</span></td>
                <td style="color: #60a5fa; font-weight: bold;">{{ "%.1f"|format(eval.OverallScore) }}%</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4" style="text-align: center; color: var(--text-secondary);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ø­Ø¯ÙŠØ«Ø©</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  {% if is_admin %}
  <div class="content-grid">
    <div class="col-span-12">
      <div class="glass-panel" style="background: rgba(124, 58, 237, 0.1); border-color: rgba(139, 92, 246, 0.3);">
        <div class="panel-header">
          <div class="panel-title">ğŸ›¡ï¸ Ù„ÙˆØ­Ø© Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡</div>
        </div>
        <div id="managers-content">
          {% include 'partials/managers_table.html' %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
  // AJAX Pagination function
  function loadManagersPage(page) {
    const container = document.getElementById('managers-content');
    if (!container) return;

    // Add loading opacity
    container.style.opacity = '0.5';

    fetch(`{{ url_for('dashboard_managers_partial') }}?page=${page}`)
      .then(response => response.text())
      .then(html => {
        // Replace the content
        container.innerHTML = html;

        // Animate fade in
        const newContainer = document.getElementById('managers-content');
        if (newContainer) {
          newContainer.style.opacity = '0';
          newContainer.style.transition = 'opacity 0.3s';
          requestAnimationFrame(() => newContainer.style.opacity = '1');
        }
      })
      .catch(err => {
        console.error('Error loading managers:', err);
        container.style.opacity = '1';
      });
  }

  document.addEventListener('DOMContentLoaded', function () {
    try {
      const chartData = JSON.parse('{{ chart_data|safe }}');

      if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded! Please download chart.min.js to static/js/');
        return;
      }

      // Modern Dark Mode Chart Defaults
      Chart.defaults.font.family = "'Cairo', sans-serif";
      Chart.defaults.color = '#94a3b8';
      Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';
      Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)';
      Chart.defaults.plugins.tooltip.padding = 12;
      Chart.defaults.plugins.tooltip.cornerRadius = 12;

      // 1. Ratings Chart (Pie)
      if (chartData.rating_labels && document.getElementById('ratingsChart')) {
        new Chart(document.getElementById('ratingsChart'), {
          type: 'doughnut', /* Modern Doughnut instead of Pie */
          data: {
            labels: chartData.rating_labels,
            datasets: [{
              data: chartData.rating_data,
              backgroundColor: [
                '#10b981', // Emerald
                '#3b82f6', // Blue
                '#f59e0b', // Amber
                '#f43f5e', // Rose
                '#8b5cf6'  // Violet
              ],
              borderColor: 'rgba(15, 23, 42, 0.8)',
              borderWidth: 4,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true, boxWidth: 10 }
              }
            }
          }
        });
      }

      // 2. Types Chart (Bar)
      if (chartData.type_labels && document.getElementById('typesChart')) {
        const gradient = document.getElementById('typesChart').getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, '#00d2ff');
        gradient.addColorStop(1, 'rgba(0, 210, 255, 0.1)');

        new Chart(document.getElementById('typesChart'), {
          type: 'bar',
          data: {
            labels: chartData.type_labels,
            datasets: [{
              label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª',
              data: chartData.type_data,
              backgroundColor: gradient,
              borderColor: '#00d2ff',
              borderWidth: 1,
              borderRadius: 8,
              barThickness: 30
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: { borderDash: [5, 5] }
              },
              x: {
                grid: { display: false }
              }
            },
            plugins: { legend: { display: false } }
          }
        });
      }
    } catch (e) { console.error('Dashboard Script Error:', e); }
  });
</script>
{% endblock %}