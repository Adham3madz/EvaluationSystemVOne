{% extends "layout.html" %}
{% block title %}ุชุณุฌูู ููุธู{% endblock %}

{% block content %}
<div class="container-fluid">

    <h4 class="fw-bold mb-4">๐งพ ุชุณุฌูู ููุธู ูู ุงูุฌูุณุฉ</h4>

    <div class="card shadow-sm p-4">

        <div class="alert alert-info mb-4">
            <strong>๐ ูุนูููุงุช ุงูุฌูุณุฉ:</strong><br>
            โข ุนุฏุฏ ุงูููุธููู ุงููุชุงุญูู: <strong>{{ employees|length }}</strong> ููุธู
        </div>

        <form method="POST">

            <div class="mb-4">
                <label class="form-label fw-bold">๐ ุจุญุซ ุจุงูุงุณู</label>
                <input type="text" id="searchInput" class="form-control" placeholder="ุงูุชุจ ุงุณู ุงูููุธู..." onkeyup="performSearch()">
            </div>

            <div class="mb-4" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: #fff;">
                <label class="form-label fw-bold d-block mb-3">๐ฅ ุงุฎุชุฑ ุงูููุธููู</label>

                {% set rec_employees = employees|selectattr('USERID', 'in', recommended_ids)|list %}
                
                {% if rec_employees|length > 0 %}
                <details class="mb-3 dept-section" open>
                    <summary class="fw-bold bg-warning bg-opacity-25 p-3 rounded d-flex justify-content-between align-items-center" style="cursor: pointer; border: 1px solid #ffc107;">
                        <span>๐ ููุธููู ููุตู ุจูู ({{ rec_employees|length }})</span>
                        <input type="checkbox" class="ms-3" onchange="toggleGroup(this, 'rec-group')">
                    </summary>
                    <div class="ps-4 pt-3 rec-group">
                        {% for e in rec_employees %}
                        <div class="form-check employee-item mb-2">
                            <input class="form-check-input" type="checkbox" name="employee_ids" value="{{ e.USERID }}" id="rec_emp{{ e.USERID }}">
                            <label class="form-check-label fw-bold text-dark" for="rec_emp{{ e.USERID }}">
                                {{ e.NAME }} 
                                <span class="badge bg-warning text-dark me-2">ุชูุตูุฉ ูู ุงูุชูููู</span>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
                {% set no_dept_employees = employees|selectattr('DEFAULTDEPTID', 'equalto', 0)|list %}
                {% if no_dept_employees|length > 0 %}
                <details class="mb-3 dept-section">
                    <summary class="fw-bold bg-light p-3 rounded d-flex justify-content-between align-items-center" style="cursor: pointer;">
                        <span>๐ฅ ุจุฏูู ูุณู ({{ no_dept_employees|length }})</span>
                        <input type="checkbox" class="ms-3" onchange="toggleGroup(this, 'no-dept-group')">
                    </summary>
                    <div class="ps-4 pt-3 no-dept-group">
                        {% for e in no_dept_employees %}
                        <div class="form-check employee-item mb-2">
                            <input class="form-check-input" type="checkbox" name="employee_ids" value="{{ e.USERID }}" id="emp{{ e.USERID }}">
                            <label class="form-check-label" for="emp{{ e.USERID }}">
                                {{ e.NAME }}
                                {% if e.IsActive == 0 %}<span class="text-danger">(ุบูุฑ ูุดุท)</span>{% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}

                {% for d in depts %}
                    {% set dept_employees = employees|selectattr('DEFAULTDEPTID', 'equalto', d.DEPTID)|list %}
                    {% if dept_employees|length > 0 %}
                    <details class="mb-3 dept-section">
                        <summary class="fw-bold bg-light p-3 rounded d-flex justify-content-between align-items-center" style="cursor: pointer;">
                            <span>๐ข {{ d.DEPTNAME }} ({{ dept_employees|length }})</span>
                            <input type="checkbox" class="ms-3" onchange="toggleGroup(this, 'dept-{{ d.DEPTID }}-group')">
                        </summary>
                        <div class="ps-4 pt-3 dept-{{ d.DEPTID }}-group">
                            {% for e in dept_employees %}
                            <div class="form-check employee-item mb-2">
                                <input class="form-check-input" type="checkbox" name="employee_ids" value="{{ e.USERID }}" id="emp{{ e.USERID }}">
                                <label class="form-check-label" for="emp{{ e.USERID }}">
                                    {{ e.NAME }}
                                    {% if e.IsActive == 0 %}<span class="text-danger">(ุบูุฑ ูุดุท)</span>{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="d-flex gap-2 flex-wrap mt-4">
                <button type="submit" class="btn btn-success px-4">โ ุชุณุฌูู ุงููุฎุชุงุฑูู</button>
                <button type="button" onclick="selectAllVisible()" class="btn btn-outline-primary btn-sm">ุชุญุฏูุฏ ุงููู ุงููุฑุฆู</button>
                <a href="{{ url_for('training_session_detail', sid=sid) }}" class="btn btn-secondary">๐ ุฑุฌูุน</a>
            </div>

        </form>
    </div>
</div>

<script>
// ุงูุจุญุซ + ูุชุญ ุงููุณู ุชููุงุฆููุง
function performSearch() {
    const input = document.getElementById('searchInput').value.toLowerCase().trim();
    const items = document.querySelectorAll('.employee-item');
    
    items.forEach(item => {
        const label = item.querySelector('label').textContent.toLowerCase();
        const matches = input === '' || label.includes(input);
        item.style.display = matches ? 'block' : 'none';

        if (matches && input !== '') {
            const section = item.closest('.dept-section');
            if (section) section.open = true;
        }
    });
}

// ุชุญุฏูุฏ/ุฅูุบุงุก ูู ุงูููุธููู ูู ูุณู
function toggleGroup(checkbox, groupClass) {
    // ูููู ุงูุญุฏุซ ุนุดุงู ูุง ููููุด ุงูู details ููุง ูุฏูุณ ุนุงูู checkbox
    event.stopPropagation(); 
    
    const checkboxes = document.querySelectorAll('.' + groupClass + ' .form-check-input');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

// ุชุญุฏูุฏ ุงููู ุงููุฑุฆู (ุจุนุฏ ุงูุจุญุซ)
function selectAllVisible() {
    const visible = document.querySelectorAll('.employee-item[style="display: block;"] .form-check-input, .employee-item:not([style]) .form-check-input');
    visible.forEach(cb => {
        cb.checked = true;
    });
}
</script>

<style>
/* ุชุญุณูู ูุธูุฑ <details> */
details > summary { list-style: none; }
details > summary::-webkit-details-marker { display: none; }
details > summary::after {
    content: "โถ"; float: left; margin-left: 10px; transition: transform 0.3s;
}
details[open] > summary::after { transform: rotate(90deg); }
details[open] > summary { border-bottom: 1px solid #dee2e6; margin-bottom: 10px; }
.employee-item { padding: 4px 0; }
</style>

{% endblock %}