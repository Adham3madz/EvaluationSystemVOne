{% extends "layout.html" %}
{% block title %}ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…{% endblock %}

{% block content %}
<style>
    /* --- Styles from your original file --- */
    body {
        direction: rtl;
        font-family: "Tajawal", "Segoe UI", sans-serif;
        background-color: #f5f7fa;
        color: #222;
        margin: 0;
        padding: 0;
    }
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        background-color: #e9f0fb;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        border-right: 5px solid #004d99;
    }
    .page-header h2 {
        font-size: 1.4rem;
        color: #004d99;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 700;
    }
    .page-header .btn {
        background-color: #007b3e;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 14px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
    }
    .page-header .btn:hover { background-color: #005e2f; }
    .card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.08);
        padding: 20px;
        overflow-x: auto;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        text-align: center;
        font-size: 0.95rem;
        min-width: 1000px; /* Ensure table is wide enough */
    }
    thead { background-color: #004d99; color: #fff; }
    th, td {
        padding: 10px 8px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
    }
    tbody tr:nth-child(even) { background-color: #f8f9fc; }
    tbody tr:hover { background-color: #eef4ff; }
    
    .btn-sm {
        display: inline-flex;  
        align-items: center;   
        justify-content: center;
        gap: 5px;              
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;     
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        text-decoration: none; 
    }
    .btn-sm:hover { background-color: #005dc1; }
    .empty-row {
        color: #888;
        font-style: italic;
        text-align: center;
    }

    /* --- Styles for Filter Section --- */
    .filters-section {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    .filter-label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #333;
        font-size: 14px;
    }
    .filter-select, .filter-input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
        background: #fff;
    }
    .filter-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 15px;
    }
    .btn-primary {
        background-color: #004d7a;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
    }
    .btn-clear {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
    }

    /* --- RATING BADGE STYLES --- */
    .rating-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 15px;
        font-weight: 600;
        font-size: 13px;
        color: #fff;
        min-width: 60px;
    }
    .rating-excellent { background-color: #0275d8; } /* Ù…Ù…ØªØ§Ø² */
    .rating-very-good { background-color: #5cb85c; } /* Ø¬ÙŠØ¯ Ø¬Ø¯Ø§ */
    .rating-good { background-color: #f0ad4e; } /* Ø¬ÙŠØ¯ */
    .rating-acceptable { background-color: #d9534f; } /* Ù…Ù‚Ø¨ÙˆÙ„ */
    .rating-weak { background-color: #c62828; } /* Ø¶Ø¹ÙŠÙ */
    .rating-default { background-color: #777; } /* Default */

    /* --- SCORE BAR STYLES --- */
    .score-bar-container {
        width: 100%;
        min-width: 100px;
        background-color: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
    }
    .score-bar {
        height: 20px;
        line-height: 20px;
        font-size: 12px;
        font-weight: 600;
        color: white;
        text-align: center;
        background-color: #007bff;
        border-radius: 15px;
        transition: width 0.5s ease-in-out;
    }
    .score-bar.low { background-color: #c62828; } /* 0-59 */
    .score-bar.medium { background-color: #f0ad4e; } /* 60-79 */
    .score-bar.high { background-color: #5cb85c; } /* 80-100 */

</style>

<div class="page-header">
    <h2>ğŸ“Š Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
    {% if session.get('role_id') in [2, 3] %}
      <a href="{{ url_for('select_user_for_evaluation') }}" class="btn">â• Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯</a>
    {% endif %}
</div>

<div class="filters-section">
    <form id="filtersForm" method="GET" action="{{ url_for('evaluation_reports') }}">
        <div class="filters-grid">
            
            <!-- Employee Search (Moved outside admin block) -->
            <div class="filter-group">
                <label class="filter-label" for="search_employee">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                <input type="text" name="search_employee" id="search_employee" class="filter-input" 
                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..." value="{{ filters.get('search_employee', '') }}">
            </div>
            
            <!-- Evaluator Search (Shows for Admin, or for Manager to search self) -->
            {% if is_admin or role_id != 5 %}
            <div class="filter-group">
                <label class="filter-label" for="search_evaluator">Ø§Ø³Ù… Ù…Ù‚Ø¯Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                <input type="text" name="search_evaluator" id="search_evaluator" class="filter-input" 
                       placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ÙŠÙ…..." value="{{ filters.get('search_evaluator', '') }}">
            </div>
            {% endif %}

            <!-- Recommendation Filter -->
            <div class="filter-group">
                <label class="filter-label" for="recommendation_id">Ø§Ù„ØªÙˆØµÙŠØ©:</label>
                <select name="recommendation_id" id="recommendation_id" class="filter-select">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    {% for rec in all_recommendations %}
                    <option value="{{ rec.RecommendationID }}" {% if filters.get('recommendation_id') == rec.RecommendationID|string %}selected{% endif %}>
                        {{ rec.RecommendationText | truncate(50) }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Training Course Filter -->
            <div class="filter-group">
                <label class="filter-label" for="training_course_id">Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©:</label>
                <select name="training_course_id" id="training_course_id" class="filter-select">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    {% for course in all_training_courses %}
                    <option value="{{ course.TrainingCourseID }}" {% if filters.get('training_course_id') == course.TrainingCourseID|string %}selected{% endif %}>
                        {{ course.TrainingCourseText | truncate(50) }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label" for="eval_type_id">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
                <select name="eval_type_id" id="eval_type_id" class="filter-select">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    {% for etype in all_evaluation_types %}
                    <option value="{{ etype.EvaluationTypeID }}" {% if filters.get('eval_type_id') == etype.EvaluationTypeID|string %}selected{% endif %}>
                        {{ etype.DisplayName }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="date_from">Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù†:</label>
                <input type="date" name="date_from" id="date_from" class="filter-input" 
                       value="{{ filters.get('date_from', '') }}">
            </div>
            <div class="filter-group">
                <label class="filter-label" for="date_to">Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰:</label>
                <input type="date" name="date_to" id="date_to" class="filter-input" 
                       value="{{ filters.get('date_to', '') }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
            <button type="button" onclick="clearFilters()" class="btn btn-clear">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </div>
    </form>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø¯ÙŠØ±</th>
        <th>ğŸ§‘â€ğŸ’¼ Ù…Ù‚Ø¯Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
        <th>ğŸ·ï¸ ÙØ¦Ø© Ø§Ù„Ù…ÙˆØ¸Ù</th>
        <th>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
        <th>ğŸ“‚ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
        <th>ğŸ“ˆ Ø§Ù„Ù†ØªÙŠØ¬Ø© (%)</th>
        <th>ğŸ… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
        <th>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th>ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ©</th>
        <th>ğŸ“ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</th>
        <th>ğŸ” Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody>
      {% for report in reports %}
      <tr>
        <td>{{ report.EvaluationID }}</td>
        <td>{{ report.EmployeeName or '--' }}</td>
        <td>{{ report.EvaluatorName or '--' }}</td>
        <td>{{ report.employee_class or '--' }}</td>
        <td>{{ report.EvaluationDate.strftime('%Y-%m-%d %H:%M') if report.EvaluationDate else '--' }}</td>
        <td>{{ report.EvaluationType or '--' }}</td>
        
        <!-- VISUAL SCORE BAR -->
        {% set score_val = report.OverallScore|float or 0 %}
        <td>
          <div class="score-bar-container" title="{{ "%.2f"|format(score_val) }}%">
            <div class="score-bar 
              {% if score_val < 60 %}low{% elif score_val < 80 %}medium{% else %}high{% endif %}" 
              style="width: {{ score_val }}%;">
              {{ "%.1f"|format(score_val) }}%
            </div>
          </div>
        </td>
        
        <!-- VISUAL RATING BADGE -->
        {% set r_class = 'default' %}
        {% if report.OverallRating == 'Ù…Ù…ØªØ§Ø²' %}{% set r_class = 'excellent' %}
        {% elif report.OverallRating == 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§' %}{% set r_class = 'very-good' %}
        {% elif report.OverallRating == 'Ø¬ÙŠØ¯' %}{% set r_class = 'good' %}
        {% elif report.OverallRating == 'Ù…Ù‚Ø¨ÙˆÙ„' %}{% set r_class = 'acceptable' %}
        {% elif report.OverallRating == 'Ø¶Ø¹ÙŠÙ' %}{% set r_class = 'weak' %}
        {% endif %}
        <td>
          <span class="rating-badge rating-{{ r_class }}">
            {{ report.OverallRating or '--' }}
          </span>
        </td>

        <td>{{ report.ManagerComments or '--' }}</td>
        <td>{{ report.RecommendationText or '--' }}</td>
        <td>{{ report.TrainingCourseText or '--' }}</td>
        <td>
          <a href="{{ url_for('evaluation_details', evaluation_id=report.EvaluationID) }}" class="btn-sm">
            ğŸ–¨ï¸ ØªÙØ§ØµÙŠÙ„
          </a>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="12" class="empty-row">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
    function clearFilters() {
        // Find all inputs and selects in the form and clear them
        const form = document.getElementById('filtersForm');
        form.querySelectorAll('input, select').forEach(element => {
            if (element.type === 'text' || element.type === 'date') {
                element.value = '';
            } else if (element.type === 'select-one') {
                element.selectedIndex = 0;
            }
        });
        // Resubmit the form to show all results
        form.submit();
    }
</script>
{% endblock %}