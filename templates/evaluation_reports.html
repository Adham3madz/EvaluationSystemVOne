{% extends "layout.html" %}
{% block title %}ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
    /* === Glass Panel Theme === */
    .glass-panel {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    /* === KPI Cards === */
    .kpi-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(230, 240, 255, 0.6));
        border: 1px solid rgba(13, 110, 253, 0.2);
        border-radius: 16px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(13, 110, 253, 0.15);
    }

    .kpi-icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .kpi-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #004d99;
    }

    .kpi-label {
        font-size: 0.85rem;
        font-weight: 700;
        color: #666;
    }

    /* === Form Elements === */
    .form-label {
        font-weight: 700;
        color: #444;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        color: #333;
    }

    .form-control:focus,
    .form-select:focus {
        background: #fff;
        box-shadow: 0 0 0 3px rgba(11, 102, 178, 0.2);
        border-color: #0b66b2;
    }

    /* === Buttons === */
    .btn-glass-primary {
        background: linear-gradient(135deg, #004d7a, #0b66b2);
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        font-weight: bold;
        padding: 8px 20px;
        border-radius: 8px;
    }

    .btn-glass-primary:hover {
        background: #003d6a;
        color: white;
        transform: translateY(-2px);
    }

    .btn-glass-secondary {
        background: rgba(108, 117, 125, 0.8);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        padding: 8px 20px;
        border-radius: 8px;
    }

    .btn-glass-secondary:hover {
        background: rgba(108, 117, 125, 1);
        color: white;
    }

    /* === Table === */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-bottom: 0;
    }

    .table-custom thead th {
        background: linear-gradient(135deg, #004d7a, #0b66b2);
        color: #fff;
        padding: 15px;
        border: none;
        font-weight: 600;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .table-custom thead th:first-child {
        border-top-right-radius: 10px;
    }

    .table-custom thead th:last-child {
        border-top-left-radius: 10px;
    }

    .table-custom tbody td {
        background-color: transparent;
        padding: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        color: #333;
        vertical-align: middle;
    }

    .table-custom tbody tr:hover td {
        background-color: rgba(11, 102, 178, 0.08);
    }

    /* === Badges & Bars === */
    .rating-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 12px;
        color: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .rating-excellent {
        background-color: #198754;
    }

    /* Green */
    .rating-very-good {
        background-color: #20c997;
    }

    /* Teal */
    .rating-good {
        background-color: #ffc107;
        color: #000;
    }

    /* Yellow */
    .rating-acceptable {
        background-color: #fd7e14;
    }

    /* Orange */
    .rating-weak {
        background-color: #dc3545;
    }

    /* Red */
    .rating-default {
        background-color: #6c757d;
    }

    .score-bar-container {
        width: 100%;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 5px;
    }

    .score-bar {
        height: 100%;
        border-radius: 10px;
    }

    .score-bar.high {
        background-color: #198754;
    }

    .score-bar.medium {
        background-color: #ffc107;
    }

    .score-bar.low {
        background-color: #dc3545;
    }

    /* === Print === */
    @media print {
        body {
            background: white !important;
        }

        .glass-panel {
            box-shadow: none;
            border: none;
            padding: 0;
        }

        .btn,
        form {
            display: none !important;
        }

        .kpi-card {
            border: 1px solid #ddd;
        }
    }
</style>

<div class="container-fluid py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-white mb-1" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">ğŸ“Š Ø³Ø¬Ù„Ø§Øª ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡
            </h2>
            <p class="text-white-50">Ø¹Ø±Ø¶ ÙˆØªØ­Ù„ÙŠÙ„ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</p>
        </div>

        <div class="d-flex gap-2">
            {% if session.get('role_id') in [2, 3] %}
            <a href="{{ url_for('select_user_for_evaluation') }}" class="btn btn-glass-primary">â• ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯</a>
            {% endif %}
            <button onclick="window.print()" class="btn btn-glass-secondary">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        </div>
    </div>

    {% if reports %}
    <div class="row g-4 mb-4">
        <div class="col-md-2">
            <div class="kpi-card" style="cursor: pointer;" onclick="clearFilters()" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±">
                <div class="kpi-icon">ğŸ“‘</div>
                <div class="kpi-value" id="statTotal">0</div>
                <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="kpi-card" style="border-color: rgba(255, 193, 7, 0.3);">
                <div class="kpi-icon">â­</div>
                <div class="kpi-value text-warning" id="statAvgScore">0</div>
                <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="kpi-card" style="border-color: rgba(25, 135, 84, 0.3); cursor: pointer;"
                onclick="document.getElementById('filterRating').value='Ù…Ù…ØªØ§Ø²'; document.getElementById('filtersForm').submit();"
                title="ØªØµÙÙŠØ© Ø¨Ø§Ù„Ù…Ù…ØªØ§Ø²">
                <div class="kpi-icon">ğŸ†</div>
                <div class="kpi-value text-success" id="statExcellent">0%</div>
                <div class="kpi-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªÙŠØ§Ø²</div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±Ø§Øª</h6>
                <div style="height: 100px; width: 100px;">
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="glass-panel p-2 d-flex flex-column align-items-center justify-content-center h-100 mb-0">
                <h6 class="fw-bold small mb-2 text-muted">Ø£Ø¨Ø±Ø² Ø§Ù„ØªÙˆØµÙŠØ§Øª</h6>
                <div style="height: 100px; width: 100%;">
                    <canvas id="recChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="glass-panel">
        <form id="filtersForm" method="GET" action="{{ url_for('evaluation_reports') }}">
            <input type="hidden" name="overall_rating" id="filterRating"
                value="{{ filters.get('overall_rating', '') }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <input type="text" name="search_employee" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù..."
                        value="{{ filters.get('search_employee', '') }}">
                </div>

                {% if is_admin or role_id != 5 %}
                <div class="col-md-3">
                    <label class="form-label">Ø§Ù„Ù…Ù‚ÙŠÙ…</label>
                    <input type="text" name="search_evaluator" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ÙŠÙ…..."
                        value="{{ filters.get('search_evaluator', '') }}">
                </div>
                {% endif %}

                <div class="col-md-3">
                    <label class="form-label">Ø§Ù„ØªÙˆØµÙŠØ©</label>
                    <select name="recommendation_id" class="form-select">
                        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                        {% for rec in all_recommendations %}
                        <option value="{{ rec.RecommendationID }}" {% if
                            filters.get('recommendation_id')==rec.RecommendationID|string %}selected{% endif %}>
                            {{ rec.RecommendationText | truncate(30) }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
                    <select name="eval_type_id" class="form-select">
                        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                        {% for etype in all_evaluation_types %}
                        <option value="{{ etype.EvaluationTypeID }}" {% if
                            filters.get('eval_type_id')==etype.EvaluationTypeID|string %}selected{% endif %}>
                            {{ etype.DisplayName }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø¬ØªØ§Ø²Ø© (History)</label>
                    <select name="taken_course_id" class="form-select">
                        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
                        {% for course in all_training_courses %}
                        <option value="{{ course.TrainingCourseID }}" {% if
                            filters.get('taken_course_id')==course.TrainingCourseID|string %}selected{% endif %}>
                            {{ course.TrainingCourseText }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" name="date_from" class="form-control" value="{{ filters.get('date_from', '') }}">
                </div>

                <div class="col-md-2">
                    <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input type="date" name="date_to" class="form-control" value="{{ filters.get('date_to', '') }}">
                </div>

                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-glass-primary flex-grow-1">ğŸ” Ø¨Ø­Ø«</button>
                    <button type="button" onclick="clearFilters()" class="btn btn-glass-secondary">âŒ Ù…Ø³Ø­</button>
                </div>
            </div>
        </form>
    </div>

    <div class="glass-panel p-0 overflow-hidden">
        <div class="table-responsive" style="max-height: 65vh; overflow-y: auto;">
            <table class="table table-custom text-center mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ğŸ‘¥ Ø§Ù„Ù…ÙˆØ¸Ù / Ø§Ù„Ù…Ø¯ÙŠØ±</th>
                        <th>ğŸ“‚ Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>ğŸ“š Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</th>
                        <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>ğŸ“ˆ Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                        <th>ğŸ… Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                        <th>ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ©</th>
                        <th style="min-width: 150px;">ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    {% for report in reports %}
                    <tr class="report-row" data-score="{{ report.OverallScore }}"
                        data-rating="{{ report.OverallRating or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}"
                        data-rec="{{ report.RecommendationText or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}"
                        onclick="window.location='{{ url_for('evaluation_details', evaluation_id=report.EvaluationID) }}'"
                        style="cursor: pointer; transition: background-color 0.2s;">

                        <td>{{ report.EvaluationID }}</td>

                        <td class="text-start">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('user_pic', user_id=report.EmployeeUserID) }}" alt="img"
                                    style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-left: 8px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                    onerror="this.src='{{ url_for('static', filename='images/default_user.png') }}'">
                                <div>
                                    <div class="fw-bold text-primary">{{ report.EmployeeName or '--' }}</div>
                                    <small class="text-muted">Ø¨ÙˆØ§Ø³Ø·Ø©: {{ report.EvaluatorName or '--' }}</small>
                                </div>
                            </div>
                        </td>

                        <td><span class="badge bg-light text-dark border">{{ report.EvaluationType or '--' }}</span>
                        </td>

                        <td style="text-align: right;">
                            {% if report.CoursesTaken %}
                            {% set courses = report.CoursesTaken.split('###') %}
                            <div style="display:flex; flex-wrap:wrap; gap:4px;">
                                {% for c in courses[:2] %}
                                <span class="badge bg-secondary" style="font-size:0.7rem; font-weight:normal;">{{ c
                                    }}</span>
                                {% endfor %}
                                {% if courses|length > 2 %}
                                <span class="badge bg-light text-dark border" style="cursor:help; font-size:0.7rem;"
                                    title="{{ courses|join('\n') }}">+{{ courses|length - 2 }}</span>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>

                        <td class="small">{{ report.EvaluationDate.strftime('%Y-%m-%d') if report.EvaluationDate else
                            '--' }}</td>

                        <td style="width: 120px;">
                            <div class="fw-bold">{{ "%.1f"|format(report.OverallScore|float) }}%</div>
                            <div class="score-bar-container">
                                <div class="score-bar {% if report.OverallScore|float < 60 %}low{% elif report.OverallScore|float < 80 %}medium{% else %}high{% endif %}"
                                    style="width: {{ report.OverallScore|float }}%;"></div>
                            </div>
                        </td>

                        <td>
                            {% set r_class = 'default' %}
                            {% if report.OverallRating == 'Ù…Ù…ØªØ§Ø²' %}{% set r_class = 'excellent' %}
                            {% elif report.OverallRating == 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§' %}{% set r_class = 'very-good' %}
                            {% elif report.OverallRating == 'Ø¬ÙŠØ¯' %}{% set r_class = 'good' %}
                            {% elif report.OverallRating == 'Ù…Ù‚Ø¨ÙˆÙ„' %}{% set r_class = 'acceptable' %}
                            {% elif report.OverallRating == 'Ø¶Ø¹ÙŠÙ' %}{% set r_class = 'weak' %}
                            {% endif %}
                            <span class="rating-badge rating-{{ r_class }}">
                                {{ report.OverallRating or '--' }}
                            </span>
                        </td>

                        <td>{{ report.RecommendationText or '--' }}</td>

                        <td class="text-start small text-truncate" style="max-width: 150px;"
                            title="{{ report.ManagerComments }}">
                            {{ report.ManagerComments or '--' }}
                        </td>

                        <td onclick="event.stopPropagation()">
                            <div class="d-flex justify-content-center gap-1">
                                <a href="{{ url_for('evaluation_details', evaluation_id=report.EvaluationID) }}"
                                    class="btn btn-sm btn-outline-info" title="Ø¹Ø±Ø¶">
                                    ğŸ‘ï¸
                                </a>
                                {% if is_admin %}
                                <form action="{{ url_for('evaluation_delete', evaluation_id=report.EvaluationID) }}"
                                    method="POST" onsubmit="return confirm('Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="py-5 text-muted">
                            <div class="fs-1 mb-2">ğŸ“­</div>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ø·Ø§Ø¨Ù‚Ø©.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Sticky Filters Logic ===
        const filterKey = 'evaluationReportsFilters';

        // 1. Check if we should restore filters
        if (!window.location.search && localStorage.getItem(filterKey)) {
            window.location.search = localStorage.getItem(filterKey);
            return;
        }

        // 2. Save current filters if they exist
        if (window.location.search) {
            localStorage.setItem(filterKey, window.location.search);
        }

        // === Safe Analytics Extraction (From DOM) ===
        const rows = document.querySelectorAll('.report-row');

        let total = 0;
        let sumScore = 0;
        let excellentCount = 0;

        const ratingCounts = {};
        const recCounts = {};

        rows.forEach(row => {
            total++;
            const score = parseFloat(row.getAttribute('data-score')) || 0;
            const rating = row.getAttribute('data-rating');
            const rec = row.getAttribute('data-rec');

            sumScore += score;

            // Rating Counts
            if (rating.includes('Ù…Ù…ØªØ§Ø²')) excellentCount++;
            ratingCounts[rating] = (ratingCounts[rating] || 0) + 1;

            // Rec Counts
            recCounts[rec] = (recCounts[rec] || 0) + 1;
        });

        // Don't render if empty
        if (total === 0) return;

        // Update KPIs
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statAvgScore').innerText = (sumScore / total).toFixed(1) + "%";
        document.getElementById('statExcellent').innerText = Math.round((excellentCount / total) * 100) + "%";

        // --- Chart 1: Ratings (Doughnut) ---
        new Chart(document.getElementById('ratingChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(ratingCounts),
                datasets: [{
                    data: Object.values(ratingCounts),
                    backgroundColor: ['#198754', '#20c997', '#ffc107', '#fd7e14', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '70%',
                onClick: (evt, activeElements, chart) => {
                    if (activeElements.length > 0) {
                        const index = activeElements[0].index;
                        const label = chart.data.labels[index];
                        document.getElementById('filterRating').value = label;
                        document.getElementById('filtersForm').submit();
                    }
                },
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                }
            }
        });

        // --- Chart 2: Recommendations (Bar) ---
        // Sort & Slice Top 5
        const sortedRecs = Object.entries(recCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);

        new Chart(document.getElementById('recChart'), {
            type: 'bar',
            data: {
                labels: sortedRecs.map(i => i[0]),
                datasets: [{
                    label: 'Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØµÙŠØ§Øª',
                    data: sortedRecs.map(i => i[1]),
                    backgroundColor: '#0d6efd',
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false, beginAtZero: true }
                }
            }
        });
    });

    function clearFilters() {
        localStorage.removeItem('evaluationReportsFilters');
        const form = document.getElementById('filtersForm');
        form.querySelectorAll('input, select').forEach(el => {
            el.value = '';
        });
        form.submit();
    }
</script>
{% endblock %}