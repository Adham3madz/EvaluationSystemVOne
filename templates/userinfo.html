{% extends "layout.html" %}
{% block title %}Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}

{% block content %}
<script src="{{ url_for('static', filename='js/chart.min.js') }}"></script>

<style>
    /* === Premium Glassmorphism Theme (Matches Dashboard) === */
    :root {
        --glass-bg: rgba(15, 23, 42, 0.6);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-highlight: rgba(255, 255, 255, 0.05);
        --accent-cyan: #00d2ff;
        --accent-blue: #3a7bd5;
        --text-primary: #ffffff;
        --text-secondary: #94a3b8;
        --card-radius: 20px;
    }

    body {
        background-color: #0f172a;
        /* Fallback/Base */
        color: var(--text-primary);
        font-family: 'Cairo', sans-serif;
    }

    .dashboard-container {
        padding: 20px;
        direction: rtl;
        width: 100%;
        max-width: 1600px;
        /* Wider for table */
        margin: 0 auto;
        animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* === Header === */
    .dashboard-header {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--card-radius);
        padding: 25px 30px;
        margin-bottom: 30px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .dashboard-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
    }

    .header-content h2 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 800;
        color: #fff;
    }

    .header-content h2 .gradient-text {
        background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .date-badge {
        background: rgba(0, 210, 255, 0.1);
        border: 1px solid rgba(0, 210, 255, 0.3);
        color: var(--accent-cyan);
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 0.9rem;
    }

    /* === Grid Layouts === */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    /* === Glass Cards & Panels === */
    .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        border-radius: var(--card-radius);
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .glass-stat-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }

    .glass-stat-card:hover {
        transform: translateY(-3px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .stat-icon-box {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2);
    }

    .stat-info h5 {
        margin: 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .stat-info p {
        margin: 2px 0 0 0;
        font-size: 1.4rem;
        font-weight: 800;
        color: #fff;
    }

    /* === Filters Section === */
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .filter-label {
        display: block;
        margin-bottom: 6px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 600;
    }

    .filter-input,
    .filter-select {
        width: 100%;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid var(--glass-border);
        color: #fff;
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .filter-input:focus,
    .filter-select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px rgba(0, 210, 255, 0.1);
        background: rgba(15, 23, 42, 1);
    }

    /* Dark mode scrollbar for select dropdowns usually requires browser-specific hacks or custom UI, 
       but standardizing the background color helps. */
    .filter-select option {
        background-color: #0f172a;
        color: #fff;
    }

    .search-box {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    /* === Buttons === */
    .btn-glass {
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 600;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        justify-content: center;
    }

    .btn-primary-glass {
        background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(58, 123, 213, 0.3);
    }

    .btn-primary-glass:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(58, 123, 213, 0.4);
        color: white;
    }

    .btn-clear-glass {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-clear-glass:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
    }

    /* === Table === */
    .table-container {
        overflow-x: auto;
        border-radius: var(--card-radius);
        height: calc(100vh - 450px);
        /* Adjust based on your header size */
    }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.95rem;
    }

    .custom-table th {
        background: rgba(30, 41, 59, 0.95);
        /* Keep it solid enough heavily blurred */
        backdrop-filter: blur(20px);
        color: var(--text-secondary);
        font-weight: 600;
        padding: 16px;
        text-align: center;
        border-bottom: 1px solid var(--glass-border);
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
    }

    .custom-table td {
        padding: 14px 16px;
        color: #e2e8f0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        text-align: center;
        vertical-align: middle;
        transition: background 0.2s;
    }

    .custom-table tr:hover td {
        background: rgba(255, 255, 255, 0.05);
    }

    .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* === Badges & Chips === */
    .badge-chip {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 1px solid transparent;
    }

    .chip-a {
        background: rgba(16, 185, 129, 0.15);
        color: #34d399;
        border-color: rgba(16, 185, 129, 0.2);
    }

    .chip-b {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
        border-color: rgba(59, 130, 246, 0.2);
    }

    .chip-c {
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
        border-color: rgba(245, 158, 11, 0.2);
    }

    .chip-d {
        background: rgba(244, 63, 94, 0.15);
        color: #fb7185;
        border-color: rgba(244, 63, 94, 0.2);
    }

    .chip-e {
        background: rgba(139, 92, 246, 0.15);
        color: #a78bfa;
        border-color: rgba(139, 92, 246, 0.2);
    }

    .chip-default {
        background: rgba(148, 163, 184, 0.15);
        color: #cbd5e1;
        border-color: rgba(148, 163, 184, 0.2);
    }

    /* Legend */
    .legend-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        background: rgba(0, 0, 0, 0.2);
        padding: 10px 20px;
        border-radius: 30px;
        justify-content: center;
        margin: 0 auto 20px;
        width: fit-content;
    }

    /* Action Buttons in Table */
    .action-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s;
    }

    .action-view {
        background: rgba(6, 182, 212, 0.15);
        color: #22d3ee;
    }

    .action-view:hover {
        background: #22d3ee;
        color: #fff;
    }

    .action-edit {
        background: rgba(245, 158, 11, 0.15);
        color: #fbbf24;
    }

    .action-edit:hover {
        background: #fbbf24;
        color: #fff;
    }

    /* Pagination */
    .pagination-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
    }

    .page-info {
        color: var(--text-secondary);
        font-weight: bold;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filter-grid {
            grid-template-columns: 1fr;
        }

        .dashboard-header {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
    }
</style>

<div class="dashboard-container">

    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h2>ğŸ‘¥ <span class="gradient-text">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></h2>
            <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØµÙØ­ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </div>
        <div class="date-badge">
            ğŸ“… {{ "now" | date_format_arabic }}
        </div>
        <a href="{{ url_for('userinfo_archived_list') }}"
            style="margin-right: 15px; text-decoration: none; background: rgba(239, 68, 68, 0.1); color: #f87171; padding: 8px 16px; border-radius: 50px; border: 1px solid rgba(239, 68, 68, 0.3); font-weight: bold; font-size: 0.9rem; transition: all 0.2s;"
            onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'"
            onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
            ğŸ“‚ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        </a>
    </div>

    {% if users %}
    <!-- Statistics & Charts Grid -->
    <div class="stats-grid">
        <!-- Text Stat 1 -->
        <div class="glass-stat-card">
            <div class="stat-icon-box" style="color: #60a5fa;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
            <div class="stat-info">
                <h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h5>
                <p id="kpiTotal">0</p>
            </div>
        </div>

        <!-- Text Stat 2 -->
        <div class="glass-stat-card">
            <div class="stat-icon-box" style="color: #f472b6;">âš–ï¸</div>
            <div class="stat-info">
                <h5>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†ÙˆØ¹</h5>
                <p style="font-size: 1rem; margin-top: 5px;">
                    <span style="color: #60a5fa">ğŸ‘¨ <span id="kpiMales">0</span></span>
                    <span style="margin: 0 5px; opacity: 0.3;">|</span>
                    <span style="color: #f472b6">ğŸ‘© <span id="kpiFemales">0</span></span>
                </p>
            </div>
        </div>

        <!-- Chart 1: Classes -->
        <div class="glass-stat-card"
            style="justify-content: center; flex-direction: column; text-align: center; gap: 5px;">
            <h5 style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</h5>
            <div style="height: 160px; width: 100%;">
                <canvas id="classChart"></canvas>
            </div>
        </div>

        <!-- Chart 2: Departments -->
        <div class="glass-stat-card"
            style="justify-content: center; flex-direction: column; text-align: center; gap: 5px;">
            <h5 style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">Ø£ÙƒØ¨Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
            <div style="height: 160px; width: 100%;">
                <canvas id="deptChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Legend -->
    <!-- Legend -->
    <div class="legend-bar">
        {% for cls in classes %}
        {% set chip_class = 'chip-default' %}
        {% if cls.ClassName == 'A' %}{% set chip_class = 'chip-a' %}
        {% elif cls.ClassName == 'B' %}{% set chip_class = 'chip-b' %}
        {% elif cls.ClassName == 'C' %}{% set chip_class = 'chip-e' %}
        {% elif cls.ClassName == 'Ù…Ø´Ø±Ù' %}{% set chip_class = 'chip-c' %}
        {% elif cls.ClassName == 'Ù…Ø¯ÙŠØ±' %}{% set chip_class = 'chip-d' %}
        {% endif %}
        <span class="badge-chip {{ chip_class }}">{{ cls.DisplayName }}</span>
        {% endfor %}
    </div>

    <!-- Filters & Table Panel -->
    <div class="glass-panel">

        <!-- Filter Form -->
        <form id="filtersForm" method="GET" action="{{ url_for('userinfo_list') }}" style="margin-bottom: 25px;">
            <div class="search-box">
                <input type="text" name="search" class="filter-input" style="flex: 1;"
                    placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ..."
                    value="{{ request.args.get('search', '') }}">
                <button type="submit" class="btn-glass btn-primary-glass">Ø¨Ø­Ø«</button>
            </div>

            <div class="filter-grid">
                <div>
                    <label class="filter-label">ÙØ¦Ø© Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <select name="employee_class" class="filter-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        {% for cls in classes %}
                        <option value="{{ cls.ClassName }}" {% if request.args.get('employee_class')==cls.ClassName
                            %}selected{% endif %}>
                            {{ cls.DisplayName }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="filter-label">Ø§Ù„Ù†ÙˆØ¹</label>
                    <select name="gender" class="filter-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        <option value="M" {% if request.args.get('gender')=='M' %}selected{% endif %}>Ø°ÙƒØ±</option>
                        <option value="F" {% if request.args.get('gender')=='F' %}selected{% endif %}>Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>

                <div>
                    <label class="filter-label">Ø§Ù„Ù‚Ø³Ù…</label>
                    <select name="department" class="filter-select">
                        <option value="">Ø§Ù„ÙƒÙ„</option>
                        {% for dept in departments %}
                        <option value="{{ dept.DEPTID }}" {% if request.args.get('department')==dept.DEPTID|string
                            %}selected{% endif %}>
                            {{ dept.DEPTNAME }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="filter-label">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                    <input type="text" name="title" class="filter-input" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‡Ù†Ø¯Ø³"
                        value="{{ request.args.get('title', '') }}">
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-glass btn-primary-glass" style="flex: 1;">ØªØ·Ø¨ÙŠÙ‚</button>
                    <button type="button" onclick="clearFilters()" class="btn-glass btn-clear-glass">Ù…Ø³Ø­</button>
                </div>
            </div>

            <!-- Hidden Params -->
            <input type="hidden" name="sort" id="sortField" value="{{ request.args.get('sort', 'USERID') }}">
            <input type="hidden" name="order" id="sortOrder" value="{{ request.args.get('order', 'asc') }}">
            <input type="hidden" name="page" id="pageInput" value="{{ current_page|default(1) }}">
        </form>

        <!-- Results Info -->
        <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
            Ø¹Ø±Ø¶ <span style="color: #fff; font-weight: bold;">{{ users|length }}</span> Ù…ÙˆØ¸Ù
            {% if request.args.get('search') or request.args.get('employee_class') or request.args.get('gender') or
            request.args.get('department') %}
            <span style="color: var(--accent-cyan);">(Ù†ØªØ§Ø¦Ø¬ ØªØµÙÙŠØ©)</span>
            {% endif %}
        </div>

        <!-- Table -->
        <div class="table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('USERID')" style="cursor: pointer;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†•</th>
                        <th onclick="sortTable('BADGENUMBER')" style="cursor: pointer;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ â†•</th>
                        <th onclick="sortTable('SSN')" style="cursor: pointer;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ â†•</th>
                        <th onclick="sortTable('NAME')" style="cursor: pointer;">Ø§Ù„Ø§Ø³Ù… â†•</th>
                        <th onclick="sortTable('employee_class')" style="cursor: pointer;">Ø§Ù„ÙØ¦Ø© â†•</th>
                        <th onclick="sortTable('HIREDDAY')" style="cursor: pointer;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† â†•</th>
                        <th onclick="sortTable('GENDER')" style="cursor: pointer;">Ø§Ù„Ù†ÙˆØ¹ â†•</th>
                        <th onclick="sortTable('DEFAULTDEPTID')" style="cursor: pointer;">Ø§Ù„Ù‚Ø³Ù… â†•</th>
                        <th onclick="sortTable('TITLE')" style="cursor: pointer;">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ â†•</th>
                        <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                        <th style="min-width: 100px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>{{ u.USERID }}</td>
                        <td style="font-family: monospace; color: var(--accent-cyan);">{{ u.BADGENUMBER }}</td>
                        <td>{{ u.SSN }}</td>
                        <td style="font-weight: bold; color: #fff;">{{ u.NAME }}</td>

                        <!-- Dynamic Badges -->
                        <td>
                            {% set classes = u.employee_class.split(',') if u.employee_class else [] %}
                            {% if not classes or classes == ['Ù„Ù… ØªØ¶Ø§Ù'] %}
                            <span class="badge-chip chip-default">-</span>
                            {% else %}
                            {% for cls in classes %}
                            {% if cls == 'A' %} <span class="badge-chip chip-a">A</span>
                            {% elif cls == 'B' %} <span class="badge-chip chip-b">B</span>
                            {% elif cls == 'C' %} <span class="badge-chip chip-e">C</span>
                            {% elif cls == 'Ù…Ø´Ø±Ù' %} <span class="badge-chip chip-c">Ù…Ø´Ø±Ù</span>
                            {% elif cls == 'Ù…Ø¯ÙŠØ±' %} <span class="badge-chip chip-d">Ù…Ø¯ÙŠØ±</span>
                            {% else %} <span class="badge-chip chip-default">{{ cls }}</span>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </td>

                        <td>{{ u.HIREDDAY.strftime('%Y-%m-%d') if u.HIREDDAY else '-' }}</td>

                        <td>
                            {% set g = u.GENDER.strip() if u.GENDER else '' %}
                            {% if g in ['M', 'Ø°ÙƒØ±', 'Male'] %} ğŸ‘¨ Ø°ÙƒØ±
                            {% elif g in ['F', 'Ø§Ù†Ø«Ù‰', 'Ø£Ù†Ø«Ù‰', 'Female'] %} ğŸ‘© Ø£Ù†Ø«Ù‰
                            {% else %} {{ u.GENDER or '-' }}
                            {% endif %}
                        </td>

                        <td>{{ u.DEPTNAME or '-' }}</td>
                        <td>{{ u.TITLE or '-' }}</td>

                        <td>
                            <img src="{{ url_for('user_pic', user_id=u.USERID) }}" class="user-avatar" alt="pic"
                                onerror="this.src='https://via.placeholder.com/35?text=U'">
                        </td>

                        <td>
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <!--<a href="{{ url_for('userinfo_view', uid=u.USERID) }}" class="action-btn action-view" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">ğŸ‘ï¸</a>-->
                                {% if is_admin %}
                                <a href="{{ url_for('userinfo_edit', uid=u.USERID) }}" class="action-btn action-edit"
                                    title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</a>

                                <button type="button" class="action-btn"
                                    style="background: rgba(239, 68, 68, 0.15); color: #f87171; border: none; cursor: pointer;"
                                    title="Ø£Ø±Ø´ÙØ©"
                                    onclick="openArchiveModal('{{ u.USERID }}', '{{ u.NAME }}', '{{ u.BADGENUMBER }}')">
                                    ğŸ“‚
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            ğŸ˜• Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø·Ø§Ø¨Ù‚ÙˆÙ† Ù„Ù„Ø¨Ø­Ø«
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-wrapper">
            <button type="button" class="btn-glass btn-primary-glass"
                onclick="changePage({{ current_page|default(1) - 1 }})" {% if current_page|default(1) <=1 %}disabled
                style="opacity: 0.5; cursor: not-allowed; filter: grayscale(1);" {% endif %}>
                â–¶ Ø§Ù„Ø³Ø§Ø¨Ù‚
            </button>
            <span class="page-info">
                ØµÙØ­Ø© {{ current_page|default(1) }} Ù…Ù† {{ total_pages|default(1) }}
            </span>
            <button type="button" class="btn-glass btn-primary-glass"
                onclick="changePage({{ current_page|default(1) + 1 }})" {% if current_page|default(1)>=
                total_pages|default(1) %}disabled style="opacity: 0.5; cursor: not-allowed; filter: grayscale(1);"{%
                endif %}>
                Ø§Ù„ØªØ§Ù„ÙŠ â—€
            </button>
        </div>

    </div>

    <div style="text-align: center; margin-top: 30px; color: rgba(255,255,255,0.3); font-size: 0.8rem;">
        Â© 2025 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© - ØªØµÙ…ÙŠÙ… Glassmorphism
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Sticky Filters Logic ===
        const filterKey = 'userinfoFilters';
        if (!window.location.search && localStorage.getItem(filterKey)) {
            window.location.search = localStorage.getItem(filterKey);
            return;
        }
        if (window.location.search) {
            localStorage.setItem(filterKey, window.location.search);
        }

        // === Dark Mode Chart Settings ===
        if (typeof Chart !== 'undefined') {
            Chart.defaults.font.family = "'Cairo', sans-serif";
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.scale.grid.color = 'rgba(255, 255, 255, 0.05)';
        }

        // === Fast Analytics (Server-Side Data) ===
        const stats = {{ analytics | tojson
    }};

    // Update Text Stats
    if (document.getElementById('kpiTotal')) document.getElementById('kpiTotal').innerText = stats.total;
    if (document.getElementById('kpiMales')) document.getElementById('kpiMales').innerText = stats.males;
    if (document.getElementById('kpiFemales')) document.getElementById('kpiFemales').innerText = stats.females;

    if (stats.total > 0) {
        // Render Class Chart
        if (document.getElementById('classChart')) {
            const classLabels = Object.keys(stats.classes);
            const classData = Object.values(stats.classes);

            // Map colors based on label (matching chips)
            const colorMap = {
                'A': '#fbbf24', // Gold
                'B': '#94a3b8', // Silver
                'C': '#c084fc', // Purple/Pinkish
                'Ù…Ø´Ø±Ù': '#3b82f6', // Blue
                'Ù…Ø¯ÙŠØ±': '#f43f5e'  // Red
            };
            const bgColors = classLabels.map(l => colorMap[l] || '#10b981'); // Default Emerald

            new Chart(document.getElementById('classChart'), {
                type: 'doughnut',
                data: {
                    labels: classLabels,
                    datasets: [{
                        data: classData,
                        backgroundColor: bgColors,
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                color: '#94a3b8',
                                font: { size: 11, family: "'Cairo', sans-serif" },
                                boxWidth: 12
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return ' ' + context.label + ': ' + context.parsed + ' Ù…ÙˆØ¸Ù';
                                }
                            }
                        }
                    },
                    cutout: '55%',
                    layout: { padding: 10 },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const index = activeEls[0].index;
                            const label = classLabels[index];

                            // Apply Filter
                            const select = document.querySelector('select[name="employee_class"]');
                            if (select) {
                                for (let i = 0; i < select.options.length; i++) {
                                    // Match exact value or text
                                    if (select.options[i].value === label) {
                                        select.selectedIndex = i;
                                        break;
                                    }
                                }
                                document.getElementById('pageInput').value = 1;
                                document.getElementById('filtersForm').submit();
                            }
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        // Render Dept Chart
        if (document.getElementById('deptChart')) {
            const deptLabels = Object.keys(stats.depts);

            new Chart(document.getElementById('deptChart'), {
                type: 'bar',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                        data: Object.values(stats.depts),
                        backgroundColor: '#38bdf8',
                        hoverBackgroundColor: '#0ea5e9',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return ' ' + context.parsed.y + ' Ù…ÙˆØ¸Ù';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 9 },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { display: false }
                        },
                        y: { display: false }
                    },
                    layout: { padding: 10 },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const index = activeEls[0].index;
                            const label = deptLabels[index]; // Dept Name

                            // Apply Filter by matching Option Text
                            const select = document.querySelector('select[name="department"]');
                            if (select) {
                                let found = false;
                                for (let i = 0; i < select.options.length; i++) {
                                    // fuzzy match or exact? The chart label comes from DB `D.DEPTNAME` which matches `DEPTNAME` in select.
                                    if (select.options[i].text.trim() === label.trim()) {
                                        select.selectedIndex = i;
                                        found = true;
                                        break;
                                    }
                                }
                                if (found) {
                                    document.getElementById('pageInput').value = 1;
                                    document.getElementById('filtersForm').submit();
                                }
                            }
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }
    }
    });

    // === Filter & Sort Logic (Preserved) ===
    function sortTable(field) {
        let sortInput = document.getElementById('sortField');
        if (!sortInput) return;

        const currentSort = sortInput.value;
        const currentOrder = document.getElementById('sortOrder').value;
        let newOrder = 'asc';

        if (currentSort === field) {
            newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        }

        sortInput.value = field;
        document.getElementById('sortOrder').value = newOrder;
        document.getElementById('pageInput').value = 1;
        document.getElementById('filtersForm').submit();
    }

    function clearFilters() {
        localStorage.removeItem('userinfoFilters');
        document.getElementById('pageInput').value = 1;
        const form = document.getElementById('filtersForm');
        form.querySelectorAll('input, select').forEach(input => {
            if (input.type !== 'hidden' || (input.name !== 'sort' && input.name !== 'order' && input.name !== 'page')) {
                if (input.type === 'text' || input.type === 'search') input.value = '';
                else if (input.type === 'select-one') input.selectedIndex = 0;
            }
        });
        if (document.getElementById('sortField')) document.getElementById('sortField').value = 'USERID';
        document.getElementById('sortOrder').value = 'asc';
        form.submit();
    }

    document.querySelectorAll('.filter-select').forEach(select => {
        select.addEventListener('change', () => {
            document.getElementById('pageInput').value = 1;
            document.getElementById('filtersForm').submit();
        });
    });

    function changePage(page) {
        if (page < 1) return;
        document.getElementById('pageInput').value = page;
        document.getElementById('filtersForm').submit();
    }
</script>

<!-- Archive Modal -->
<div id="archiveModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; align-items: center; justify-content: center;">
    <div class="glass-panel"
        style="width: 450px; max-width: 90%; background: #0f172a; border: 1px solid rgba(255,255,255,0.1); padding: 30px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: 100px auto;">

        <h3 style="color:white; margin-top:0;">ğŸ›‘ Ø£Ø±Ø´ÙØ© Ù…ÙˆØ¸Ù</h3>
        <p style="color:#94a3b8; margin-bottom: 20px;">Ø³ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØºÙŠÙŠØ± Ø±Ù‚Ù…Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ø¥ØªØ§Ø­ØªÙ‡.</p>

        <div
            style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(239, 68, 68, 0.2);">
            <h5 id="archiveUserName" style="color: #f87171; margin:0; font-size:1.1rem; text-align:center;"></h5>
        </div>

        <form id="archiveForm" method="POST">
            <div style="margin-bottom: 15px;">
                <label class="filter-label" style="display:block; margin-bottom:8px; color:#cbd5e1;">Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø±Ø´ÙØ© <span
                        style="color:red">*</span></label>
                <select name="reason_id" class="filter-input" style="width:100%;" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ --</option>
                    {% for r in archive_reasons %}
                    <option value="{{ r.ReasonID }}">{{ r.TypeText }} - {{ r.ReasonText }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 25px;">
                <label class="filter-label" style="display:block; margin-bottom:8px; color:#cbd5e1;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                    Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <textarea name="note" class="filter-input" rows="3" style="width:100%;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn-glass btn-primary-glass"
                    style="flex:1; background: linear-gradient(135deg, #ef4444, #b91c1c);">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø±Ø´ÙØ©</button>
                <button type="button" class="btn-glass btn-reset-glass" style="flex:1;"
                    onclick="closeArchiveModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openArchiveModal(uid, name, badge) {
        document.getElementById('archiveUserName').innerText = name + ' (' + badge + ')';
        // Construct action URL: /userinfo/archive/123
        const fakeUrl = "{{ url_for('userinfo_archive', uid=0) }}";
        document.getElementById('archiveForm').action = fakeUrl.replace('/0', '/' + uid);

        document.getElementById('archiveModal').style.display = 'flex'; // Flex to center
    }

    function closeArchiveModal() {
        document.getElementById('archiveModal').style.display = 'none';
    }

    // Close on click outside
    document.getElementById('archiveModal').addEventListener('click', function (e) {
        if (e.target === this) closeArchiveModal();
    });
</script>

{% endblock %}