{% extends "layout.html" %}
{% block title %}ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯{% endblock %}

{% block content %}
<style>
  body {
      direction: rtl;
      font-family: "Cairo", "Tahoma", sans-serif;
      background-color: #f7f9fb;
  }

  .container {
      max-width: 900px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 25px 30px;
      margin-top: 40px;
  }

  h2 {
      color: #004b8d;
      text-align: center;
      font-weight: 800;
      margin-bottom: 25px;
  }

  .section-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: #004b8d;
      border-right: 4px solid #004b8d;
      padding-right: 8px;
      margin-bottom: 12px;
  }

  .employee-info {
      background: #f1f4f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
  }

  .employee-info div {
      margin-bottom: 8px;
      font-size: 0.95rem;
  }

  /* --- NEW: Style for the live percentage display --- */
  .percentage-display {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      color: #004b8d;
      margin-bottom: 20px;
      background: #f1f4f9;
      padding: 10px;
      border-radius: 8px;
  }
  .percentage-display span {
      color: #007b5e;
      font-size: 1.75rem;
  }
  /* --- End New Style --- */

  label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
  }

  select, textarea, input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
  }
  
  /* Style for disabled options */
  select option[disabled] {
      background: #eee;
      color: #999;
  }

  /* Modified to be specific to the evaluation table so it doesn't break the new training table */
  table.eval-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.95rem;
  }

  table.eval-table th, table.eval-table td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      text-align: center;
  }

  table.eval-table thead {
      background: #004b8d;
      color: #fff;
  }

  table.eval-table tbody tr:nth-child(even) {
      background: #f9fbfd;
  }

  table.eval-table tbody tr:hover {
      background: #eef3f9;
  }

  .btn {
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s ease;
  }

  .btn-success {
      background-color: #007b5e;
      color: #fff;
  }

  .btn-success:hover {
      background-color: #00684f;
  }

  .btn-secondary {
      background-color: #adb5bd;
      color: #fff;
  }

  .btn-secondary:hover {
      background-color: #868e96;
  }

  .invalid-feedback {
      color: #d93025;
      font-size: 0.85rem;
  }
  
  /* Style for invalid input */
    input.is-invalid {
        border-color: #d93025;
        background-color: #fbebee;
    }

  @media (max-width: 768px) {
      .container {
          padding: 20px;
      }

      table.eval-table th, table.eval-table td {
          font-size: 0.85rem;
          padding: 6px;
      }
  }
</style>

<div class="container">
  <h2>ğŸ“‹ Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø£Ø¯Ø§Ø¡</h2>

  <div class="employee-info">
    <div><strong>ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…:</strong> {{ employee.NAME }}</div>
    <div><strong>ğŸ¢ Ø§Ù„Ù‚Ø³Ù…:</strong> {{ employee.DEPTNAME or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
    <div><strong>ğŸ’¼ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</strong> {{ employee.TITLE or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' }}</div>
  </div>

  <div class="percentage-display">
    Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="live_percentage">0.00%</span>
  </div>

  <form method="POST" id="evaluationForm">
    <div class="form-section">
      <div class="mb-4">
        <label for="evaluation_type_id" class="fw-bold">ğŸ”¹ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</label>
        
        <select name="evaluation_type_id" id="evaluation_type_id" required>
          <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… --</option>
          
          {% for eval in available_evals %}
          <option value="{{ eval.id }}" {% if eval.disabled %}disabled{% endif %}>
            {{ eval.name }} {{ eval.note }}
          </option>
          {% endfor %}
          
        </select>
      </div>

      <div class="card mb-4 shadow-sm border-0">
        <div class="card-header text-white" style="background-color: #17a2b8;">
            <h5 class="mb-0" style="font-size: 1rem;"><i class="fa-solid fa-graduation-cap"></i> Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Øª (Training History)</h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0 text-center" style="font-size: 0.9rem;">
                <thead class="bg-light text-dark">
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                        <th>Ø§Ù„Ø­Ø¶ÙˆØ± (%)</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% if training_history %}
                        {% for t in training_history %}
                        <tr>
                            <td class="fw-bold">{{ t.CourseName }}</td>
                            <td>{{ t.StartDate.strftime('%Y-%m-%d') if t.StartDate else '-' }}</td>
                            <td>{{ t.Trainers or 'Multiple/Unknown' }}</td>
                            <td>
                                {% if t.TotalSessions > 0 %}
                                    {% set pct = (t.SessionsAttended / t.TotalSessions * 100)|round|int %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-{{ 'success' if pct >= 80 else 'warning' }}" 
                                             style="width: {{ pct }}%">{{ pct }}%</div>
                                    </div>
                                {% else %}
                                    <span class="badge bg-secondary">No Sessions</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if t.Status == 'Completed' else 'primary' }}">
                                    {{ t.Status }}
                                </span>
                            </td>
                            <td class="text-muted small">{{ t.TrainerNotes or '-' }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-muted py-3">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªØ¯Ø±ÙŠØ¨ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
      </div>
      <div class="section-title">Ø¨Ù†ÙˆØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
      <table class="eval-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ø¨Ù†Ø¯</th>
            <th>Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù†Ø³Ø¨ÙŠ</th>
            <th>Ø§Ù„Ø¯Ø±Ø¬Ø© (Ù…Ù† {{ criteria[0].MaxScore if criteria else '' }})</th>
          </tr>
        </thead>
        <tbody>
          {% for c in criteria %}
          <tr>
            <td>{{ c.CriteriaName }}</td>
            <td>{{ "%.0f%%"|format(c.CriteriaWeight * 100) }}</td>
            <td>
              <input type="number" name="score_{{ c.CriteriaID }}" class="score-input"
                     min="0" max="{{ c.MaxScore }}" required
                     data-max="{{ c.MaxScore }}"
                     data-weight="{{ c.CriteriaWeight }}"
                     placeholder="0 - {{ c.MaxScore }}">
              <div class="invalid-feedback"></div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="mb-3 mt-3">
        <label for="recommendation_id">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <select name="recommendation_id" id="recommendation_id">
          <option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆØµÙŠØ© --</option>
          {% for r in recommendations %}
          <option value="{{ r.RecommendationID }}">{{ r.RecommendationText }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3 mt-3">
        <label for="training_course_id">ğŸ“ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
        <select name="training_course_id" id="training_course_id" class="form-select">
          <option value="">-- Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø© --</option>
          {% for course in training_courses %}
          <option value="{{ course.TrainingCourseID }}">{{ course.TrainingCourseText }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-3 mt-3">
        <label for="comments">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:</label>
        <textarea name="comments" id="comments" rows="4" placeholder="Ø£Ø¶Ù Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      </div>

      <div class="d-flex justify-content-between" style="margin-top: 25px;">
        <a href="{{ url_for('select_user_for_evaluation') }}" class="btn btn-secondary">ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</a>
        <button type="submit" class="btn btn-success">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('evaluationForm');
    const scoreInputs = form.querySelectorAll('.score-input');
    const percentageDisplay = document.getElementById('live_percentage');

    // --- 1. Function to Calculate Live Percentage ---
    function calculateLivePercentage() {
        let totalWeightedScore = 0.0;
        let totalMaxWeight = 0.0;

        scoreInputs.forEach(input => {
            const weight = parseFloat(input.dataset.weight);
            const maxScore = parseInt(input.dataset.max);
            let scoreGiven = parseInt(input.value);
            
            // If score is invalid or empty, treat it as 0
            if (isNaN(scoreGiven) || scoreGiven < 0) {
                scoreGiven = 0;
            }
            // If score is higher than max, cap it at max
            if (scoreGiven > maxScore) {
                scoreGiven = maxScore;
            }

            if (!isNaN(weight) && !isNaN(maxScore) && maxScore > 0) {
                totalMaxWeight += weight;
                totalWeightedScore += (scoreGiven / maxScore) * weight;
            }
        });

        let finalPercentage = 0.0;
        if (totalMaxWeight > 0) {
            // This calculation mirrors the logic in app.py
            finalPercentage = (totalWeightedScore / totalMaxWeight) * 100;
        }

        percentageDisplay.textContent = finalPercentage.toFixed(2) + '%';
    }

    // --- 2. Add 'input' event listener to every score input ---
    // This runs the calculation every time you type a number
    scoreInputs.forEach(input => {
        input.addEventListener('input', calculateLivePercentage);
    });

    // --- 3. Validation Logic (from your original file) ---
    // This runs only when you click "Submit"
    form.addEventListener('submit', function(event) {
        let valid = true;

        // Check evaluation type
        const evalTypeSelect = document.getElementById('evaluation_type_id');
        if (!evalTypeSelect.value) {
            valid = false;
            evalTypeSelect.style.borderColor = '#d93025';
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….');
            event.preventDefault();
            return;
        } else {
            evalTypeSelect.style.borderColor = '#ccc';
        }

        scoreInputs.forEach(input => {
            const val = parseInt(input.value);
            const max = parseInt(input.dataset.max);
            const feedback = input.nextElementSibling;
            input.classList.remove('is-invalid');
            feedback.textContent = '';

            if (isNaN(val) || val < 0 || val > max) {
                valid = false;
                input.classList.add('is-invalid');
                feedback.textContent = `Ø§Ù„Ø¯Ø±Ø¬Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¨ÙŠÙ† 0 Ùˆ ${max}.`;
            }
        });
        if (!valid) {
            event.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª.');
        }
    });

    // --- 4. Initial calculation on page load ---
    // This sets the percentage to 0.00% when the page first loads
    calculateLivePercentage();
});
</script>
{% endblock %}